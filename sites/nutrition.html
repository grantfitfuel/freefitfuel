<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="style.css?v=26">
  <link rel="icon" type="image/svg+xml" href="img/freefitfuel-logo.svg">

  <!-- jsPDF (load early so it's ready by click time) -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Nutrition page tweaks -->
  <style>
    .wrap{max-width:var(--maxw);margin:0 auto;padding:18px 20px}
    .section{background:var(--glass);border:1px solid var(--stroke);border-radius:14px;margin:12px 0;padding:14px}

    /* Collapsible panels */
    details.collapsible{
      border:1px solid var(--stroke);
      border-radius:14px;
      margin:12px 0;
      background:var(--glass);
      overflow:hidden;
    }
    details.collapsible > summary{
      cursor:pointer;
      font-weight:700;
      padding:14px 16px;
      list-style:none;
    }
    details.collapsible > summary::-webkit-details-marker{ display:none; }
    details.collapsible > summary::after{
      content:"â–¸";
      float:right;
      transition:transform .2s ease;
    }
    details.collapsible[open] > summary::after{ transform:rotate(90deg); }

    /* Drawer content for collapsibles (renamed from .panel to avoid conflict) */
    details.collapsible > .drawer { padding:0 16px 16px 16px; }

    /* Start-empty state: hide recipe cards until a filter is chosen */
    html[data-start-empty] #recipeGrid > * { display:none !important; }
    html[data-start-empty] #clearFiltersBtn { display:none !important; }

    /* Print: expand everything */
    @media print{
      details.collapsible > summary{ display:none; }
      details.collapsible .drawer{ display:block !important; }
      details.collapsible{ border:none; }
    }

    /* Recipe grid */
    #recipeGrid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    #recipeGrid .card{padding:10px 12px;border:1px solid var(--stroke);border-radius:10px;background:var(--glass);display:flex;flex-direction:column;gap:.4rem}
    #recipeGrid .card h3{font-size:1.05rem;margin:0}
    #recipeGrid .card .meta{font-size:.9rem;color:var(--inkdim)}
    #recipeGrid .card .mini-nav{display:flex;flex-wrap:wrap;gap:.3rem}
    #recipeGrid .card .mini-nav .chip{background:var(--glass);border:1px solid var(--stroke);border-radius:999px;padding:.2rem .5rem;font-size:.78rem}
    #recipeGrid .card .btn{font-size:.85rem;padding:.4rem .6rem}
    #recipeGrid .card img, #recipeGrid img.card-img{display:none !important}

    /* Filter chips */
    #filterChips{display:flex;flex-wrap:wrap;gap:.5rem;margin:.75rem 0 1rem}
    #filterChips .chip{background:var(--glass);border:1px solid var(--stroke);color:var(--ink);padding:.45rem .8rem;border-radius:999px;font-size:.92rem;cursor:pointer}
    #filterChips .chip[aria-pressed="true"]{background:var(--accent);color:#111;font-weight:800}

    /* Off-canvas panels (unchanged) */
    .panel{position:fixed;top:0;right:0;height:100%;width:min(420px,100%);background:#0b0f14;color:var(--ink);
      border-left:1px solid var(--stroke);transform:translateX(100%);transition:transform .25s ease;z-index:1000;overflow:auto}
    .panel.open{transform:translateX(0)}
    .panel .panel-header{position:sticky;top:0;background:#0b0f14;border-bottom:1px solid var(--stroke);padding:12px}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .2s;z-index:900}
    .overlay.show{opacity:1;pointer-events:auto}

    /* Dialog modal base */
    dialog.recipe-modal{width:min(900px,96vw);max-height:90vh;border:0;border-radius:12px;padding:0;background:#0b0f14;color:var(--ink);z-index:3000}
    dialog.recipe-modal::backdrop{background:rgba(0,0,0,.5)}
    dialog.recipe-modal.fallback-open{
      position:fixed; top:5vh; left:50%; transform:translateX(-50%);
      width:min(900px,96vw); max-height:90vh; overflow:auto;
      display:block; border:0; border-radius:12px; padding:0; background:#0b0f14; z-index:3000;
    }
    .recipe-modal .modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--stroke)}
    .recipe-modal .modal-body{padding:14px 16px}
    .recipe-modal h2{margin:.2rem 0}
    .recipe-modal .meta{color:var(--inkdim)}
    .recipe-modal .cols{display:grid;gap:12px;grid-template-columns:1fr 2fr}
    @media (max-width:700px){ .recipe-modal .cols{grid-template-columns:1fr} }
    .recipe-modal ul{margin:.4rem 0 .6rem .9rem}
    .recipe-modal .btn-row{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.6rem}

    /* PDF download button */
    .pdf-download { margin: 20px 0; text-align: center; }
    .pdf-download a {
      display: inline-block; padding: 12px 20px; background-color: #FF6A00;
      color: #fff; text-decoration: none; font-weight: bold; border-radius: 6px;
      transition: background 0.2s ease-in-out;
    }
    .pdf-download a:hover { background-color: #e55e00; }

    /* --- Mobile tidy-up just for the calculator (overrides inline styles) --- */
    @media (max-width: 600px){
      #macro-calc .drawer{ padding:12px 12px 16px; }
      #macro-calc .section{ padding:12px; }
      #macro-calc .seg{ display:flex; flex-wrap:wrap; gap:.4rem .5rem; }
      #macro-calc .goal-chip{ margin:0; }
      #macro-calc .grid{ display:grid !important; grid-template-columns:1fr 1fr !important; gap:10px !important; }
      #macro-calc label{ font-size:.95rem; }
      #macro-calc .input, #macro-calc select{ font-size:.95rem; height:38px; padding:8px 10px; }
      #macro-calc #bfWrap, #macro-calc #targetBfWrap{ grid-column:1 / -1; }
      #macro-calc .btns-row{ display:grid !important; grid-template-columns:1fr 1fr; gap:10px !important; align-items:stretch !important; }
      #macro-calc .btns-row #generatePDF{ grid-column:1 / -1; }
      #macro-calc .btn{ padding:.55rem .8rem; font-size:.95rem; }
    }
    @media (max-width: 360px){
      #macro-calc .grid{ grid-template-columns:1fr !important; }
      #macro-calc .btns-row{ grid-template-columns:1fr; }
    }
  </style>

  <title>FreeFitFuel Nutrition â€” Recipes, Macros & Hydration</title>
  <meta name="description" content="Free healthy recipes, macro breakdowns, hydration trackers and meal ideas. Balanced nutrition to fuel strength, weight loss and wellbeing.">
  <meta property="og:title" content="FreeFitFuel Nutrition â€” Recipes, Macros & Hydration">
  <meta property="og:description" content="Budget-friendly recipes with macro tracking and hydration support. Vegetarian & vegan options included.">
  <meta property="og:image" content="https://www.freefitfuel.com/img/nutrition-hero.png">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://www.freefitfuel.com/nutrition.html">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="FreeFitFuel Nutrition â€” Recipes, Macros & Hydration">
  <meta name="twitter:description" content="Nutrition made simple: free recipes, hydration logs & macro breakdowns.">
  <meta name="twitter:image" content="https://www.freefitfuel.com/img/nutrition-hero.png">
</head>
<body>

<!-- Shared header mount -->
<div id="site-header"></div>
<script src="/js/header-loader.js"></script>

<header class="hero-mini" role="banner" aria-label="Nutrition hero">
  <figure>
    <img src="img/nutrition-hero.png" alt="Fresh colourful food ingredients on a table">
    <div class="overlay" aria-hidden="true"></div>
  </figure>
  <div class="content wrap">
    <h1><span class="accent">Fuel That Fits Your Life</span></h1>
    <p>Balanced macros, budget-friendly recipes, Pantry mode, and a simple planner.</p>
    <div class="cta-row">
      <a class="btn" href="#macro-calc">Start Calculator</a>
      <a class="btn" href="pdf/macro-cheatsheet.pdf">Macro Cheat Sheet (PDF)</a>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- CALCULATOR (collapsible) -->
  <details id="macro-calc" class="collapsible" open>
    <summary>Calories & Macros Calculator</summary>
    <div class="drawer">

      <div class="toolbar" aria-label="Goal selector">
        <div class="seg" role="tablist" aria-label="Goal">
          <button role="tab" class="goal-chip" aria-pressed="true"  data-goal="Maintain">Maintain</button>
          <button role="tab" class="goal-chip" aria-pressed="false" data-goal="Cut">Cut</button>
          <button role="tab" class="goal-chip" aria-pressed="false" data-goal="Build/Bulk">Build/Bulk</button>
          <button role="tab" class="goal-chip" aria-pressed="false" data-goal="Transform">Transform (Recomposition)</button>
        </div>
      </div>
      
      <div class="grid">
        <label>Sex
          <select id="bmrSex" class="input"><option value="male">Male</option><option value="female">Female</option></select>
        </label>
        <label>Age (years)
          <input id="bmrAge" class="input" type="number" min="13" max="90" value="30">
        </label>
        <label>Height (cm)
          <input id="bmrHeight" class="input" type="number" min="120" max="220" value="175">
        </label>
        <label>Weight (kg)
          <input id="bmrWeight" class="input" type="number" min="35" max="250" value="75">
        </label>
        <label>Activity
          <select id="bmrActivity" class="input">
            <option value="1.2">Sedentary (x1.2)</option>
            <option value="1.375">Light (x1.375)</option>
            <option value="1.55" selected>Moderate (x1.55)</option>
            <option value="1.725">Very active (x1.725)</option>
            <option value="1.9">Athlete (x1.9)</option>
          </select>
        </label>

        <!-- Katchâ€“McArdle toggle + input -->
        <label style="grid-column:1 / -1; display:flex; align-items:center; gap:.5rem;">
          <input type="checkbox" id="useBodyFat"> I know my body fat %
        </label>

        <label id="bfWrap" style="grid-column:1 / -1; display:none;">
          Body Fat % 
          <input id="bodyFat" class="input" type="number" min="1" max="70" step="0.1" style="max-width:140px; margin-left:.5rem">
        </label>

        <!-- Target Body Fat % (optional) -->
        <label id="targetBfWrap" style="grid-column:1 / -1;">
          Target Body Fat %
          <input id="targetBodyFat" class="input" type="number" min="6" max="40" step="0.5" value="10" style="max-width:140px; margin-left:.5rem">
          <span class="meta" style="margin-left:.5rem">Optional â€” used for phase planning & the PDF</span>
        </label>

        <div class="btns-row">
          <button id="calcNow" class="btn">Calculate</button>
          <button id="calcCopy" class="btn">Copy</button>
          <button id="generatePDF" class="btn">Generate My Roadmap (PDF)</button>
        </div>
      </div>

      <div class="section" style="margin-top:.8rem">
        <h3>Your targets</h3>
        <p class="meta" id="goalLine">Goal: <strong>Maintain</strong> â€” based on Mifflinâ€“St Jeor + activity</p>
        <div class="grid" style="grid-template-columns:repeat(4,1fr)">
          <div><strong>Calories</strong><br><span id="outKcal">â€”</span> kcal/day</div>
          <div><strong>Protein</strong><br><span id="outProtein">â€”</span> g/day</div>
          <div><strong>Carbs</strong><br><span id="outCarbs">â€”</span> g/day</div>
          <div><strong>Fat</strong><br><span id="outFat">â€”</span> g/day</div>
        </div>
      </div>

      <div class="pdf-download">
        <a href="/pdf/weight-loss-explained.pdf" target="_blank">ðŸ“„ Download: How Weight Loss Works (PDF)</a>
      </div>

      <div class="pdf-download">
        <a href="/pdf/bulk-cut-maintain-recomp.pdf" target="_blank">ðŸ“„ Download: Bulk, Cut, Maintain and Recomposition Explained (PDF)</a>
      </div>

    </div>
  </details>

  <!-- WEEK SUMMARY (collapsible) -->
  <details id="week-plan" class="collapsible">
    <summary>This Weekâ€™s Plan</summary>
    <div class="drawer">

      <div style="display:flex;justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap">
        <h2 style="margin:0;font-size:1.1rem">Planner Summary</h2>
        <div>
          <button id="weekAutoBtn" class="btn">Auto-plan Week (no duplicates)</button>
          <button id="weekClearBtn" class="btn">Clear Week</button>
        </div>
      </div>

      <p class="meta" style="margin:.4rem 0">Swap any slot to rotate in a different unique recipe. This summary mirrors the planner panel.</p>
      <div id="weekSummaryGrid" class="grid" style="grid-template-columns:repeat(4,1fr)"></div>

    </div>
  </details>

  <!-- TOOLS -->
  <section class="section" aria-label="Recipe tools">
    <div class="grid" style="grid-template-columns:2fr 1fr">
      <div>
        <label for="recipeSearch" class="visually-hidden">Search recipes</label>
        <input id="recipeSearch" class="input" type="search" placeholder="Search recipes, ingredients, tagsâ€¦">
      </div>
      <div style="display:flex;gap:.6rem;justify-content:flex-end;align-items:center;">
        <button id="pantryOpenBtn" class="btn">Pantry</button>
        <button id="openPlannerBtn" class="btn">Open Meal Planner</button>
      </div>
    </div>

    <div id="filterChips" role="toolbar" aria-label="Recipe filters">
      <!-- No default selection; ALL is available but not pressed -->
      <button class="chip" data-filter="ALL" aria-pressed="false">ALL</button>
      <!-- JS appends the rest -->
    </div>

    <p id="recipeCount" class="meta" aria-live="polite">Choose a filter to begin</p>
    <button id="exportIndexBtn" class="btn">Export Index</button>
    <button id="clearFiltersBtn" class="btn" style="display:none">Clear filters</button>
  </section>

  <!-- GRID -->
  <section class="section">
    <div id="recipeGrid" class="grid" aria-live="polite" aria-busy="false"></div>
  </section>

  <!-- INFO -->
  <section class="section">
    <div class="grid">
      <article class="card">
        <h3>Macros 101</h3>
        <p>Protein rebuilds muscle; carbs fuel effort; fats support hormones and vitamins.</p>
      </article>
      <article class="card">
        <h3>Hydration</h3>
        <p>Guide: ~30â€“35 ml/kg/day. Add ~500â€“1000 ml around workouts depending on sweat and duration.</p>
        <div class="calc" style="margin-top:.6rem">
          <label>Your weight (kg)
            <input id="hydrWeight" type="number" value="75" class="input" style="max-width:100px">
          </label>
          <button id="hydrCalc" class="btn">Calculate</button>
        </div>
        <p class="meta" id="hydrOut">Daily target: â€” ml</p>
      </article>
    </div>
  </section>

  <section class="section">
    <h2>Important Note</h2>
    <p>The content on FreeFitFuelâ„¢ is for general fitness education only and isnâ€™t a substitute for personalised medical advice. Consult a qualified professional before starting a new programme, especially if you have any health conditions or injuries. Stop any exercise that causes sharp pain, dizziness, chest pain, or unusual shortness of breath.</p>
  </section>
</main>

<!-- FOOTER -->
<footer class="site-footer">
  <div class="container">
    <img src="img/freefitfuel-logo.svg" alt="FreeFitFuel Logo" height="64">
    <p>&copy; 2025 FreeFitFuelâ„¢ Â· All rights reserved.</p>
    <p class="credit">Created by Grant Cameron Anthony</p>
  </div>
</footer>

<!-- Panels & modal shells -->
<aside id="pantryPanel" class="panel" aria-hidden="true"></aside>
<aside id="plannerPanel" class="panel" aria-hidden="true"></aside>

<!-- Keep dialog present; JS fills its contents if empty -->
<dialog id="recipeModal" class="recipe-modal" aria-hidden="true"></dialog>

<div id="printArea" hidden></div>
<div id="overlay" class="overlay"></div>

<!-- Inline scripts (burger + calculators) -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.querySelector('.hamburger');
  const nav = document.querySelector('.main-nav');
  if(btn && nav){
    btn.addEventListener('click', () => {
      const open = btn.classList.toggle('active');
      nav.classList.toggle('open', open);
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
    });
  }

  // ===== Macros calculator (Mifflinâ€“St Jeor default; Katchâ€“McArdle if BF% provided) =====
  const goalChips=[...document.querySelectorAll('.goal-chip')];
  let GOAL='Maintain';
  goalChips.forEach(b=>b.addEventListener('click', ()=>{
    goalChips.forEach(x=>x.setAttribute('aria-pressed','false'));
    b.setAttribute('aria-pressed','true'); GOAL=b.dataset.goal; update();
  }));

  const sex=document.getElementById('bmrSex'),
        age=document.getElementById('bmrAge'),
        ht =document.getElementById('bmrHeight'),
        wt =document.getElementById('bmrWeight'),
        act=document.getElementById('bmrActivity'),
        useBodyFat=document.getElementById('useBodyFat'),
        bodyFat=document.getElementById('bodyFat'),
        bfWrap=document.getElementById('bfWrap'),
        targetBFInput=document.getElementById('targetBodyFat');

  const outK=document.getElementById('outKcal'),
        outP=document.getElementById('outProtein'),
        outC=document.getElementById('outCarbs'),
        outF=document.getElementById('outFat'),
        goalLine=document.getElementById('goalLine');

  if (useBodyFat) {
    useBodyFat.addEventListener('change', () => {
      bfWrap.style.display = useBodyFat.checked ? 'block' : 'none';
      update();
    });
    if (bodyFat) bodyFat.addEventListener('input', update);
  }
  if (targetBFInput) targetBFInput.addEventListener('input', () => {});

  function calcBMR(s,kg,cm,yrs){
    if (useBodyFat && useBodyFat.checked) {
      const bf = parseFloat(bodyFat?.value || 0);
      if (bf > 0 && bf < 70 && kg > 0) {
        const lbm = kg * (1 - bf/100);
        return 370 + (21.6 * lbm);
      }
    }
    return s==='male' ? 10*kg + 6.25*cm - 5*yrs + 5
                      : 10*kg + 6.25*cm - 5*yrs - 161;
  }

  function targetsFromTDEE(tdee, goal, kg){
    let kcal=tdee;
    if(goal==='Cut') kcal = tdee*0.82;
    if(goal==='Build/Bulk') kcal = tdee*1.15;
    if(goal==='Transform') kcal = tdee*0.97;

    let p_perkg = 1.6;
    if(goal==='Cut') p_perkg = 2.0;
    if(goal==='Build/Bulk') p_perkg = 1.8;
    if(goal==='Transform') p_perkg = 2.2;

    const protein_g = Math.round(p_perkg * kg);
    let carb_pct = 0.50, fat_pct = 0.30;
    if(goal==='Cut'){carb_pct=0.40; fat_pct=0.30;}
    if(goal==='Build/Bulk'){carb_pct=0.55; fat_pct=0.25;}
    if(goal==='Transform'){carb_pct=0.45; fat_pct=0.30;}

    const carbs_g = Math.round((kcal * carb_pct) / 4);
    const fat_g   = Math.round((kcal * fat_pct) / 9);

    return { kcal: Math.round(kcal), protein_g, carbs_g, fat_g };
  }

  function update(){
    const kgv = parseFloat(wt.value||0);
    const bmr = calcBMR(sex.value, kgv, parseFloat(ht.value||0), parseFloat(age.value||0));
    const tdee = bmr * parseFloat(act.value||1);
    const t = targetsFromTDEE(tdee, GOAL, kgv);

    outK.textContent = t.kcal.toString();
    outP.textContent = t.protein_g + ' g';
    outC.textContent = t.carbs_g + ' g';
    outF.textContent = t.fat_g + ' g';

    const methodUsed = (useBodyFat && useBodyFat.checked && parseFloat(bodyFat?.value||0) > 0)
      ? 'Katchâ€“McArdle (uses body fat %)'
      : 'Mifflinâ€“St Jeor';
    goalLine.innerHTML = `Goal: <strong>${GOAL}</strong> â€” based on ${methodUsed} + activity`;
  }

  document.getElementById('calcNow').addEventListener('click', update);
  document.getElementById('calcCopy').addEventListener('click', ()=>{
    const txt = `Goal: ${GOAL}\nCalories: ${outK.textContent} kcal\nProtein: ${outP.textContent}\nCarbs: ${outC.textContent}\nFat: ${outF.textContent}`;
    navigator.clipboard.writeText(txt);
    alert('Copied targets to clipboard.');
  });
  update();

  // ===== Hydration =====
  const hydrBtn = document.getElementById('hydrCalc');
  const hydrOut = document.getElementById('hydrOut');
  const hydrW   = document.getElementById('hydrWeight');
  function calcHydr(){
    const kg = parseFloat(hydrW.value||0);
    if(!kg){ hydrOut.textContent = 'Daily target: â€” ml'; return; }
    const low  = Math.round(kg*30), high = Math.round(kg*35);
    hydrOut.textContent = `Daily target: ${low} â€“ ${high} ml (â‰ˆ ${(low/1000).toFixed(1)} â€“ ${(high/1000).toFixed(1)} L, plus extra if training)`;
  }
  if(hydrBtn) hydrBtn.addEventListener('click', calcHydr);
  if(hydrW)   hydrW.addEventListener('input', calcHydr);
  calcHydr();

  // ===== PDF: Staged logic + programs =====
  const genBtn = document.getElementById('generatePDF');

  function ensureJsPDF() {
    return new Promise((resolve, reject) => {
      if (window.jspdf && window.jspdf.jsPDF) return resolve(true);
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
      s.onload = () => resolve(!!(window.jspdf && window.jspdf.jsPDF));
      s.onerror = () => {
        const l = document.createElement('script');
        l.src = '/assets/js/jspdf.umd.min.js';
        l.onload = () => resolve(!!(window.jspdf && window.jspdf.jsPDF));
        l.onerror = () => reject(new Error('jsPDF failed to load from CDN and local'));
        document.head.appendChild(l);
      };
      document.head.appendChild(s);
    });
  }

  // Helpers for staged plan
  function str(n){ return Number.isFinite(n) ? String(n) : 'â€”'; }
  const sexHighBFDefault = (sx, bf) => {
    // default to staged if BF high enough
    if (!Number.isFinite(bf)) return false;
    if (sx==='male')   return bf >= 30;
    if (sx==='female') return bf >= 38;
    return bf >= 30;
  };

  // Movement guidance from activity (steps or bike/run swap)
  function movementFromActivity(actMult){
    if (actMult <= 1.25) return { steps:'6â€“8k', bike:'20â€“30 min easy', run:'10â€“20 min easy jog/walk' };
    if (actMult <= 1.50) return { steps:'8â€“10k', bike:'25â€“35 min easy', run:'15â€“25 min easyâ€“mod' };
    if (actMult <= 1.75) return { steps:'10â€“12k', bike:'30â€“40 min easyâ€“mod', run:'20â€“30 min mod' };
    return { steps:'12â€“14k', bike:'35â€“45 min mod', run:'25â€“40 min mod' };
  }

  // Stage-specific training menus (no machines; barbell/dumbbell/bands/bodyweight; with no-equipment alts)
  function buildProgramForStage(stage, actMult){
    // volume/rep intent per stage
    const rules = {
      'Cut':        { mainSets:'3â€“4', accSets:'2â€“3', mainReps:'5â€“8',  accReps:'8â€“12', mainRIR:'2â€“3 RIR', accRIR:'2â€“3 RIR', cardio:'2â€“4Ã— LISS 20â€“30 min + 0â€“1Ã— short HIIT' },
      'Transform':  { mainSets:'3â€“4', accSets:'3',   mainReps:'6â€“10', accReps:'8â€“12', mainRIR:'1â€“2 RIR', accRIR:'1â€“2 RIR', cardio:'1â€“3Ã— LISS 20â€“30 min' },
      'Maintain':   { mainSets:'3â€“4', accSets:'2â€“3', mainReps:'6â€“10', accReps:'8â€“12', mainRIR:'1â€“2 RIR', accRIR:'1â€“2 RIR', cardio:'1â€“2Ã— LISS 20â€“25 min' },
      'Lean Bulk':  { mainSets:'4â€“5', accSets:'3â€“5', mainReps:'5â€“10', accReps:'10â€“15',mainRIR:'0â€“2 RIR',  accRIR:'1â€“2 RIR', cardio:'0â€“2Ã— easy LISS 15â€“25 min' }
    };
    const r = rules[stage] || rules.Transform;
    const ex = (name, alt, type='main') => {
      const sets = type==='main' ? r.mainSets : r.accSets;
      const reps = type==='main' ? r.mainReps : r.accReps;
      const rir  = type==='main' ? r.mainRIR  : r.accRIR;
      return `${name} â€” ${sets}Ã—${reps}, ${rir}${alt ? ` (alt: ${alt})` : ''}`;
    };

    // PPL + Core; Wed & Sun are rest (Sun optional LISS). Home-friendly, no machines.
    // Exercises vary per stage: heavier compounds prioritized in Cut; more hypertrophy in Lean Bulk; balanced for Transform; reduced accessory density in Maintain.
    if (stage==='Cut'){
      return [
        { day:'Mon â€” Push', items:[
          ex('Push-ups (weighted if strong)','kneeling push-ups'),
          ex('Dumbbell overhead press','pike push-ups'),
          ex('Incline push-ups','feet-elevated push-ups','acc'),
          ex('Dumbbell floor press','band chest press','acc'),
          'Lateral raise â€” 2â€“3Ã—12â€“20, 1â€“2 RIR (alt: band lateral raise)'
        ]},
        { day:'Tue â€” Pull', items:[
          ex('Pull-ups / Chin-ups','band-assisted pull-ups / inverted rows'),
          ex('One-arm DB row','band row'),
          'Rear-delt fly â€” 2â€“3Ã—12â€“20, 1â€“2 RIR',
          'DB/band curl â€” 2â€“3Ã—8â€“12, 1â€“2 RIR'
        ]},
        { day:'Wed â€” Rest / Optional LISS', items:[ 'Easy LISS or steps/bike/run as per guidance' ]},
        { day:'Thu â€” Legs', items:[
          ex('Back squat or front squat (if barbell)','goblet squat / split squat'),
          ex('Romanian deadlift (bar/DB)','hip hinge with DB/band'),
          'Walking lunges â€” 2â€“3Ã—10â€“14/leg, 1â€“2 RIR',
          'Calf raises â€” 3Ã—10â€“15, 1â€“2 RIR'
        ]},
        { day:'Fri â€” Core & Conditioning', items:[
          'Ab-wheel or plank â€” 3Ã—6â€“12 reps / 30â€“45s, 1â€“2 RIR',
          'Side plank â€” 3Ã—30â€“45s/side',
          'Optional: 10â€“15 min easy circuit (bodyweight)'
        ]},
        { day:'Sat â€” Active Recovery', items:[ 'Walk/bike/run easy; mobility 10â€“15 min' ]},
        { day:'Sun â€” Rest (Optional LISS)', items:[ 'LISS 20â€“30 min if desired' ]},
      ];
    }

    if (stage==='Transform'){
      return [
        { day:'Mon â€” Push', items:[
          ex('Dumbbell bench (floor/bench)','push-ups'),
          ex('Dumbbell overhead press','pike push-ups'),
          'Dips (bars/chairs) â€” 3â€“4Ã—8â€“12, 1â€“2 RIR (alt: bench dips)',
          'Lateral raise â€” 3â€“4Ã—12â€“20, 1â€“2 RIR',
          'Diamond push-ups â€” 2â€“3Ã—8â€“12, 1â€“2 RIR'
        ]},
        { day:'Tue â€” Pull', items:[
          ex('Pull-ups / Chin-ups','inverted rows / band-assisted'),
          ex('One-arm DB row','band row'),
          'Rear-delt fly â€” 3Ã—12â€“20, 1â€“2 RIR',
          'DB/band curl â€” 3Ã—8â€“12, 0â€“2 RIR'
        ]},
        { day:'Wed â€” Rest / Optional LISS', items:[ 'Easy LISS or steps/bike/run as per guidance' ]},
        { day:'Thu â€” Legs', items:[
          ex('Goblet squat (heavy)','split squat / step-ups'),
          ex('Romanian deadlift (DB)','hip hinge with band'),
          'Hip thrust / glute bridge â€” 3Ã—8â€“12, 1â€“2 RIR',
          'Calf raises â€” 3Ã—10â€“15, 1â€“2 RIR'
        ]},
        { day:'Fri â€” Core & Conditioning', items:[
          'Hollow hold â€” 3Ã—20â€“40s',
          'Ab-wheel / KB dead bug â€” 3Ã—6â€“12 / side',
          '10â€“15 min EMOM easy: 1 push, 1 pull, 1 squat pattern'
        ]},
        { day:'Sat â€” Active Recovery', items:[ 'Walk/bike/run easy; mobility 10â€“15 min' ]},
        { day:'Sun â€” Rest (Optional LISS)', items:[ 'LISS 20â€“30 min if desired' ]},
      ];
    }

    if (stage==='Maintain'){
      return [
        { day:'Mon â€” Push', items:[
          ex('Push-ups','DB overhead press'),
          'Incline push-ups â€” 3Ã—10â€“15, 1â€“2 RIR',
          'Lateral raise â€” 2â€“3Ã—12â€“20, 1â€“2 RIR'
        ]},
        { day:'Tue â€” Pull', items:[
          ex('Chin-ups / Pull-ups','inverted rows'),
          'One-arm DB row â€” 3Ã—8â€“12, 1â€“2 RIR',
          'Rear-delt fly â€” 2â€“3Ã—12â€“20, 1â€“2 RIR',
          'DB/band curl â€” 2â€“3Ã—8â€“12, 1â€“2 RIR'
        ]},
        { day:'Wed â€” Rest / Optional LISS', items:[ 'LISS 20â€“25 min; steps/bike/run as guidance' ]},
        { day:'Thu â€” Legs', items:[
          ex('Goblet squat','split squat'),
          'DB RDL â€” 3Ã—8â€“12, 1â€“2 RIR',
          'Hip thrust â€” 2â€“3Ã—8â€“12, 1â€“2 RIR',
          'Calf raises â€” 2â€“3Ã—10â€“15, 1â€“2 RIR'
        ]},
        { day:'Fri â€” Core & Conditioning', items:[
          'Plank â€” 3Ã—30â€“45s',
          'Side plank â€” 3Ã—30â€“45s/side',
          '10 min easy circuit'
        ]},
        { day:'Sat â€” Active Recovery', items:[ 'Walk/bike/run easy; mobility' ]},
        { day:'Sun â€” Rest (Optional LISS)', items:[ 'Optional LISS 20â€“25 min' ]},
      ];
    }

    // Lean Bulk
    return [
      { day:'Mon â€” Push', items:[
        ex('Dumbbell bench (heavy)','push-ups (weighted)'),
        ex('DB overhead press','pike push-ups'),
        'Dips â€” 3â€“4Ã—8â€“12, 0â€“2 RIR',
        'Lateral raise â€” 4Ã—12â€“20, 1â€“2 RIR',
        'Close-grip push-ups â€” 3Ã—8â€“12, 0â€“2 RIR'
      ]},
      { day:'Tue â€” Pull', items:[
        ex('Weighted chin-ups (if able)','chin-ups / band-assist'),
        ex('One-arm DB row (heavy)','band row'),
        'Rear-delt fly â€” 4Ã—12â€“20, 1â€“2 RIR',
        'DB/band curl â€” 4Ã—8â€“12, 0â€“2 RIR'
      ]},
      { day:'Wed â€” Rest / Optional LISS', items:[ 'Very easy LISS 15â€“20 min or full rest' ]},
      { day:'Thu â€” Legs', items:[
        ex('Front squat (if bar) or heavy goblet squat','split squat'),
        ex('DB RDL (heavy)','band RDL'),
        'Hip thrust â€” 4Ã—8â€“12, 1â€“2 RIR',
        'Calf raises â€” 4Ã—10â€“15, 1â€“2 RIR'
      ]},
      { day:'Fri â€” Core & Hypertrophy', items:[
        'Ab-wheel â€” 3â€“10 reps, 1â€“2 RIR',
        'Side plank load â€” 3Ã—20â€“40s/side',
        'Pump finisher (optional): push-ups 2Ã—AMRAP + curls 2Ã—12â€“15'
      ]},
      { day:'Sat â€” Active Recovery', items:[ 'Walk/bike easy; mobility' ]},
      { day:'Sun â€” Rest (Optional LISS)', items:[ 'Optional easy LISS 15â€“20 min' ]},
    ];
  }

  function plannedPhasesStaged(sx, actMult, tdee, kg, currentBF, targetBF){
    // Stages with BF targets and time ranges; calories & macros tailored per stage
    const mk = (name, toBF, weeks, kcal, p, c, f) =>
      ({ title:name, targetToBF:toBF, etaWeeks:weeks, kcal, protein:p, carbs:c, fat:f });

    const cutT   = targetsFromTDEE(tdee, 'Cut',       kg);
    const recomp = targetsFromTDEE(tdee, 'Transform', kg);
    const maint  = targetsFromTDEE(tdee, 'Maintain',  kg);
    const bulk   = targetsFromTDEE(tdee, 'Build/Bulk',kg);

    // Time ranges vary with activity: lower activity â†’ longer
    const slow = actMult <= 1.3;

    const phases = [];
    const startBF = Number.isFinite(currentBF) ? currentBF : null;
    const endBF   = Number.isFinite(targetBF)  ? targetBF  : null;

    // If BF high, suggest Cut -> Transform -> Maintain (-> Lean Bulk optional if user wants)
    if (startBF!=null && (startBF >= (sx==='female'? 34 : 28))) {
      const cutTo   = Math.max(endBF ?? (sx==='female'? 28 : 20), (sx==='female'? 28 : 20));
      const cutWk   = slow ? '12â€“24 weeks' : '8â€“16 weeks';

      const recompTo = Math.max(endBF ?? (sx==='female'? 24 : 18), (sx==='female'? 24 : 18));
      const recWk    = slow ? '8â€“16 weeks' : '6â€“12 weeks';

      const maintWk  = '2â€“4 weeks';

      phases.push(mk('Cut',        cutTo,    cutWk,   cutT.kcal, cutT.protein_g, cutT.carbs_g, cutT.fat_g));
      phases.push(mk('Transform',  recompTo, recWk,   recomp.kcal, recomp.protein_g, recomp.carbs_g, recomp.fat_g));
      phases.push(mk('Maintain',   endBF ?? recompTo, maintWk, maint.kcal, maint.protein_g, maint.carbs_g, maint.fat_g));

      // Optional lean bulk only if user target BF >= current achieved BF and user wants size later (weâ€™ll present but not force)
      if (endBF!=null && endBF > (sx==='female'? 24 : 18)) {
        phases.push(mk('Lean Bulk', endBF, slow ? '8â€“16 weeks' : '6â€“12 weeks', bulk.kcal, bulk.protein_g, bulk.carbs_g, bulk.fat_g));
      }
      return phases;
    }

    // Otherwise, default to Transform -> Maintain (-> optional Lean Bulk)
    const recTo = endBF ?? (sx==='female'? 24 : 18);
    phases.push(mk('Transform', recTo, slow ? '8â€“16 weeks' : '6â€“12 weeks', recomp.kcal, recomp.protein_g, recomp.carbs_g, recomp.fat_g));
    phases.push(mk('Maintain',  recTo, '2â€“4 weeks', maint.kcal, maint.protein_g, maint.carbs_g, maint.fat_g));
    if (endBF!=null && endBF > recTo) {
      phases.push(mk('Lean Bulk', endBF, slow ? '8â€“16 weeks' : '6â€“12 weeks', bulk.kcal, bulk.protein_g, bulk.carbs_g, bulk.fat_g));
    }
    return phases;
  }

  if (genBtn) {
    genBtn.addEventListener('click', async () => {
      if (genBtn.dataset.busy === '1') return;
      genBtn.dataset.busy = '1';
      const oldText = genBtn.textContent;
      genBtn.textContent = 'Generatingâ€¦';
      genBtn.disabled = true;

      const yieldUI = () => new Promise(r => requestAnimationFrame(r));

      try {
        const ok = (window.jspdf && window.jspdf.jsPDF) ? true : await ensureJsPDF();
        if (!ok) { alert('PDF library could not be loaded. Please refresh and try again.'); return; }
        const { jsPDF } = window.jspdf;

        // ==== Gather inputs ====
        const kg  = parseFloat(wt.value||0);
        const cm  = parseFloat(ht.value||0);
        const yrs = parseFloat(age.value||0);
        const sx  = sex.value;
        const actMult = parseFloat(act.value||1);
        const currentBF = (useBodyFat && useBodyFat.checked && parseFloat(bodyFat?.value||0) > 0) ? parseFloat(bodyFat.value) : NaN;
        const targetBF  = parseFloat(targetBFInput?.value || 'NaN');
        const bmr  = calcBMR(sx, kg, cm, yrs);
        const tdee = bmr * actMult;

        // ==== Choose staged or single-stage ====
        const defaultStaged = sexHighBFDefault(sx, currentBF);
        const singleMsg = `OK = generate a single-stage plan for your selected goal: "${GOAL}".\nCancel = generate a staged plan (Cut â†’ Transform â†’ Maintain â†’ optional Lean Bulk).`;
        const userWantsSingle = confirm(singleMsg);
        const useStaged = userWantsSingle ? false : true || defaultStaged; // user override takes priority

        const doc = new jsPDF({ unit:'pt', format:'a4', compress:true });
        const marginX = 56;
        let y = 72;
        const wrapW = 460;

        const line = (yy) => {
          doc.setDrawColor(255,106,0);
          doc.setLineWidth(1);
          doc.line(marginX, yy, 539, yy);
        };
        function addWrapped(text, step=16){
          const lines = doc.splitTextToSize(text, wrapW);
          for (const t of lines){
            if (y > 770) { doc.addPage(); y = 72; }
            doc.text(t, marginX, y); y += step;
          }
        }
        async function sectionBreak(){ y += 6; if (y > 730) { doc.addPage(); y = 72; } await yieldUI(); }

        // ==== Title ====
        doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.setTextColor(255,106,0);
        doc.text('Personalised Body Recomposition Roadmap', marginX, y); y += 18;
        doc.setTextColor(60); doc.setFontSize(12); doc.setFont('helvetica','normal');
        const tbfTxt = Number.isFinite(targetBF) ? `Target: ~${targetBF}% body fat` : `Goal: ${GOAL}`;
        doc.text(tbfTxt, marginX, y);
        y += 12; line(y+8); y += 24;
        await sectionBreak();

        // ==== Baseline ====
        doc.setFont('helvetica','bold'); doc.setFontSize(13); doc.setTextColor(0);
        doc.text('Baseline (Your Starting Point)', marginX, y); y += 16;
        doc.setFont('helvetica','normal'); doc.setFontSize(11);
        [
          `Weight: ${str(kg)} kg`,
          `Height: ${str(cm)} cm`,
          `Age: ${str(yrs)} years`,
          `Sex: ${sx==='male'?'Male':'Female'}`,
          `Body fat: ${Number.isFinite(currentBF)? currentBF+'%' : 'â€”'}`,
          `Target Body Fat: ${Number.isFinite(targetBF)? targetBF+'%' : 'â€”'}`,
          `BMR: ~${Math.round(bmr)} kcal/day`,
          `Estimated TDEE (activity x${actMult}): ~${Math.round(tdee)} kcal/day`,
          `Current Goal chip: ${GOAL}`
        ].forEach(t => addWrapped('â€¢ '+t));
        await sectionBreak();

        // ==== Movement guidance (steps â†” bike/run swap) ====
        const mv = movementFromActivity(actMult);
        doc.setFont('helvetica','bold'); doc.setFontSize(13);
        doc.text('Daily Movement Target', marginX, y); y += 16;
        doc.setFont('helvetica','normal'); doc.setFontSize(11);
        addWrapped(`Aim for ~${mv.steps} steps/day or swap for cardio: bike ${mv.bike} OR run ${mv.run} at easyâ€“moderate effort. More daily movement = more calories burned.`); 
        await sectionBreak();

        // ==== Glossary ====
        doc.setFont('helvetica','bold'); doc.setFontSize(13);
        doc.text('Training Glossary', marginX, y); y += 16;
        doc.setFont('helvetica','normal'); doc.setFontSize(11);
        addWrapped('â€¢ RIR = Reps In Reserve: how many reps left before failure (2 RIR = stop when ~2 reps possible).');
        addWrapped('â€¢ LISS = Low-Intensity Steady State cardio (easy effort you can hold a conversation).');
        addWrapped('â€¢ Form tip: for any exercise, search YouTube: "<exercise name> form".'); 
        await sectionBreak();

        // ==== Decide phases ====
        const kgv = kg;
        let phasesOut = [];
        if (useStaged){
          phasesOut = plannedPhasesStaged(sx, actMult, tdee, kgv, currentBF, targetBF);
        } else {
          // Single-stage using current GOAL, but still honour user target BF line on header
          const tt = targetsFromTDEE(tdee, GOAL, kgv);
          phasesOut = [{
            title: GOAL,
            targetToBF: Number.isFinite(targetBF) ? targetBF : (Number.isFinite(currentBF)? currentBF : 'â€”'),
            etaWeeks: (GOAL==='Cut' ? '6â€“16 weeks' : GOAL==='Transform' ? '6â€“12 weeks' : GOAL==='Maintain' ? '2â€“4 weeks' : '6â€“12 weeks'),
            kcal: tt.kcal, protein: tt.protein_g, carbs: tt.carbs_g, fat: tt.fat_g
          }];
        }

        // Ensure final stage target equals userâ€™s requested end target if provided
        if (Number.isFinite(targetBF) && phasesOut.length){
          phasesOut[phasesOut.length-1].targetToBF = targetBF;
        }

        // ==== Render each stage ====
        for (const ph of phasesOut){
          doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.setTextColor(0);
          doc.text(`${ph.title} Stage`, marginX, y); y += 16;
          doc.setFont('helvetica','normal'); doc.setFontSize(11);
          addWrapped(`Designed to move you toward ~${ph.targetToBF}% body fat. Estimated duration: ${ph.etaWeeks} (with consistent training, nutrition, and sleep).`);

          // Macros
          addWrapped(`â€¢ Calories: ~${ph.kcal} kcal/day â€¢ Protein: ${ph.protein} g/day â€¢ Carbs: ${ph.carbs} g/day â€¢ Fat: ${ph.fat} g/day`);
          await sectionBreak();

          // Training blueprint for this stage
          doc.setFont('helvetica','bold'); doc.setFontSize(13);
          doc.text('Weekly Training (Push / Pull / Legs / Core+Conditioning)', marginX, y); y += 16;
          doc.setFont('helvetica','normal'); doc.setFontSize(11);
          const program = buildProgramForStage(ph.title, actMult);

          for (const day of program){
            // Day header
            doc.setFont('helvetica','bold');
            let lines = doc.splitTextToSize(day.day, wrapW);
            for (const ln of lines){ if (y > 770){ doc.addPage(); y=72; } doc.text(ln, marginX, y); y += 16; }
            doc.setFont('helvetica','normal');
            // Items
            for (const item of day.items){
              lines = doc.splitTextToSize('â€¢ ' + item, wrapW);
              for (const ln of lines){ if (y > 770){ doc.addPage(); y=72; } doc.text(ln, marginX, y); y += 16; }
            }
            y += 6;
            if (y > 770){ doc.addPage(); y=72; }
          }
          await sectionBreak();

          // Progression notes
          doc.setFont('helvetica','bold'); doc.setFontSize(13);
          doc.text('Progression & Notes', marginX, y); y += 16;
          doc.setFont('helvetica','normal'); doc.setFontSize(11);
          const progNotes = {
            'Cut': [
              'Prioritise strength retention: add load when top reps hit at prescribed RIR; otherwise add 1 rep/set.',
              'If fatigue high or performance dips â‰¥2 sessions, remove 1 accessory set.',
              'Deload every 6â€“8 weeks (halve accessory volume, keep RIR â‰¥3).'
            ],
            'Transform': [
              'Progress either load or reps each week while holding RIR.',
              'Rotate one accessory every 4â€“6 weeks to keep stimulus fresh.',
              'Deload every 6â€“8 weeks if joints feel beat up.'
            ],
            'Maintain': [
              'Keep performance steady; small increases when comfortable.',
              'Hold volume and focus on perfect technique.',
              'Short deload if life stress/sleep dips.'
            ],
            'Lean Bulk': [
              'Aim to add reps or load weekly at listed RIR. When top reps achieved 2 weeks, increase load next week.',
              'Extra set on one lagging lift can be added if recovery is good.',
              'Keep LISS very easy and short so it doesnâ€™t cap volume.'
            ]
          }[ph.title] || [];
          progNotes.forEach(t => addWrapped('â€¢ ' + t));
          await sectionBreak();

          // Divider between stages
          y += 4; if (y > 750) { doc.addPage(); y = 72; }
          line(y+6); y += 18;
        }

        // ==== Nutrition Tips ====
        doc.setFont('helvetica','bold'); doc.setFontSize(13); doc.text('Nutrition Tips', marginX, y); y += 16;
        [
          'Spread protein across 4â€“5 meals/snacks (25â€“45 g each).',
          'High-protein staples: chicken, turkey, fish, eggs, Greek yogurt, whey/vegan protein, beans, lentils.',
          'Whole-food carbs: oats, rice, potatoes, fruit, veg. Healthy fats: olive oil, nuts, avocado, oily fish.',
          'Limit alcohol â€” it slows fat loss and recovery.',
          'Consistency beats intensity: hit calories, protein, steps, and sleep.'
        ].forEach(t=>addWrapped('â€¢ '+t));
        await sectionBreak();

        // ==== Recovery ====
        doc.addPage(); y = 72;
        doc.setFont('helvetica','bold'); doc.setFontSize(13); doc.text('Recovery', marginX, y); y += 16;
        [
          'Sleep: 7â€“9 hours per night (protect your schedule).',
          'Hydration: 30â€“35 ml/kg/day (extra around training).',
          'Stress: walk, breathe, stretch, unplug. Small daily wins add up.'
        ].forEach(t=>addWrapped('â€¢ '+t));
        await sectionBreak();

        // ==== Timeline ====
        doc.setFont('helvetica','bold'); doc.setFontSize(13); doc.text('Timeline (Realistic)', marginX, y); y += 16;
        [
          'Rate of fat loss depends on deficit, activity, and adherence.',
          'Recomp/hold phases stabilise physique and performance.',
          'Lean bulk (optional) to push muscle if desired.',
          'Reassess every 4 weeks; adjust calories Â±100â€“200 if needed.'
        ].forEach(t=>addWrapped('â€¢ '+t));
        await sectionBreak();

        // ==== Footer ====
        line(770);
        doc.setFont('helvetica','normal'); doc.setTextColor(120); doc.setFontSize(10);
        doc.text('Â© 2025 FreeFitFuelâ„¢ Â· All rights reserved. Created by Grant Cameron Anthony.', marginX, 790);

        doc.save('freefitfuel-roadmap.pdf');
      } catch (e) {
        console.error(e);
        alert('Error generating PDF. Please try again.');
      } finally {
        genBtn.dataset.busy = '0';
        genBtn.textContent = oldText;
        genBtn.disabled = false;
      }
    });
  }
});
</script>

<!-- Nutrition JS -->
<script src="assets/js/nutrition.js?v=20250928b"></script>
</body>
</html>
