<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nutrition ‚Äì FreeFitFuel</title>

  <!-- Your global stylesheet and favicon -->
  <link rel="stylesheet" href="style.css?v=30">
  <link rel="icon" type="image/svg+xml" href="img/freefitfuel-logo.svg">

  <!-- Page-specific CSS (adds on top of style.css) -->
  <style>
    .hidden{display:none}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:18px 20px}
    .lead{color:var(--inkdim)}

    /* HERO (keeps your blue header; orange page title uses .accent from style.css) */
    .hero-mini{position:relative;border-bottom:1px solid #1b1b22}
    .hero-mini figure{margin:0;position:relative}
    .hero-mini img{width:100%;height:50vh;min-height:320px;object-fit:cover;display:block;filter:brightness(.88) saturate(1.05);object-position:center 12%}
    .hero-mini .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.65))}
    .hero-mini .content{position:absolute;inset:auto 0 0 0;padding:16px 20px 22px;max-width:var(--maxw);margin:0 auto}
    .hero-mini h1{margin:0 0 .35rem}
    .hero-mini p{max-width:70ch;margin:.2rem 0 0;color:#d0d0da}

    /* Sections + Cards */
    .section{background:var(--glass);border:1px solid var(--stroke);border-radius:14px;margin:12px 0;padding:14px}
    .section>h2{margin:.15rem 0 .45rem;font-size:1.2rem}
    .note{font-size:.92rem;color:var(--inkdim)}
    .grid{display:grid;gap:12px}
    .cols-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .cols-3{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{background:var(--glass);border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
    .card figure{height:160px;background:#111;margin:0}
    .card img{width:100%;height:100%;object-fit:cover;display:block}
    .card .body{padding:12px}
    .badge{display:inline-block;font-size:.78rem;padding:.18rem .5rem;border:1px solid var(--stroke);border-radius:999px;margin-right:6px;margin-bottom:6px}
    .macros{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:.5rem 0 .2rem}
    .macros span{display:block;background:rgba(255,255,255,.06);border:1px solid var(--stroke);padding:.35rem .5rem;border-radius:8px;text-align:center}

    /* Filters */
    .filters{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:.6rem}
    .filters .tag{border:1px solid var(--stroke);background:var(--glass);padding:.35rem .7rem;border-radius:999px;cursor:pointer}
    .filters .tag.active{background:var(--accent);color:#111;font-weight:700}

    /* Planner */
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:.6rem;border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
    thead th{background:rgba(255,255,255,.06);text-align:left;font-weight:700}
    th,td{padding:.6rem;border-bottom:1px solid var(--stroke);vertical-align:top}
    tr:last-child td{border-bottom:0}
    .slot{display:flex;flex-direction:column;gap:.35rem}
    .slot .item{display:flex;justify-content:space-between;align-items:center;gap:.6rem;background:rgba(255,255,255,.04);border:1px solid var(--stroke);padding:.35rem .5rem;border-radius:8px}
    .slot .item button{border:1px solid var(--stroke);background:var(--glass);color:var(--ink);padding:.2rem .45rem;border-radius:8px;cursor:pointer}

    /* Auto planner */
    .ap-plan-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .ap-day-col{background:var(--glass);border:1px solid var(--stroke);border-radius:10px;padding:10px}
    .ap-slot .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .ap-swap{border:1px solid var(--stroke);background:var(--glass);padding:.28rem .6rem;border-radius:999px;cursor:pointer}
    .ap-total{margin-top:.4rem;color:var(--inkdim);font-size:.95rem}

    /* Food log progress */
    .progress{display:grid;gap:.5rem;margin-top:.6rem}
    .progress .line{display:grid;grid-template-columns:120px 1fr auto;gap:.6rem;align-items:center}
    .bar{background:rgba(255,255,255,.09);border:1px solid var(--stroke);height:8px;border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;width:0;transition:width .35s ease}

    /* Recipe modal (FIX 1: no transparency) */
    dialog#recipeModal::backdrop{background:rgba(0,0,0,.55)}
    dialog#recipeModal{border:0;padding:0;background:transparent}
    .rm-box{background:var(--bg);border:1px solid var(--stroke);border-radius:14px;max-width:min(760px, 92vw);margin:0 auto}
    .rm-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--stroke)}
    .rm-body{display:grid;gap:10px;padding:12px 14px}
    .rm-actions{display:flex;gap:8px;padding:12px 14px;border-top:1px solid var(--stroke)}
    .rm-actions .btn{padding:.55rem .8rem}
  </style>
</head>

  <body>
  <!-- HEADER (blue background from style.css) -->
  <header class="site-header">
    <div class="container">
      <a href="index.html" class="logo">
        <img src="img/freefitfuel-logo.svg" alt="FreeFitFuel Logo" height="56">
      </a>
      <button class="hamburger" aria-label="Open menu" aria-controls="primary-nav" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
      <nav id="primary-nav" class="main-nav" aria-label="Primary">
        <a href="index.html">Home</a>
        <a href="ideas.html">Ideas</a>
        <a href="guides.html">Guides</a>
        <a href="workouts.html">Workouts</a>
        <a href="endurance.html">Endurance</a>
        <a href="nutrition.html" aria-current="page">Nutrition</a>
        <a href="wellbeing.html">Wellbeing</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>
  </header>

  <!-- HERO (image + orange title) -->
  <header class="hero-mini" role="banner" aria-label="Nutrition hero">
    <figure>
      <img src="img/nutrition-hero.jpg" alt="Budget-friendly, colourful whole foods on a table">
      <div class="overlay" aria-hidden="true"></div>
    </figure>
    <div class="content wrap">
      <h1><span class="accent">Fuel for real life</span></h1>
      <p>Goal-based macros, budget mode, a weekly planner that builds your shopping list, and a day log that tracks your targets.</p>
    </div>
  </header>

      <main class="wrap">
    <p class="lead">Pick a <strong>goal</strong>, calculate your <strong>targets</strong> (BMR ‚Üí TDEE), then add meals to the <strong>planner</strong> and <strong>daily log</strong>. Toggle <strong>Budget</strong> to favour low-cost options. All data saves on this device.</p>

    <div class="toolbar" aria-label="Nutrition controls">
      <div class="seg" role="tablist" aria-label="Goal">
        <button role="tab" aria-pressed="true" data-goal="maintain">Maintain</button>
        <button role="tab" aria-pressed="false" data-goal="cut">Cut</button>
        <button role="tab" aria-pressed="false" data-goal="build">Build</button>
        <button role="tab" aria-pressed="false" data-goal="transform">Transform</button>
      </div>
      <span class="pill"><input type="checkbox" id="budget"> <label for="budget">Budget mode</label></span>
    </div>

    <section class="section">
      <h2>Macro & Calorie Calculator</h2>
      <div class="grid cols-2">
        <div class="calc card" style="padding:12px">
          <div class="row">
            <label>Sex
              <select id="sex"><option value="female">Female</option><option value="male">Male</option></select>
            </label>
            <label>Age <input id="age" type="number" min="13" max="99" value="35"></label>
            <label>Height (cm) <input id="cm" type="number" min="120" max="220" value="175"></label>
            <label>Weight (kg) <input id="kg" type="number" min="35" max="250" value="75"></label>
            <label>Activity
              <select id="act">
                <option value="1.2">Sedentary</option>
                <option value="1.375">Light (1‚Äì3x/wk)</option>
                <option value="1.55" selected>Moderate (3‚Äì5x)</option>
                <option value="1.725">Active (6‚Äì7x)</option>
                <option value="1.9">Very active</option>
              </select>
            </label>
          </div>
          <div class="row">
            <label>Protein (g/kg) <input id="pkk" type="number" step="0.1" value="1.8"></label>
            <label>Carb bias
              <select id="carbBias">
                <option value="balanced" selected>Balanced</option>
                <option value="lowerCarb">Lower carb</option>
                <option value="higherCarb">Higher carb</option>
              </select>
            </label>
            <label><input type="checkbox" id="knowbf"> I know body fat %</label>
            <label id="bfWrap" class="hidden">Body fat % <input id="bf" type="number" min="3" max="60" step="0.5" value="20"></label>
          </div>
          <div class="row">
            <button class="btn" id="calcBtn">Calculate</button>
            <span id="calcNote" class="out">Uses Mifflin‚ÄìSt Jeor (or Katch‚ÄìMcArdle if body fat is provided), then adjusts by activity and goal.</span>
          </div>
        </div>
        <div class="results">
          <div class="kpi" style="display:flex;justify-content:space-between;align-items:center">
            <strong id="outGoal">Maintain</strong>
            <span id="outCals">‚Äî kcal / day</span>
          </div>
          <div class="macros">
            <span><strong>Calories</strong><br><span id="barP" style="display:none"></span><span id="barC" style="display:none"></span><span id="barF" style="display:none"></span></span>
            <span><strong>Protein</strong><br><span id="outP">‚Äî g</span></span>
            <span><strong>Carbs</strong><br><span id="outC">‚Äî g</span></span>
            <span><strong>Fats</strong><br><span id="outF">‚Äî g</span></span>
          </div>
          <div class="note">Fibre: aim ~25‚Äì35 g/day. Hydration helper below.</div>
        </div>
      </div>
    </section>

            <section class="section" id="recipes">
      <h2>Recipe Library</h2>

      <div class="filters" id="recipeFilters" aria-label="Recipe filters">
        <button class="tag active" data-tag="*all">All</button>
        <button class="tag" data-tag="budget">Budget</button>
        <button class="tag" data-tag="high-protein">High-Protein</button>
        <button class="tag" data-tag="gluten-free">Gluten-Free</button>
        <button class="tag" data-tag="dairy-free">Dairy-Free</button>
        <button class="tag" data-tag="veg">Vegetarian</button>
        <button class="tag" data-tag="vegan">Vegan</button>
        <button class="tag" data-tag="quick">Quick (‚â§20m)</button>
        <button class="tag" data-tag="batch">Batch-cook</button>
        <button class="tag" data-tag="world">World cuisines</button>
        <button class="tag" data-tag="simple">Simple</button>
      </div>

      <div id="recipeGrid" class="grid cols-3"></div>
      <p class="note">Allergens are listed on every card (check labels for specific products & cross-contamination). Nutrition values are estimates.</p>
    </section>

    <!-- In-page dialog for recipe cards -->
    <dialog id="recipeModal">
      <div class="rm-box">
        <div class="rm-head">
          <strong id="rm-title">Recipe</strong>
          <button class="btn" id="rm-close">Close</button>
        </div>
        <div class="rm-body">
          <div id="rm-meta" class="note"></div>
          <h3>Ingredients</h3>
          <ul id="rm-ing"></ul>
          <h3>Method</h3>
          <ol id="rm-steps"></ol>
          <p class="note" id="rm-share"></p>
        </div>
        <div class="rm-actions">
          <button class="btn" id="rm-print">Print</button>
          <button class="btn" id="rm-copy">Copy link</button>
        </div>
      </div>
    </dialog>

            <section class="section" id="planner">
      <h2>Weekly Meal Planner</h2>
      <p class="note">Click ‚ÄúAdd to Planner‚Äù on any recipe to slot it into the week. Your plan saves on this device.</p>
      <div class="planner">
        <div class="controls">
          <button class="btn" id="clearPlan">Clear week</button>
          <button class="btn" id="printList">Print shopping list</button>
          <button class="btn" id="csvList">Download CSV</button>
        </div>
        <table>
          <thead>
            <tr><th>Day</th><th>Breakfast</th><th>Lunch</th><th>Dinner</th><th>Snacks</th></tr>
          </thead>
          <tbody id="planBody"></tbody>
        </table>
      </div>
    </section>

            <section class="section" id="auto-planner">
      <h2>Auto 7-Day Meal Planner (smart)</h2>
      <p class="meta">Auto-plans to your daily kcal target. Click <em>Swap</em> to cycle alternatives in any slot.</p>
      <div class="ap-controls">
        <label>Daily kcal target <input id="ap-kcal" type="number" min="1200" max="4500" step="50" value="2200"></label>
        <button id="ap-generate" class="btn">Generate plan</button>
        <button id="ap-clear" class="btn" style="background:rgba(255,255,255,.1);color:var(--ink);border:1px solid var(--stroke)">Clear</button>
      </div>
      <div id="ap-grid" class="ap-plan-grid"></div>
    </section>

    <section class="section" id="foodlog">
      <h2>Daily Food Log</h2>
      <div class="log">
        <div class="row">
          <label>Date <input type="date" id="logDate"></label>
          <button class="btn" id="addCustom">Ôºã Custom item</button>
          <button class="btn" id="clearLog">Clear day</button>
          <button class="btn" id="exportLog">Export CSV</button>
        </div>
        <div id="logItems"></div>
        <div class="progress">
          <div class="line"><strong>Calories</strong><div class="bar"><span id="pbCal"></span></div><span id="txCal">0 / 0</span></div>
          <div class="line"><strong>Protein</strong><div class="bar"><span id="pbProt"></span></div><span id="txProt">0 / 0</span></div>
          <div class="line"><strong>Carbs</strong><div class="bar"><span id="pbCarb"></span></div><span id="txCarb">0 / 0</span></div>
          <div class="line"><strong>Fats</strong><div class="bar"><span id="pbFat"></span></div><span id="txFat">0 / 0</span></div>
        </div>
      </div>
    </section>

    <section class="section">
      <h2>Hydration & Fibre</h2>
      <div class="grid cols-2">
        <article class="card" style="padding:.8rem">
          <h3>Hydration helper</h3>
          <div class="calc">
            <div class="row">
              <label>Body weight (kg) <input id="h-kg" type="number" min="35" max="250" value="75"></label>
              <label>Extra per hour training (ml) <input id="h-train" type="number" min="0" step="50" value="400"></label>
            </div>
            <div class="row">
              <button class="btn" id="h-calc">Calculate</button>
              <span class="out" id="h-out">‚Äî ml / day</span>
            </div>
          </div>
          <p class="note">Rule of thumb: ~30‚Äì35 ml/kg + ~300‚Äì600 ml per training hour. Adjust to heat & thirst.</p>
        </article>
        <article class="card" style="padding:.8rem">
          <h3>Fibre targets</h3>
          <p>Aim 25‚Äì35 g/day from foods. Increase gradually with fluids.</p>
          <ul><li>Oats/porridge, wholegrains</li><li>Beans/lentils/chickpeas</li><li>Fruit (berries), veg, nuts/seeds</li></ul>
        </article>
      </div>
    </section>

    <section class="section">
      <h2>Important Note</h2>
      <p>The content on FreeFitFuel is for general nutrition education only and isn‚Äôt a substitute for personalised medical advice.</p>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <img src="img/freefitfuel-logo.svg" alt="FreeFitFuel Logo" height="64">
      <p>¬© 2025 FreeFitFuel ¬∑ All rights reserved.</p>
      <p class="credit">Created by Grant Cameron Anthony</p>
    </div>
  </footer>

      /* ===== RECIPES store ===== */
  window.RECIPES = window.RECIPES || [];   /* uses whatever you already pasted */
  function addRecipes(list){ window.RECIPES = window.RECIPES.concat(list); } /* if you add more later */

  /* ===== Recipe card UI / Modal ===== */
  function recipeCard(r){
    const tags = (r.tags||[]).map(t=>`<span class="badge">${t}</span>`).join('');
    const m = r.macros || {kcal:'‚Äî',p:'‚Äî',c:'‚Äî',f:'‚Äî'};
    const allerg = (r.allergens && r.allergens.length)
      ? `Allergens: ${r.allergens.join(', ')} (check labels)`
      : 'Allergens: none listed (check labels)';
    const imgHTML = r.img ? `<figure><img src="${r.img}" alt="${r.name}" loading="lazy" onerror="this.style.display='none'"></figure>` : '<figure style="display:none"></figure>';
    return `
      <article class="card" data-tags="${(r.tags||[]).join(',')}">
        ${imgHTML}
        <div class="body">
          <h3>${r.name}</h3>
          <div>${tags} <span class="badge">${r.cuisine||''}</span></div>
          <div class="macros">
            <span>‚ö° ${m.kcal} kcal</span>
            <span>ü•© ${m.p} g</span>
            <span>üçö ${m.c} g</span>
            <span>ü´í ${m.f} g</span>
          </div>
          <div class="allergens">${allerg}</div>
          <div class="actions" style="display:flex;gap:.5rem;flex-wrap:wrap">
            <button class="btn" data-planner="${r.k}">Add to Planner</button>
            <button class="btn" data-log="${r.k}">Log 1 Serving</button>
            <button class="btn" data-view="${r.k}">Open Recipe Card</button>
            <button class="btn" data-print="${r.k}">Print Recipe Card</button>
          </div>
        </div>
      </article>`;
  }

  function openRecipeCard(k){
    const r = window.RECIPES.find(x=>x.k===k); if(!r) return;
    const dlg = document.getElementById('recipeModal'); if(!dlg) return;
    const s = r.servings || 1;
    const fmt = v => (typeof v!=='number') ? v : ((Math.round(v*10)/10).toString());
    document.getElementById('rm-title').textContent = r.name;
    document.getElementById('rm-meta').innerHTML =
      `<strong>Cuisine:</strong> ${r.cuisine||''} ¬∑ <strong>Base servings:</strong> ${s}<br>
       <strong>Macros per serving:</strong> ${r.macros.kcal} kcal ‚Äî ${r.macros.p}P / ${r.macros.c}C / ${r.macros.f}F<br>
       <strong>Allergens:</strong> ${(r.allergens&&r.allergens.length)?r.allergens.join(', '):'none listed'} (check labels)`;
    const ul = document.getElementById('rm-ing'); ul.innerHTML = (r.ingredients||[]).map(it=>`<li>${fmt(it.qty)} ${it.unit} ${it.item}</li>`).join('');
    const ol = document.getElementById('rm-steps'); ol.innerHTML = (r.steps||[]).map(step=>`<li>${step}</li>`).join('');
    const share = document.getElementById('rm-share'); const url = new URL(location.href); url.searchParams.set('recipe', r.k); share.textContent = 'Card link: ' + url.toString();
    document.getElementById('rm-close').onclick = ()=> dlg.close();
    document.getElementById('rm-print').onclick = ()=> window.print();
    document.getElementById('rm-copy').onclick = async ()=>{ try{ await navigator.clipboard.writeText(url.toString()); alert('Link copied'); }catch(e){ alert('Copy failed'); } };
    if(typeof dlg.showModal === 'function') dlg.showModal(); else dlg.show();
  }

  /* ===== Filters + render ===== */
  function renderRecipes(){
    const grid = document.getElementById('recipeGrid');
    const active = [...document.querySelectorAll('#recipeFilters .tag.active')].map(x=>x.dataset.tag);
    const allMode = active.includes('*all') || active.length === 0;
    const list = window.RECIPES.filter(r => allMode ? true : active.every(t=>r.tags.includes(t)));
    grid.innerHTML = list.map(recipeCard).join('');

    grid.querySelectorAll('[data-planner]').forEach(b=>b.addEventListener('click', ()=> addToPlanner(b.getAttribute('data-planner')) ));
    grid.querySelectorAll('[data-log]').forEach(b=>b.addEventListener('click', ()=> logRecipeServing(b.getAttribute('data-log'), 1) ));
    grid.querySelectorAll('[data-view]').forEach(b=>b.addEventListener('click', ()=> openRecipeCard(b.getAttribute('data-view')) ));
    grid.querySelectorAll('[data-print]').forEach(b=>b.addEventListener('click', ()=> printRecipe(b.getAttribute('data-print')) ));
  }

  const filtersWrap = document.getElementById('recipeFilters');
  if(filtersWrap){
    filtersWrap.addEventListener('click', e=>{
      if(!e.target.classList.contains('tag')) return;
      const tag = e.target.dataset.tag;
      if(tag === '*all'){
        // All clears others and stays active
        filtersWrap.querySelectorAll('.tag').forEach(btn=>btn.classList.toggle('active', btn.dataset.tag==='*all'));
      }else{
        // toggle this tag, and ensure All is off
        e.target.classList.toggle('active');
        const allBtn = filtersWrap.querySelector('[data-tag="*all"]');
        if(allBtn) allBtn.classList.remove('active');
        // if none left, activate All again
        const any = [...filtersWrap.querySelectorAll('.tag.active')].some(b=>b.dataset.tag!=='*all');
        if(!any && allBtn) allBtn.classList.add('active');
      }
      renderRecipes();
    });
  }

  /* ===== Pantry Match button ===== */
  (function addPantryButton(){
    const btn = document.createElement('button');
    btn.textContent = 'Pantry Match';
    btn.className = 'btn';
    btn.style.cssText = 'position:sticky;top:8px;margin-bottom:8px';
    const filters = document.getElementById('recipeFilters');
    if(filters){ filters.after(btn); btn.addEventListener('click', pantryMatch); }
  })();

  function pantryMatch(){
    const raw = prompt('Type ingredients you have (comma-separated):\nExample: rice, chickpeas, tomatoes, onion, eggs');
    if(!raw) return;
    const have = raw.toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
    const score = (r)=>{
      const list = (r.adds||[]).concat((r.ingredients||[]).map(i=>i.item));
      let hit = 0;
      list.forEach(item=>{ const it=String(item).toLowerCase(); if(have.some(h=>it.includes(h))) hit++; });
      return hit;
    };
    const ranked = window.RECIPES.map(r=>({r, s:score(r)})).filter(x=>x.s>0).sort((a,b)=>b.s-a.s).slice(0,18).map(x=>x.r);
    const grid = document.getElementById('recipeGrid');
    grid.innerHTML = ranked.length ? ranked.map(recipeCard).join('') : '<p class="note">No strong matches. Try broader ingredients (e.g., "beans", "rice", "eggs").</p>';
    if(ranked.length){
      grid.querySelectorAll('[data-planner]').forEach(b=>b.addEventListener('click', ()=> addToPlanner(b.getAttribute('data-planner')) ));
      grid.querySelectorAll('[data-log]').forEach(b=>b.addEventListener('click', ()=> logRecipeServing(b.getAttribute('data-log'), 1) ));
      grid.querySelectorAll('[data-view]').forEach(b=>b.addEventListener('click', ()=> openRecipeCard(b.getAttribute('data-view')) ));
      grid.querySelectorAll('[data-print]').forEach(b=>b.addEventListener('click', ()=> printRecipe(b.getAttribute('data-print')) ));
    }
  }

  /* ===== Weekly planner (manual) ===== */
  const WEEKDAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const MEALS = ['Breakfast','Lunch','Dinner','Snacks'];
  const planKey = 'fff-plan-week';

  function loadPlan(){ try{ const raw=localStorage.getItem(planKey); if(raw) return JSON.parse(raw); }catch(e){} const blank={}; WEEKDAYS.forEach(d=>{ blank[d]={}; MEALS.forEach(m=>blank[d][m]=[]); }); return blank; }
  function savePlan(p){ localStorage.setItem(planKey, JSON.stringify(p)); }

  function renderPlanner(){
    const body = document.getElementById('planBody');
    const plan = loadPlan();
    body.innerHTML = WEEKDAYS.map(d=>{
      const tds = MEALS.map(m=>{
        const items = plan[d][m]||[];
        const html = items.map((it,idx)=>`
          <div class="item"><span>${it.name}</span>
            <button title="Remove" data-del="${d}|${m}|${idx}">√ó</button>
          </div>`).join('');
        return `<td><div class="slot">${html}</div></td>`;
      }).join('');
      return `<tr><th>${d}</th>${tds}</tr>`;
    }).join('');
    body.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const [dd,mm,i] = btn.getAttribute('data-del').split('|');
        const plan = loadPlan();
        plan[dd][mm].splice(+i,1);
        savePlan(plan); renderPlanner();
      });
    });
  }

  function addToPlanner(k){
    const r = window.RECIPES.find(x=>x.k===k); if(!r) return;
    const day = prompt('Add to which day? (Mon/Tue/Wed/Thu/Fri/Sat/Sun)','Mon');
    if(!WEEKDAYS.includes(day)) return;
    const meal = prompt('Meal slot? (Breakfast/Lunch/Dinner/Snacks)','Dinner');
    if(!MEALS.includes(meal)) return;
    const plan = loadPlan(); plan[day][meal].push({ref:r.k, name:r.name});
    savePlan(plan); renderPlanner();
  }

  const clearPlanBtn = document.getElementById('clearPlan');
  if(clearPlanBtn){ clearPlanBtn.addEventListener('click', ()=>{ if(confirm('Clear the whole week?')){ localStorage.removeItem(planKey); renderPlanner(); } }); }

  /* Shopping list */
  function aggregateList(){
    const plan = loadPlan(); const items = [];
    WEEKDAYS.forEach(d=>MEALS.forEach(m=>{
      (plan[d][m]||[]).forEach(it=>{
        const r = window.RECIPES.find(x=>x.k===it.ref); if(!r) return;
        let adds = [...(r.adds||[])];
        if(budgetMode){
          adds = adds.map(x=>{
            const key = Object.keys(budgetSwaps).find(k=>x.toLowerCase().includes(k));
            return key ? (budgetSwaps[key] + ' (swap)') : x;
          });
        }
        items.push(...adds);
      });
    }));
    return [...new Set(items.map(s=>s.toLowerCase()))];
  }
  const printListBtn = document.getElementById('printList');
  if(printListBtn){ printListBtn.addEventListener('click', ()=>{ const items=aggregateList(); const w=window.open('','PRINT','width=600,height=700'); if(!w) return; w.document.write('<h3>Shopping List</h3><ul>'+items.map(i=>'<li>'+i+'</li>').join('')+'</ul>'); w.document.close(); w.focus(); w.print(); }); }
  const csvListBtn = document.getElementById('csvList');
  if(csvListBtn){ csvListBtn.addEventListener('click', ()=>{ const items=aggregateList(); const csv='item\n' + items.map(x=>'"'+x.replace(/"/g,'""')+'"').join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='shopping-list.csv'; a.click(); URL.revokeObjectURL(url); }); }

  /* ===== Auto 7-Day Planner (no repeats) ===== */
  function apGuessCategory(r){
    const nm=(r.name||'').toLowerCase();
    const has=s=>nm.includes(s);
    if(has('oat')||has('yoghurt')||has('parfait')||(has('egg')&&!has('shakshuka'))) return 'breakfast';
    if(has('wrap')||has('sandwich')||((has('salad')||has('bowl'))&&!has('rice & chicken'))) return 'lunch';
    if(has('banana ice')||has('parfait')||has('chia')||has('snack')) return 'snack';
    return 'dinner';
  }
  function apPoolBy(cat){ return window.RECIPES.filter(r=>apGuessCategory(r)===cat); }
  function apKcal(r){ return r?.macros?.kcal || 400; }
  function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]]; } return x; }

  function apBuildWeek(kcalTarget){
    const shares={breakfast:.25,lunch:.30,dinner:.35,snack:.10};
    const cats=['breakfast','lunch','dinner','snack'];
    const pickUnique = (pool)=>{ if(pool.length>=7) return shuffle(pool).slice(0,7); const bag=shuffle(pool); while(bag.length<7) bag.push(...shuffle(pool)); return bag.slice(0,7); };
    const sortedPools={};
    cats.forEach(cat=>{ const want=kcalTarget*shares[cat]; sortedPools[cat]=apPoolBy(cat).slice().sort((a,b)=>Math.abs(apKcal(a)-want)-Math.abs(apKcal(b)-want)); });
    const picks={}; cats.forEach(cat=>{ picks[cat]=pickUnique(sortedPools[cat]); });

    const week=[];
    for(let d=0; d<7; d++){
      const day={};
      cats.forEach(cat=>{
        let choice=picks[cat][d % picks[cat].length];
        if(d>0 && week[d-1][cat] && choice.k===week[d-1][cat].k && sortedPools[cat].length>1){
          for(let s=1;s<sortedPools[cat].length;s++){
            const alt=sortedPools[cat][(d+s)%sortedPools[cat].length];
            if(alt.k!==week[d-1][cat].k){ choice=alt; break; }
          }
        }
        day[cat]=choice;
      });
      day.total=['breakfast','lunch','dinner','snack'].reduce((a,k)=>a+(day[k]?apKcal(day[k]):0),0);
      week.push(day);
    }
    return week;
  }

  const AP_KEY='fff-aplan-v1';
  let AP_PLAN = (()=>{ try{ return JSON.parse(localStorage.getItem(AP_KEY)||'null'); }catch(e){ return null; } })() || Array.from({length:7},()=>({}));
  function saveAP(){ localStorage.setItem(AP_KEY, JSON.stringify(AP_PLAN)); }

  const apGrid=document.getElementById('ap-grid');
  function apDayTotal(day){ return ['breakfast','lunch','dinner','snack'].reduce((a,k)=>a+(day[k]?apKcal(day[k]):0),0); }
  function apSlotHTML(rec,cat,dayIndex){
    if(!rec){ const nice=cat[0].toUpperCase()+cat.slice(1); return `<div class="ap-slot" data-day="${dayIndex}" data-cat="${cat}"><div class="row"><span class="name">${nice}</span><button class="ap-swap" data-swap>Swap</button></div><div class="cal">‚Äî</div></div>`; }
    return `<div class="ap-slot" data-day="${dayIndex}" data-cat="${cat}"><div class="row"><span class="name">${rec.name}</span><button class="ap-swap" data-swap>Swap</button></div><div class="cal">${apKcal(rec)} kcal</div></div>`;
  }
  function apRender(){
    apGrid.innerHTML='';
    const DAYS=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    DAYS.forEach((d,idx)=>{
      const day=AP_PLAN[idx]||{};
      const col=document.createElement('div'); col.className='ap-day-col';
      col.innerHTML=`<h3>${d}</h3>${apSlotHTML(day.breakfast,'breakfast',idx)}${apSlotHTML(day.lunch,'lunch',idx)}${apSlotHTML(day.dinner,'dinner',idx)}${apSlotHTML(day.snack,'snack',idx)}<div class="ap-total">‚âà ${Math.round(apDayTotal(day))} kcal</div>`;
      apGrid.appendChild(col);
    });
    apGrid.querySelectorAll('[data-swap]').forEach(btn=>{
      btn.onclick=()=>{
        const slot=btn.closest('.ap-slot'); const day=+slot.dataset.day; const cat=slot.dataset.cat;
        const pool=apPoolBy(cat); if(!pool.length) return;
        const cur=AP_PLAN[day][cat]; let i=cur?pool.findIndex(r=>r.k===cur.k):-1;
        for(let j=1;j<=pool.length;j++){ const cand=pool[(i+j)%pool.length]; if(!cur || cand.k!==cur.k){ AP_PLAN[day][cat]=cand; break; } }
        AP_PLAN[day].total=apDayTotal(AP_PLAN[day]); saveAP(); apRender();
      };
    });
  }
  const apGen=document.getElementById('ap-generate'); if(apGen){ apGen.addEventListener('click', ()=>{ const kcal=+document.getElementById('ap-kcal').value||2200; AP_PLAN=apBuildWeek(kcal); saveAP(); apRender(); }); }
  const apClr=document.getElementById('ap-clear'); if(apClr){ apClr.addEventListener('click', ()=>{ if(!confirm('Clear auto-plan for the whole week?')) return; AP_PLAN=Array.from({length:7},()=>({})); saveAP(); apRender(); }); }
  apRender();

  /* ===== Food log ===== */
  const logKey='fff-foodlog';
  const dateInput=document.getElementById('logDate'); if(dateInput){ dateInput.valueAsNumber = Date.now() - (new Date()).getTimezoneOffset()*60000; }
  function getLogStore(){ try{ const raw=localStorage.getItem(logKey); if(raw) return JSON.parse(raw); }catch(e){} return {}; }
  function saveLogStore(s){ localStorage.setItem(logKey, JSON.stringify(s)); }
  function logFor(ds){ const s=getLogStore(); return s[ds] || {items:[]}; }
  function saveLog(ds,data){ const s=getLogStore(); s[ds]=data; saveLogStore(s); }
  function sumDay(ds){ const data=logFor(ds); return data.items.reduce((a,x)=>({kcal:a.kcal+x.kcal,p:a.p+x.p,c:a.c+x.c,f:a.f+x.f}),{kcal:0,p:0,c:0,f:0}); }

  function renderLog(){
    if(!dateInput) return;
    const ds = dateInput.value || new Date().toISOString().slice(0,10);
    const data = logFor(ds);
    const box = document.getElementById('logItems'); if(!box) return;
    if(!data.items.length){ box.innerHTML='<p class="note">No items logged yet. Use ‚ÄúLog 1 Serving‚Äù on a recipe or add a custom item.</p>'; updateLogBars(); return; }
    box.innerHTML = data.items.map((it,i)=>`<div class="slot item"><div><strong>${it.name}</strong> ‚Äî ${it.kcal} kcal ¬∑ ${it.p}P / ${it.c}C / ${it.f}F</div><button title="Remove" data-del="${i}">√ó</button></div>`).join('');
    box.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{ const ds2=dateInput.value || new Date().toISOString().slice(0,10); const idx=+btn.getAttribute('data-del'); const data2=logFor(ds2); data2.items.splice(idx,1); saveLog(ds2,data2); renderLog(); updateLogBars(); });
    });
  }
  function updateLogBars(){
    const ds=(dateInput && dateInput.value)||new Date().toISOString().slice(0,10);
    const t=targets||{cal:0,p:0,c:0,f:0};
    const s=sumDay(ds);
    const setTx=(id,txt)=>{ const el=document.getElementById(id); if(el) el.textContent=txt; };
    setTx('txCal',`${s.kcal} / ${t.cal||0}`);
    setTx('txProt',`${s.p} / ${t.p||0}g`);
    setTx('txCarb',`${s.c} / ${t.c||0}g`);
    setTx('txFat',`${s.f} / ${t.f||0}g`);
    const pct=(a,b)=> b? Math.max(0, Math.min(100, Math.round(100*a/b))) : 0;
    const setBar=(id,v)=>{ const el=document.getElementById(id); if(el) el.style.width=v+'%'; };
    setBar('pbCal',pct(s.kcal,t.cal||0));
    setBar('pbProt',pct(s.p,t.p||0));
    setBar('pbCarb',pct(s.c,t.c||0));
    setBar('pbFat',pct(s.f,t.f||0));
  }
  const addBtn=document.getElementById('addCustom'); if(addBtn){ addBtn.addEventListener('click', ()=>{ const name=prompt('Food name','Custom item'); if(!name) return; const kcal=+prompt('Calories','150')||0; const p=+prompt('Protein (g)','10')||0; const c=+prompt('Carbs (g)','25')||0; const f=+prompt('Fats (g)','5')||0; const ds=(dateInput&&dateInput.value)||new Date().toISOString().slice(0,10); const data=logFor(ds); data.items.push({type:'custom', name, servings:1, kcal, p, c, f}); saveLog(ds,data); renderLog(); updateLogBars(); }); }
  const clrBtn=document.getElementById('clearLog'); if(clrBtn){ clrBtn.addEventListener('click', ()=>{ const ds=(dateInput&&dateInput.value)||new Date().toISOString().slice(0,10); if(confirm('Clear all logged items for '+ds+'?')){ saveLog(ds,{items:[]}); renderLog(); updateLogBars(); } }); }
  const expBtn=document.getElementById('exportLog'); if(expBtn){ expBtn.addEventListener('click', ()=>{ const ds=(dateInput&&dateInput.value)||new Date().toISOString().slice(0,10); const data=logFor(ds); const csv='name,servings,calories,protein,carbohydrates,fats\n'+data.items.map(it=>[it.name,it.servings,it.kcal,it.p,it.c,it.f].map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='foodlog-'+ds+'.csv'; a.click(); URL.revokeObjectURL(url); }); }
  if(dateInput){ dateInput.addEventListener('change', ()=>{ renderLog(); updateLogBars(); }); }

  /* Print recipe card */
  function printRecipe(k){
    const r=window.RECIPES.find(x=>x.k===k); if(!r) return;
    const s=+prompt('Servings for print (default '+(r.servings||1)+'):', r.servings||1) || (r.servings||1);
    const scale=s/(r.servings||1);
    const fmtQty=v=>{ if(typeof v!=='number') return v; const n=Math.round(v*10)/10; return (n%1===0)? n.toString(): n.toFixed(1); };
    let adds=r.adds||[]; if(budgetMode){ adds=adds.map(x=>{ const key=Object.keys(budgetSwaps).find(k=>x.toLowerCase().includes(k)); return key ? (budgetSwaps[key]+' (swap)') : x; }); }
    const win=window.open('','PRINT','width=760,height=940'); if(!win) return;
    win.document.write(`<h2>${r.name}</h2><p><strong>Cuisine:</strong> ${r.cuisine||''} ¬∑ <strong>Servings:</strong> ${s}</p><p><strong>Macros per serving (base):</strong> ${r.macros.kcal} kcal ‚Äî ${r.macros.p}P / ${r.macros.c}C / ${r.macros.f}F</p><p><strong>Allergens:</strong> ${(r.allergens&&r.allergens.length)?r.allergens.join(', '):'none listed'} (check labels)</p><h3>Ingredients</h3><ul>${(r.ingredients||[]).map(it=>`<li>${fmtQty(it.qty*scale)} ${it.unit} ${it.item}</li>`).join('')}</ul><h3>Method</h3><ol>${(r.steps||[]).map(s=>`<li>${s}</li>`).join('')}</ol><h3>Shopping Items</h3><ul>${(adds||[]).map(a=>`<li>${a}</li>`).join('')}</ul><hr><p style="font-size:.9rem;color:#555">Nutrition values are estimates. Check labels for allergens.</p>`);
    win.document.close(); win.focus(); win.print();
  }

  /* ===== Boot ===== */
  (function boot(){
    try{
      const saved=JSON.parse(localStorage.getItem('fff-targets')||'null');
      if(saved && saved.targets){
        goal=saved.goal||goal; targets=saved.targets; lastCalc=true;
        document.querySelectorAll('[data-goal]').forEach(x=>x.setAttribute('aria-pressed', x.dataset.goal===goal ? 'true':'false'));
        const og=document.getElementById('outGoal'),
              oc=document.getElementById('outCals'),
              op=document.getElementById('outP'),
              ocb=document.getElementById('outC'),
              of=document.getElementById('outF');
        if(og) og.textContent = goal[0].toUpperCase()+goal.slice(1);
        if(oc) oc.textContent = targets.cal+' kcal / day';
        if(op) op.textContent = targets.p+' g';
        if(ocb) ocb.textContent = targets.c+' g';
        if(of) of.textContent = targets.f+' g';
      }
    }catch(e){}
    // recipe deep link
    const rid=new URL(location.href).searchParams.get('recipe'); if(rid){ openRecipeCard(rid); }
    renderRecipes(); renderPlanner(); renderLog(); updateLogBars();
  })();
  </script>
</body>
</html>
