<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Workout Plan — FreeFitFuel</title>

  <!-- Optional: reuse your global styles -->
  <link rel="stylesheet" href="style.css?v=27">

  <style>
    :root{
      --bg:#0b0f14; --ink:#e6e6ea; --inkdim:#b7b7c2;
      --glass:#0f131a; --stroke:#1f2630; --accent:#ff6a00;
      --maxw:1100px;
    }
    body{background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Arial,sans-serif}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:18px 20px}
    h1{margin:.2rem 0 0.6rem;font-size:1.8rem;color:var(--ink)}
    .lead{color:var(--inkdim)}
    .section{background:var(--glass);border:1px solid var(--stroke);border-radius:14px;margin:14px 0;padding:16px}
    h2{margin:.1rem 0 .6rem;font-size:1.2rem;color:var(--accent)}
    h3{margin:.4rem 0 .4rem;font-size:1.05rem;color:var(--ink)}
    .meta{color:var(--inkdim)}
    .btn-sm{border:1px solid var(--stroke);background:#121821;color:var(--ink);padding:.35rem .6rem;border-radius:8px;cursor:pointer}
    .grid{display:grid;gap:.6rem}
    .log-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.6rem}
    label{display:flex;align-items:center;gap:.5rem}
    input[type="checkbox"]{accent-color:var(--accent)}
    input[type="number"], input[type="text"]{
      background:#0c1118;border:1px solid var(--stroke);border-radius:8px;color:var(--ink);
      padding:.4rem .5rem; width:100%;
    }
    .stage{border:1px solid var(--stroke);border-radius:12px;padding:12px;margin:.8rem 0}
    .stage>header{display:flex;justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap}
    .days{display:grid;gap:10px}
    @media(min-width:820px){ .days{grid-template-columns:repeat(2,1fr)} }
    .day{border:1px dashed var(--stroke);border-radius:10px;padding:10px}
    .day h4{margin:.1rem 0 .4rem;font-size:1rem;color:var(--ink)}
    .exercise{border:1px solid var(--stroke);border-radius:10px;padding:.55rem .6rem;margin:.5rem 0}
    .ex-head{display:flex;justify-content:space-between;gap:.6rem;align-items:center;flex-wrap:wrap}
    .ex-name{font-weight:600}
    .ex-presc{color:var(--inkdim)}
    .pb{display:grid;grid-template-columns:repeat(3,100px) auto;gap:.4rem;align-items:center;margin-top:.35rem}
    .pb small{color:var(--inkdim)}
    .restbar{display:flex;align-items:center;gap:.4rem;margin:.35rem 0;flex-wrap:wrap}
    .restbar input{width:80px}
    .restbar .left{opacity:.9;min-width:44px}
    .tip{font-size:.9rem;color:var(--inkdim);margin-top:.3rem}
    .warn{background:#23140f;border:1px solid #3a2016;color:#ffb89a;padding:.5rem .6rem;border-radius:8px;margin:.5rem 0}
    .ok{background:#142316;border:1px solid #203a23;color:#b9ffb9;padding:.5rem .6rem;border-radius:8px;margin:.5rem 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>My Workout Plan</h1>
    <p class="lead">Fully client-side. Your data stays in this browser. </p>

    <!-- Wellness checks -->
    <section class="section">
      <h2>Daily Wellness Check</h2>
      <div class="log-grid">
        <label><input type="checkbox" id="hydrDone"> Hydration hit</label>
        <label><input type="checkbox" id="sleepDone"> Sleep goal met</label>
        <label><input type="checkbox" id="macroDone"> Macros on target</label>
        <label><input type="checkbox" id="activityWalk"> Walk</label>
        <label><input type="checkbox" id="activityRun"> Run</label>
        <label><input type="checkbox" id="activityBike"> Bike</label>
      </div>
      <p class="tip">Tip: these checkboxes auto-save. Refresh and they’ll still be set.</p>
    </section>

    <!-- Plan container -->
    <section id="planSection" class="section">
      <h2>Your Personalised Plan</h2>
      <div id="plan"></div>
      <div id="planMsg" class="meta"></div>
    </section>

    <!-- Backup -->
    <section class="section">
      <h2>Backup / Reset</h2>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <button class="btn-sm" id="btnExport">Export all workout data (.json)</button>
        <label class="btn-sm" for="importFile" style="cursor:pointer;display:inline-flex;align-items:center;justify-content:center">Import data</label>
        <input id="importFile" type="file" accept="application/json" style="display:none">
        <button class="btn-sm" id="btnReset">Reset (PBs + wellness only)</button>
      </div>
      <p class="tip">Roadmap stays stored at <code>localStorage["fff.roadmap.plan.v1"]</code>. PBs/toggles use separate keys.</p>
    </section>
  </div>

<script>
/* =========================
   Config / Keys
   ========================= */
const ROADMAP_KEY = 'fff.roadmap.plan.v1'; // <- as requested (unchanged)
const PB_PREFIX   = 'fff_pb_';             // per-exercise PBs
const TOGGLE_PREFIX = 'fff_check_';        // wellness toggles

/* =========================
   Audio beeps for timers
   ========================= */
function playBeep(freq=880, ms=160, gain=0.028){
  try{
    const Ctx = window.AudioContext || window.webkitAudioContext;
    const ctx = new Ctx();
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.type='sine'; o.frequency.value=freq; g.gain.value=gain;
    o.connect(g); g.connect(ctx.destination);
    o.start(); setTimeout(()=>{ o.stop(); ctx.close(); }, ms);
  }catch{}
}
function tripleLeadIn(next){
  let i=0; const seq=[600,700,800];
  const t=setInterval(()=>{ playBeep(seq[i],120,0.03); i++; if(i>=3){ clearInterval(t); setTimeout(()=>next&&next(),140); } }, 280);
}
function tripleFinish(){ [900,700,500].forEach((f,idx)=>setTimeout(()=>playBeep(f,140,0.035), idx*220)); }

/* =========================
   Wellness toggles
   ========================= */
['hydrDone','sleepDone','macroDone','activityWalk','activityRun','activityBike'].forEach(id=>{
  const el=document.getElementById(id);
  const k=TOGGLE_PREFIX+id;
  try{ if(localStorage.getItem(k)==='1') el.checked=true; }catch{}
  el?.addEventListener('change',()=>{ try{ localStorage.setItem(k, el.checked?'1':'0'); }catch{} });
});

/* =========================
   PB helpers
   ========================= */
function pbKey(key){ return PB_PREFIX + key; }
function loadPB(key){ try{ return JSON.parse(localStorage.getItem(pbKey(key))||'{}'); }catch{ return {}; } }
function savePB(key, obj){ try{ localStorage.setItem(pbKey(key), JSON.stringify(obj)); }catch{} }

/* =========================
   Rest timer UI + wiring
   ========================= */
function restControlsHTML(uniqueKey){
  return `
    <div class="restbar" data-rest="${uniqueKey}" data-bound="0">
      <span>⏱ Rest:</span>
      <input type="number" min="5" step="5" value="90" aria-label="Rest seconds">
      <button class="btn-sm" data-act="rest-start" title="3-beep lead-in then countdown">Start</button>
      <button class="btn-sm" data-act="rest-stop">Stop</button>
      <span class="left" aria-live="polite">90s</span>
    </div>
  `;
}
function hookRestTimers(scope){
  scope.querySelectorAll('.restbar').forEach(bar=>{
    if(bar.dataset.bound==='1') return;
    bar.dataset.bound='1';
    const input = bar.querySelector('input[type="number"]');
    const left  = bar.querySelector('.left');
    const start = bar.querySelector('[data-act="rest-start"]');
    const stop  = bar.querySelector('[data-act="rest-stop"]');
    let timer=null;

    const fmt=(sec)=>{ sec=Math.max(0,Math.floor(Number(sec)||0)); const m=Math.floor(sec/60), s=sec%60; return m ? `${m}:${String(s).padStart(2,'0')}` : `${s}s`; };
    const show=(v)=>{ left.textContent = fmt(v); };
    show(parseInt(input?.value||'0',10));

    start?.addEventListener('click', ()=>{
      let total = Math.max(5, parseInt(input?.value||'0',10) || 0);
      clearInterval(timer);
      tripleLeadIn(()=>{
        let remain = total; show(remain);
        timer = setInterval(()=>{
          remain -= 1; show(remain);
          if(remain<=0){
            clearInterval(timer);
            left.textContent='Go!';
            bar.animate([{opacity:1},{opacity:.35},{opacity:1}],{duration:600,iterations:2});
            tripleFinish();
          }
        },1000);
      });
    });
    stop?.addEventListener('click', ()=>{ clearInterval(timer); show(parseInt(input?.value||'0',10)); });
    input?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ start?.click(); } });
  });
}

/* =========================
   Render plan from roadmap
   ========================= */
function renderPlan(){
  const planEl = document.getElementById('plan');
  const msgEl  = document.getElementById('planMsg');

  let roadmapRaw = null;
  try{ roadmapRaw = localStorage.getItem(ROADMAP_KEY); }catch{}

  if(!roadmapRaw){
    planEl.innerHTML = `
      <div class="warn">No roadmap found.
        Generate one in <a href="nutrition.html" style="color:#ffd4bf;text-decoration:underline">Nutrition</a>
        (Create Plan → staged or single-phase). This page will auto-load it here.
      </div>`;
    msgEl.textContent = '';
    return;
  }

  let data = null;
  try{ data = JSON.parse(roadmapRaw); }catch(e){
    planEl.innerHTML = `<div class="warn">Saved roadmap is unreadable. Please re-generate from Nutrition.</div>`;
    msgEl.textContent = '';
    return;
  }

  const stages = Array.isArray(data.stages) ? data.stages : [];
  if(!stages.length){
    planEl.innerHTML = `<div class="warn">Roadmap has no stages. Re-generate from Nutrition.</div>`;
    msgEl.textContent = '';
    return;
  }

  const ytTip = (data.meta && data.meta.youtubeTip) || 'Form tip: search YouTube — exercise name + “form”.';
  let html = `<p class="ok">${ytTip}</p>`;

  stages.forEach((stage, si)=>{
    const name = stage.name || `Stage ${si+1}`;
    const weeks = (stage.weeks_min && stage.weeks_max) ? `${stage.weeks_min}–${stage.weeks_max} weeks` : '';
    const bfT = stage.bf_target ? `BF target: ${stage.bf_target}` : '';
    const blurb = stage.blurb || '';
    const split = stage.split || ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    html += `
      <div class="stage">
        <header>
          <h3>${name}</h3>
          <div class="meta">${[bfT, weeks].filter(Boolean).join(' · ')}</div>
        </header>
        ${blurb ? `<p class="meta" style="margin:.2rem 0 .5rem">${blurb}</p>` : ''}
        <div class="days">
    `;

    for(let di=0; di<7; di++){
      const dayLabel = split[di] || ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][di] || `Day ${di+1}`;
      const items = (stage.programByDay && stage.programByDay[di]) ? stage.programByDay[di] : [];
      html += `<div class="day"><h4>${dayLabel}</h4>`;

      if(!items.length){
        html += `<p class="meta">Rest / No structured training</p></div>`;
        continue;
      }

      items.forEach((it, ei)=>{
        // Key for PB storage per exercise instance
        const key = `s${si}d${di}e${ei}`;
        const pb = loadPB(key);

        // Build prescription string
        let presc = '';
        if(it.type === 'cardio'){
          const parts = [];
          if(it.duration_min) parts.push(`${it.duration_min} min`);
          if(it.work_s) parts.push(`work ${it.work_s}s`);
          if(it.rest_s) parts.push(`rest ${it.rest_s}s`);
          if(it.rounds) parts.push(`${it.rounds} rounds`);
          presc = parts.join(' · ');
        }else{
          const sets = it.sets ?? '—';
          const reps = it.reps ?? '—';
          const rir  = (it.rir ?? '—') + ' RIR';
          const rest = (it.rest ?? 60) + 's rest';
          presc = `${sets}×${reps} · ${rir} · ${rest}`;
        }

        html += `
          <div class="exercise">
            <div class="ex-head">
              <div class="ex-name">${it.name || 'Exercise'}</div>
              <div class="ex-presc meta">${presc}</div>
            </div>

            <!-- PB row -->
            <div class="pb">
              <small>PB log:</small>
              <input type="number" placeholder="sets" value="${pb.sets ?? ''}" class="pb-sets" data-key="${key}">
              <input type="number" placeholder="reps" value="${pb.reps ?? ''}" class="pb-reps" data-key="${key}">
              <input type="number" placeholder="kg"   value="${pb.wt   ?? ''}" class="pb-wt"   data-key="${key}">
              <button class="btn-sm" data-savepb="${key}">Save PB</button>
            </div>

            <!-- Per-exercise rest timer -->
            ${it.type === 'cardio' ? '' : restControlsHTML(key)}
            ${it.cue ? `<p class="tip">${it.cue}</p>` : ''}
          </div>
        `;
      });

      html += `</div>`;
    }

    html += `</div></div>`;
  });

  planEl.innerHTML = html;
  msgEl.textContent = `Loaded ${stages.length} stage${stages.length>1?'s':''} from local plan.`;

  // Hook PB save buttons
  document.querySelectorAll('[data-savepb]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.getAttribute('data-savepb');
      const sets = document.querySelector(`.pb-sets[data-key="${key}"]`)?.value || '';
      const reps = document.querySelector(`.pb-reps[data-key="${key}"]`)?.value || '';
      const wt   = document.querySelector(`.pb-wt[data-key="${key}"]`)?.value || '';
      savePB(key, {sets, reps, wt});
      btn.textContent = 'Saved ✓';
      setTimeout(()=>btn.textContent='Save PB', 1200);
    });
  });

  // Hook per-exercise timers
  hookRestTimers(planEl);
}

/* =========================
   Export / Import / Reset
   ========================= */
function exportAll(){
  const dump = {};
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(!k) continue;
    if(k.startsWith(PB_PREFIX) || k.startsWith(TOGGLE_PREFIX) || k===ROADMAP_KEY){
      dump[k] = localStorage.getItem(k);
    }
  }
  const blob = new Blob([JSON.stringify(dump,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='freefitfuel-workout-plan-backup.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importAll(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(String(reader.result||'{}'));
      Object.keys(obj).forEach(k=>{ localStorage.setItem(k, obj[k]); });
      alert('Import complete. Reloading plan.'); renderPlan();
    }catch{ alert('Import failed: invalid file.'); }
  };
  reader.readAsText(file);
}
function resetPBsAndWellness(){
  const toDelete=[];
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i); if(!k) continue;
    if(k.startsWith(PB_PREFIX) || k.startsWith(TOGGLE_PREFIX)) toDelete.push(k);
  }
  toDelete.forEach(k=>localStorage.removeItem(k));
  alert('Cleared PBs & wellness toggles. Roadmap left intact.'); location.reload();
}
document.getElementById('btnExport')?.addEventListener('click', exportAll);
document.getElementById('importFile')?.addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(f) importAll(f);
});
document.getElementById('btnReset')?.addEventListener('click', resetPBsAndWellness);

/* =========================
   Boot
   ========================= */
renderPlan();
</script>
</body>
</html>
