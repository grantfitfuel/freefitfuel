<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Yoga & Meditation – FreeFitFuel</title>

  <link rel="stylesheet" href="/style.css?v=27">
  <link rel="icon" type="image/svg+xml" href="/img/freefitfuel-logo.svg">

  <style>
    :root{ --calm1: rgba(255,255,255,.05); --calm2: rgba(255,255,255,.08) }
    .wrap{max-width:var(--maxw);margin:0 auto;padding:18px 20px}
    .lead{color:var(--inkdim)}

    /* Calm hero */
    .hero-mini{position:relative;border-bottom:1px solid #1b1b22}
    .hero-mini figure{margin:0;position:relative}
    .hero-mini img{width:100%;height:46vh;min-height:320px;object-fit:cover;display:block;filter:brightness(.8) saturate(1.08)}
    .hero-mini .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.6))}
    .hero-mini .content{position:absolute;inset:auto 0 0 0;padding:16px 20px 22px;max-width:var(--maxw);margin:0 auto}
    .hero-mini h1{margin:0 0 .35rem}
    .hero-mini p{max-width:70ch;margin:.2rem 0 .6rem;color:#d0d0da}

    .mini-nav{display:flex;flex-wrap:wrap;gap:.5rem;margin:.75rem 0 1rem}
    .mini-nav a{background:var(--glass);border:1px solid var(--stroke);color:var(--ink);text-decoration:none;padding:.45rem .8rem;border-radius:999px;font-size:.92rem}
    .mini-nav a:hover{color:var(--accent)}

    .section{background:var(--glass);border:1px solid var(--stroke);border-radius:14px;margin:12px 0;padding:14px}
    .section>h2{margin:.15rem 0 .45rem;font-size:1.2rem}
    .grid{display:grid;gap:12px}
    @media (min-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}

    .card,.sess{background:#111418;border:1px solid var(--stroke);border-radius:12px;padding:12px}
    .card h3,.sess h3{margin:.15rem 0 .35rem}
    .meta{color:var(--inkdim);font-size:.92rem}
    .tag{display:inline-block;background:var(--calm1);border:1px solid var(--stroke);border-radius:999px;padding:.16rem .5rem;font-size:.78rem;margin-left:.3rem}
    .steps{margin:.25rem 0 .5rem;padding-left:1.1rem}
    .steps li{margin:.25rem 0}

    /* Collapsibles */
    .details{background:#0e1217;border:1px solid var(--stroke);border-radius:10px;padding:.6rem .7rem;margin:.55rem 0}
    .details summary{cursor:pointer;font-weight:600}
    .details p,.details ul,.details ol{margin:.35rem 0}

    /* Timers */
    .timer{display:flex;gap:.45rem;align-items:center;margin:.45rem 0 .2rem}
    .timer input{width:84px;background:#0b0f14;border:1px solid var(--stroke);border-radius:6px;color:var(--ink);padding:.35rem .45rem}
    .timer button{border:1px solid var(--stroke);background:var(--glass);color:var(--ink);padding:.35rem .6rem;border-radius:8px;cursor:pointer}
    .timer .left{min-width:68px;text-align:right;opacity:.85}

    /* Video tiles */
    .videos{display:grid;gap:12px}
    @media (min-width:860px){.videos{grid-template-columns:repeat(3,1fr)}}
    .tile{position:relative;aspect-ratio:16/9;background:#000;border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
    .tile .thumb{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.9)}
    .tile .overlay{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.5),transparent 50%)}
    .tile .label{position:absolute;left:.6rem;bottom:.5rem;color:#fff;font-weight:600;text-shadow:0 1px 2px rgba(0,0,0,.5)}
    .tile button.play{position:absolute;inset:0;display:grid;place-items:center;border:0;background:transparent;cursor:pointer}
    .tile iframe{position:absolute;inset:0;width:100%;height:100%;border:0;display:none}
    .tile .openers{position:absolute;right:.45rem;bottom:.45rem;display:flex;gap:.35rem;z-index:2}
    .tile .openers a{background:rgba(0,0,0,.65);color:#fff;border:1px solid rgba(255,255,255,.25);font-size:.8rem;padding:.25rem .45rem;border-radius:6px;text-decoration:none}

    /* Breath metronome */
    .breath-ui{display:grid;gap:.6rem}
    .breath-controls{display:flex;flex-wrap:wrap;gap:.45rem;align-items:center}
    .breath-controls input,.breath-controls select{background:#0b0f14;border:1px solid var(--stroke);border-radius:8px;color:var(--ink);padding:.35rem .5rem}
    .breath-visual{height:120px;border:1px dashed var(--stroke);border-radius:10px;display:grid;place-items:center;position:relative;overflow:hidden}
    .orb{width:24px;height:24px;border-radius:50%;background:var(--accent);opacity:.9;transform:scale(1);transition:transform .6s ease, opacity .6s ease}

    /* Calm sounds mixer */
    .mixer{display:grid;gap:.6rem}
    .mix-row{display:flex;gap:.6rem;align-items:center}
    .mix-row input[type="range"]{width:180px}

    /* Calm header variant */
    .site-header.calm{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border-bottom:1px solid var(--stroke)}
    .site-header.calm .main-nav a[aria-current="page"]{background:var(--calm2)}
  </style>
</head>
<body class="calm-nav">

<!-- Shared header -->
<div id="site-header"></div>
<script src="/js/header-loader.js"></script>

<!-- HERO -->
<header class="hero-mini" role="banner" aria-label="Yoga & Meditation hero">
  <figure>
    <img src="/img/yoga-meditation-hero.jpg" alt="Soft evening light with yoga mat and meditation cushion">
    <div class="overlay" aria-hidden="true"></div>
  </figure>
  <div class="content wrap">
    <h1><span class="accent">Yoga & Meditation</span></h1>
    <p>Wind down your nervous system. Practices emphasise slow nasal breathing, longer exhales, gentle holds and floor-based poses to support deep relaxation and lower stress load.</p>
  </div>
</header>

<main class="wrap">
  <p class="lead">Pick a <strong>quick reset</strong> (5–10 min), an <strong>evening unwind</strong> (20–30 min), or a <strong>deep restore</strong> (45–60 min). Use the metronome, calm sounds or optional voice guidance.</p>

  <nav class="mini-nav" aria-label="Sections">
    <a href="#quick">Quick Resets</a>
    <a href="#evening">Evening Unwind</a>
    <a href="#restore">Deep Restore</a>
    <a href="#breath">Breathing & Demos</a>
    <a href="#audio">Calm Sounds & Voice</a>
    <a href="#notes">Why this lowers stress</a>
  </nav>

  <!-- QUICK -->
  <section id="quick" class="section">
    <h2>Quick Resets (5–10 min)</h2>
    <div class="grid">
      <article class="sess">
        <h3>Desk Decompress <span class="tag">~6–8 min</span></h3>
        <ol class="steps">
          <li><strong>Box Breathing</strong> — 4-4-4-4 for <em>12 cycles</em> (≈4–5 min).</li>
          <li><strong>Seated Neck & Shoulder Melt</strong> — circles + ear-to-shoulder <em>2×20s/side</em>.</li>
          <li><strong>Standing Forward Fold</strong> — soft knees <em>60–90s</em>.</li>
        </ol>
        <p class="meta">Silent, nasal breathing. Let exhales be a touch longer.</p>
      </article>
      <article class="sess">
        <h3>Floor Unknot <span class="tag">~8–10 min</span></h3>
        <ol class="steps">
          <li><strong>Constructive Rest</strong> (on back) <em>2–3 min</em>.</li>
          <li><strong>Supine Twist</strong> <em>60–90s/side</em>, support knees.</li>
          <li><strong>Crocodile Breathing</strong> (prone) <em>3–4 min</em> of low belly breaths.</li>
        </ol>
      </article>
    </div>
  </section>

  <!-- EVENING -->
  <section id="evening" class="section">
    <h2>Evening Unwind (20–30 min)</h2>
    <div class="grid">
      <article class="sess">
        <h3>Gentle Yin Flow <span class="tag">~25 min</span></h3>
        <ol class="steps">
          <li>Child’s Pose <em>3 min</em> (bolster under chest).</li>
          <li>Cats & Cows <em>1–2 min</em> slow.</li>
          <li>Low Lunge <em>2 min/side</em> with blocks.</li>
          <li>Dragonfly (wide-leg seated fold) <em>3–4 min</em>.</li>
          <li>Supported Bridge <em>3 min</em>.</li>
          <li>Reclined Twist <em>2 min/side</em>.</li>
          <li>Legs-Up-the-Wall/Chair <em>5–7 min</em>.</li>
          <li>Savasana <em>2–3 min</em>.</li>
        </ol>
        <div class="details"><summary>Props & cues</summary>
          <ul>
            <li>Comfort over stretch; add cushions until the shape feels easy.</li>
            <li>Exhale longer: in 4, out 6–8; soften jaw and tongue.</li>
            <li>Dim light; phone on Do Not Disturb.</li>
          </ul>
        </div>
      </article>

      <article class="sess">
        <h3>Breath-Led Unwind <span class="tag">~20–22 min</span></h3>
        <ol class="steps">
          <li>4-7-8 breathing — <em>10 cycles</em> (≈4–5 min).</li>
          <li>Supported Forward Fold <em>3 min</em>.</li>
          <li>Supine Hamstring Strap <em>2 min/side</em>.</li>
          <li>Box breathing — <em>6–8 cycles</em> (≈3–4 min).</li>
          <li>Savasana body-scan <em>5–6 min</em>.</li>
        </ol>
      </article>
    </div>
  </section>

  <!-- RESTORE -->
  <section id="restore" class="section">
    <h2>Deep Restore (45–60 min)</h2>
    <div class="grid">
      <article class="sess">
        <h3>Restorative Set-Up <span class="tag">~50–60 min</span></h3>
        <ol class="steps">
          <li>Coherent breathing (in 5, out 5) <em>5–7 min</em>.</li>
          <li>Supported Child’s Pose <em>6–8 min</em>.</li>
          <li>Reclined Bound Angle (knees supported) <em>8–10 min</em>.</li>
          <li>Side-lying Heart Opener <em>6–8 min/side</em>.</li>
          <li>Legs-Up-on-Chair <em>8–10 min</em>.</li>
          <li>Yoga Nidra (guided rest) <em>10–12 min</em>.</li>
        </ol>
      </article>

      <article class="sess">
        <h3>Guided Body-Scan Script <span class="tag">voice option below</span></h3>
        <div class="details" open>
          <summary>Open script</summary>
          <p>“Let your body be heavy. Jaw unclenched, tongue resting. Breathe in through the nose … long easy exhale. Soften the brow and eyes.</p>
          <p>Right hand: thumb, index, middle, ring, little finger. Palm, back of hand, wrist. Forearm, elbow, upper arm, shoulder.</p>
          <p>Left hand the same … then across the collarbones. Chest soft on the exhale. Ribs widen and settle with the breath.</p>
          <p>Belly soft. Hips heavy. Right thigh, knee, calf, ankle, foot, toes. Left thigh, knee, calf, ankle, foot, toes.</p>
          <p>Sensing the whole body at once. Let the breath become effortless. Rest.”</p>
        </div>
      </article>
    </div>
  </section>

  <!-- BREATH + DEMOS -->
  <section id="breath" class="section">
    <h2>Breathing & Pose Demos</h2>
    <div class="grid">
      <article class="card">
        <h3>Breath Metronome</h3>
        <div class="breath-ui">
          <div class="breath-controls">
            <label>Pattern
              <select id="bm-pattern">
                <option value="coh">Coherent 5 / 5</option>
                <option value="down">Downshift 4 / 6</option>
                <option value="box">Box 4 / 4 / 4 / 4</option>
              </select>
            </label>
            <label>Minutes <input id="bm-mins" type="number" min="1" max="60" value="5"></label>
            <button id="bm-start">Start</button>
            <button id="bm-stop">Stop</button>
          </div>
          <div class="breath-visual"><div class="orb" id="orb"></div></div>
          <p class="meta">Orb grows on inhale, softens on exhale (box: holds included). Keep it gentle and quiet.</p>
        </div>
      </article>

      <article class="card">
        <h3>Demo Poses (nocookie)</h3>
        <div class="videos" id="vids"></div>
        <p class="meta">Tip: if a video is blocked, use “Open on YouTube” or “Search”.</p>
      </article>
    </div>
  </section>

  <!-- AUDIO -->
  <section id="audio" class="section">
    <h2>Calm Sounds & Optional Voice</h2>
    <div class="grid">
      <article class="card">
        <h3>Calm Sounds Mixer</h3>
        <div class="mixer">
          <div class="mix-row"><label><input type="checkbox" id="mx-rain"> Rain</label> <input type="range" id="vol-rain" min="0" max="1" step="0.01" value="0.5"></div>
          <div class="mix-row"><label><input type="checkbox" id="mx-ocean"> Ocean</label> <input type="range" id="vol-ocean" min="0" max="1" step="0.01" value="0.4"></div>
          <div class="mix-row"><label><input type="checkbox" id="mx-brown"> Brown Noise</label> <input type="range" id="vol-brown" min="0" max="1" step="0.01" value="0.3"></div>
          <div class="mix-row"><button id="mx-start">Start Audio</button><button id="mx-stop">Stop Audio</button></div>
          <p class="meta">No downloads; sounds are generated locally. Keep volume low for the most calming effect.</p>
        </div>
      </article>

      <article class="card">
        <h3>Voice Guidance (optional)</h3>
        <div class="breath-controls">
          <label>Script
            <select id="vg-script">
              <option value="scan">Body-Scan (~5 min)</option>
              <option value="coh">Coherent Breathing (~3 min)</option>
            </select>
          </label>
          <label>Voice <select id="vg-voice"></select></label>
          <label>Rate <input id="vg-rate" type="range" min="0.7" max="1.2" step="0.05" value="0.9"></label>
          <label>Pitch <input id="vg-pitch" type="range" min="0.8" max="1.2" step="0.05" value="1.0"></label>
          <button id="vg-start">Start Voice</button>
          <button id="vg-stop">Stop</button>
        </div>
        <p class="meta">Uses your browser’s speech voice. Headphones recommended.</p>
      </article>
    </div>
  </section>

  <!-- WHY -->
  <section id="notes" class="section">
    <h2>Why this lowers stress</h2>
    <div class="grid">
      <article class="card">
        <h3>Nervous system down-shift</h3>
        <ul>
          <li>Longer <em>exhales</em> and brief holds increase vagal tone, steering toward “rest & digest”.</li>
          <li>Supported shapes reduce effort → signal safety → lower sympathetic drive.</li>
          <li>Dim light, warmth, and eye cover reduce alerting input.</li>
        </ul>
      </article>
      <article class="card">
        <h3>Practical cortisol hygiene</h3>
        <ul>
          <li>Place calming sessions after stressful blocks or in the evening.</li>
          <li>Avoid high-intensity work right before bed; choose restorative or breathwork instead.</li>
          <li>Keep caffeine earlier; silence notifications during sessions.</li>
        </ul>
      </article>
    </div>
    <div class="details"><summary>Safety</summary>
      <ul>
        <li>Light-headed? Shorten holds or breathe normally.</li>
        <li>Pregnancy/low blood pressure: avoid long breath holds; prefer coherent breathing.</li>
        <li>Sharp pain ≠ normal: add props or skip the pose.</li>
      </ul>
    </div>
  </section>

  <!-- DISCLAIMER -->
  <section class="section">
    <h2>Important Note</h2>
    <p>These practices support relaxation and general wellbeing; they are not a substitute for medical care. If you have health conditions, injuries, or mental health concerns, consult a qualified professional. Stop any practice that causes pain, dizziness, or distress.</p>
  </section>
</main>

<footer class="site-footer">
  <div class="container">
    <img src="/img/freefitfuel-logo.svg" alt="FreeFitFuel Logo" height="64">
    <p>© 2025 FreeFitFuel · All rights reserved.</p>
    <p class="credit">Created by Grant Cameron Anthony</p>
  </div>
</footer>

<!-- Scripts: timers, videos, metronome, calm sounds, voice -->
<script>
/* ===== Utilities ===== */
let audioCtx, unlocked=false;
function ensureAudio(){ if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } if(audioCtx.state==='suspended'){ audioCtx.resume(); } unlocked=true; }

/* ===== Timers (simple countdown with chime) ===== */
function beepAt(t,freq,dur){
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type='sine'; o.frequency.value=freq; g.gain.value=0.0001; o.connect(g); g.connect(audioCtx.destination);
  o.start(t); g.gain.exponentialRampToValueAtTime(0.18, t+.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t+dur); o.stop(t+dur+.01);
}
function chime(){ if(!unlocked) return; const now=audioCtx.currentTime; beepAt(now+0.00,660,.14); beepAt(now+0.22,528,.14); beepAt(now+0.46,440,.22); }
function hookTimers(){
  document.querySelectorAll('[data-timer]').forEach(box=>{
    const input=box.querySelector('input'); const left=box.querySelector('.left'); let t=null,end=0;
    function fmt(s){return s+'s'} function tick(){ const remain=Math.max(0,Math.ceil((end-Date.now())/1000)); left.textContent=fmt(remain); if(remain<=0){ clearInterval(t); t=null; chime(); } }
    box.querySelector('[data-act="start"]')?.addEventListener('click',()=>{ if(!unlocked) ensureAudio(); const sec=Math.max(5,parseInt(input.value||'60',10)); left.textContent=fmt(sec); end=Date.now()+sec*1000; clearInterval(t); t=setInterval(tick,200);});
    box.querySelector('[data-act="stop"]')?.addEventListener('click',()=>{ clearInterval(t); t=null; left.textContent=fmt(Math.max(5,parseInt(input.value||'60',10)));});
  });
}

/* ===== Video tiles (nocookie or search) ===== */
const DEMOS = [
  // Provide a yt id if you have a preferred clip; otherwise it will open a search.
  {title:'Child’s Pose (Balasana)', yt:'', query:'Child’s Pose yoga form'},
  {title:'Legs-Up-the-Wall (Viparita Karani)', yt:'', query:'Legs up the wall yoga'},
  {title:'Supported Bridge', yt:'', query:'Supported bridge pose yoga'},
  {title:'Crocodile Breathing', yt:'', query:'Crocodile breathing prone diaphragmatic'}
];
function renderVideos(){
  const wrap=document.getElementById('vids'); if(!wrap) return; wrap.innerHTML='';
  DEMOS.forEach(d=>{
    const card=document.createElement('div'); card.className='tile';
    const img=document.createElement('img'); img.className='thumb';
    img.alt=d.title+' thumbnail';
    img.src='/img/placeholder-yoga.jpg'; // provide a calm placeholder; swap for custom thumbs if you like
    const overlay=document.createElement('div'); overlay.className='overlay';
    const label=document.createElement('div'); label.className='label'; label.textContent=d.title;
    const btn=document.createElement('button'); btn.className='play'; btn.setAttribute('aria-label','Play '+d.title);
    const iframe=document.createElement('iframe');
    iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
    iframe.title=d.title+' video';
    const openers=document.createElement('div'); openers.className='openers';
    const a1=document.createElement('a'); a1.textContent='Open on YouTube'; a1.target='_blank'; a1.rel='noopener';
    const a2=document.createElement('a'); a2.textContent='Search'; a2.target='_blank'; a2.rel='noopener'; a2.href='https://www.youtube.com/results?search_query='+encodeURIComponent(d.query||d.title);
    if(d.yt){
      a1.href='https://www.youtube.com/watch?v='+d.yt;
      btn.addEventListener('click',()=>{ iframe.src='https://www.youtube-nocookie.com/embed/'+d.yt+'?rel=0&modestbranding=1&autoplay=1'; iframe.style.display='block'; btn.style.display='none'; });
    }else{
      a1.href='https://www.youtube.com/results?search_query='+encodeURIComponent(d.query||d.title);
      btn.addEventListener('click',()=>{ window.open(a1.href,'_blank','noopener'); });
    }
    openers.appendChild(a1); openers.appendChild(a2);
    card.appendChild(img); card.appendChild(overlay); card.appendChild(label); card.appendChild(btn); card.appendChild(iframe); card.appendChild(openers);
    wrap.appendChild(card);
  });
}

/* ===== Breath Metronome (audio + orb) ===== */
let bmTimer=null, bmStopper=null;
function startBreathMetronome(){
  if(!unlocked) ensureAudio();
  stopBreathMetronome();
  const pattern=document.getElementById('bm-pattern').value;
  const mins=parseFloat(document.getElementById('bm-mins').value)||5;
  const orb=document.getElementById('orb');
  const schedule=[];
  if(pattern==='coh'){ schedule.push(['inhale',5],['exhale',5]); }
  if(pattern==='down'){ schedule.push(['inhale',4],['exhale',6]); }
  if(pattern==='box'){ schedule.push(['inhale',4],['hold',4],['exhale',4],['hold',4]); }

  const endTime=Date.now()+mins*60000;
  function phaseTone(type){
    const now=audioCtx.currentTime;
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='sine'; o.frequency.value=(type==='inhale'?440:(type==='exhale'?330:220));
    g.gain.value=0.0001; o.connect(g); g.connect(audioCtx.destination); o.start(now);
    g.gain.exponentialRampToValueAtTime(0.12, now+.02); g.gain.exponentialRampToValueAtTime(0.0001, now+.25); o.stop(now+.27);
  }
  function phaseVisual(type){
    if(!orb) return;
    if(type==='inhale'){ orb.style.transform='scale(1.35)'; orb.style.opacity='1'; }
    else if(type==='exhale'){ orb.style.transform='scale(0.85)'; orb.style.opacity='.8'; }
    else { /* hold */ orb.style.transform='scale(1.0)'; orb.style.opacity='.9'; }
  }
  let i=0;
  function loop(){
    if(Date.now()>=endTime){ stopBreathMetronome(); return; }
    const [type,seconds]=schedule[i%schedule.length];
    phaseTone(type); phaseVisual(type);
    bmTimer=setTimeout(loop, seconds*1000);
    i++;
  }
  loop();
  bmStopper=setTimeout(()=>stopBreathMetronome(), mins*60000+2000);
}
function stopBreathMetronome(){ if(bmTimer){ clearTimeout(bmTimer); bmTimer=null; } if(bmStopper){ clearTimeout(bmStopper); bmStopper=null; } }

/* ===== Calm Sounds (Rain / Ocean / Brown) ===== */
const mixer = { rain:null, ocean:null, brown:null, master:null, nodes:{} };
function buildNoiseNodes(){
  if(!unlocked) ensureAudio();
  const ctx=audioCtx;
  mixer.master = mixer.master || ctx.createGain(); mixer.master.gain.value=0.5; mixer.master.connect(ctx.destination);

  function whiteBuffer(){
    const buf=ctx.createBuffer(1, ctx.sampleRate*2, ctx.sampleRate);
    const data=buf.getChannelData(0);
    for(let i=0;i<data.length;i++){ data[i]=Math.random()*2-1; }
    return buf;
  }
  function makePlayer(){
    const src=ctx.createBufferSource(); src.buffer=whiteBuffer(); src.loop=true; return src;
  }

  // Rain: white -> bandpass + gentle HPF + reverb-ish via delay
  if(!mixer.rain){
    const src=makePlayer();
    const bpf=ctx.createBiquadFilter(); bpf.type='bandpass'; bpf.frequency.value=1800; bpf.Q.value=0.6;
    const hpf=ctx.createBiquadFilter(); hpf.type='highpass'; hpf.frequency.value=200;
    const gain=ctx.createGain(); gain.gain.value=0;
    const delay=ctx.createDelay(); delay.delayTime.value=0.18;
    const fb=ctx.createGain(); fb.gain.value=0.15;
    src.connect(bpf); bpf.connect(hpf); hpf.connect(gain); gain.connect(mixer.master);
    hpf.connect(delay); delay.connect(fb); fb.connect(delay); delay.connect(gain);
    mixer.rain={src,gain};
  }

  // Ocean: white -> lowpass with slow LFO
  if(!mixer.ocean){
    const src=makePlayer();
    const lpf=ctx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=400;
    const lfo=ctx.createOscillator(); lfo.frequency.value=0.07;
    const lfoGain=ctx.createGain(); lfoGain.gain.value=220; // sweep amount
    const gain=ctx.createGain(); gain.gain.value=0;
    src.connect(lpf); lpf.connect(gain); gain.connect(mixer.master);
    lfo.connect(lfoGain); lfoGain.connect(lpf.frequency);
    mixer.ocean={src,gain,lfo};
  }

  // Brown noise: integrate white
  if(!mixer.brown){
    const node = ctx.createScriptProcessor(4096,1,1);
    let lastOut=0;
    node.onaudioprocess=e=>{
      const out=e.outputBuffer.getChannelData(0);
      for(let i=0;i<out.length;i++){
        const white=Math.random()*2-1;
        lastOut=(lastOut + (0.02*white)) / 1.02;
        out[i]=lastOut*1.6;
      }
    };
    const gain=ctx.createGain(); gain.gain.value=0; node.connect(gain); gain.connect(mixer.master);
    mixer.brown={node,gain};
  }
}
function startMixer(){
  if(!unlocked) ensureAudio();
  buildNoiseNodes();

  // Start sources if not yet started
  ['rain','ocean'].forEach(k=>{
    const s=mixer[k];
    try{ s.src.start(); }catch{} // ignore if already started
    if(k==='ocean'){ try{ s.lfo.start(); }catch{} }
  });

  // Apply initial volumes from sliders
  mixer.rain.gain.gain.value = parseFloat(document.getElementById('vol-rain').value)||0.5;
  mixer.ocean.gain.gain.value = parseFloat(document.getElementById('vol-ocean').value)||0.4;
  mixer.brown.gain.gain.value = parseFloat(document.getElementById('vol-brown').value)||0.3;

  // Connect toggles
  document.getElementById('mx-rain').checked && mixer.rain.gain.connect(mixer.master) || mixer.rain.gain.disconnect();
  document.getElementById('mx-ocean').checked && mixer.ocean.gain.connect(mixer.master) || mixer.ocean.gain.disconnect();
  document.getElementById('mx-brown').checked && mixer.brown.gain.connect(mixer.master) || mixer.brown.gain.disconnect();
}
function stopMixer(){
  if(!audioCtx) return;
  try{ mixer.master.disconnect(); }catch{}
  // leave context alive; user can restart
}

/* Slider & toggle wiring */
function hookMixerUI(){
  const ids=[['mx-rain','vol-rain','rain'],['mx-ocean','vol-ocean','ocean'],['mx-brown','vol-brown','brown']];
  ids.forEach(([chk,vol,key])=>{
    document.getElementById(chk).addEventListener('change',()=>{
      if(!unlocked) ensureAudio(); buildNoiseNodes();
      if(document.getElementById(chk).checked){ mixer[key].gain.connect(mixer.master); }
      else { try{ mixer[key].gain.disconnect(); }catch{} }
    });
    document.getElementById(vol).addEventListener('input',()=>{
      if(!unlocked) ensureAudio(); buildNoiseNodes();
      mixer[key].gain.gain.value=parseFloat(document.getElementById(vol).value)||0.3;
    });
  });
  document.getElementById('mx-start').addEventListener('click',startMixer);
  document.getElementById('mx-stop').addEventListener('click',stopMixer);
}

/* ===== Voice Guidance (Speech Synthesis) ===== */
let voices=[];
function loadVoices(){
  voices = window.speechSynthesis?.getVoices()||[];
  const sel=document.getElementById('vg-voice'); if(!sel) return;
  sel.innerHTML='';
  voices.forEach((v,i)=>{ const o=document.createElement('option'); o.value=String(i); o.textContent=v.name+' ('+v.lang+')'; sel.appendChild(o); });
}
if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged = loadVoices; }
function speakScript(kind){
  if(!('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  const rate=parseFloat(document.getElementById('vg-rate').value)||0.9;
  const pitch=parseFloat(document.getElementById('vg-pitch').value)||1.0;
  const voiceIndex=parseInt(document.getElementById('vg-voice').value||'0',10);
  const voice=voices[voiceIndex]||null;

  const lines = (kind==='coh')
    ? [
        'Find a comfortable seat or lie down. Close your eyes if safe.',
        'We will breathe in for five, and out for five. Let it be easy.',
        'In, two, three, four, five. Out, two, three, four, five.',
        'In, two, three, four, five. Out, two, three, four, five.',
        'Keep going gently. Shoulders soft. Jaw relaxed.',
        'If your mind wanders, return to the next inhale.',
        'Last few cycles. Soften the exhale. Let it be quiet.',
        'Release the count and rest naturally.'
      ]
    : [
        'Lie down and allow the body to be heavy.',
        'Soften the forehead and the space around the eyes.',
        'Bring attention to the right hand, from thumb to little finger, then wrist and forearm.',
        'The right elbow, upper arm, and shoulder. Let them settle.',
        'Left hand, fingers, wrist, forearm, elbow, upper arm, shoulder.',
        'Across the collarbones. Chest softens on the exhale.',
        'Belly soft. Hips heavy. Right leg down to the toes.',
        'Left leg down to the toes.',
        'Sense the whole body at once. Breathe quietly and rest.'
      ];
  let i=0;
  function sayNext(){
    if(i>=lines.length) return;
    const u=new SpeechSynthesisUtterance(lines[i]); u.rate=rate; u.pitch=patchPitch(pitch); if(voice) u.voice=voice;
    u.onend=()=>{ setTimeout(()=>{ i++; sayNext(); }, 1200); };
    window.speechSynthesis.speak(u);
  }
  function patchPitch(p){ return Math.max(0.5, Math.min(2, p)); }
  sayNext();
}
function stopVoice(){ if('speechSynthesis' in window){ window.speechSynthesis.cancel(); } }

/* ===== Boot ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  hookTimers();
  renderVideos();
  hookMixerUI();
  loadVoices();

  // Breath metronome buttons
  document.getElementById('bm-start').addEventListener('click', startBreathMetronome);
  document.getElementById('bm-stop').addEventListener('click', stopBreathMetronome);

  // Voice buttons
  document.getElementById('vg-start').addEventListener('click', ()=> speakScript(document.getElementById('vg-script').value));
  document.getElementById('vg-stop').addEventListener('click', stopVoice);
});
</script>
</body>
</html>
