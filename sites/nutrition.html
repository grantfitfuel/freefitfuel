<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nutrition – FreeFitFuel</title>

  <link rel="stylesheet" href="style.css?v=27">
  <link rel="icon" type="image/svg+xml" href="img/freefitfuel-logo.svg">

  <style>
    /* Page-only additions */
    .wrap{max-width:var(--maxw);margin:0 auto;padding:18px 20px}
    .lead{color:var(--inkdim)}

    .hero-mini{position:relative;border-bottom:1px solid #1b1b22}
    .hero-mini figure{margin:0;position:relative}
    .hero-mini img{width:100%;height:46vh;min-height:320px;object-fit:cover;display:block;filter:brightness(.88) saturate(1.05);object-position:center 35%}
    .hero-mini .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.65))}
    .hero-mini .content{position:absolute;inset:auto 0 0 0;padding:16px 20px 22px;max-width:var(--maxw);margin:0 auto}
    .hero-mini h1{margin:0 0 .35rem}
    .hero-mini p{max-width:70ch;margin:.2rem 0 0;color:#d0d0da}
     .rec-actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.6rem}
.btn-budget,.btn-add-plan{background:rgba(255,255,255,.1);border:1px solid var(--stroke);color:var(--ink);border-radius:10px;padding:.45rem .7rem;cursor:pointer}
.btn-budget.active{background:#1f7a1f;border-color:#2aa32a;color:#fff}
    .toolbar{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;margin:1rem 0 1.1rem}
    .seg{display:inline-flex;border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
    .seg button{background:var(--glass);color:var(--ink);border:0;padding:.45rem .85rem;cursor:pointer}
    .seg button[aria-pressed="true"]{background:var(--accent);color:#111;font-weight:800}
    .pill{display:inline-flex;align-items:center;gap:.35rem;background:var(--glass);border:1px solid var(--stroke);border-radius:999px;padding:.35rem .65rem;font-size:.92rem}
    .pill input{accent-color:var(--accent)}

    .section{background:var(--glass);border:1px solid var(--stroke);border-radius:14px;margin:12px 0;padding:14px}
    .section>h2{margin:.15rem 0 .45rem;font-size:1.2rem}
    .note{font-size:.92rem;color:var(--inkdim)}

    .grid{display:grid;gap:14px}
    @media(min-width:900px){.cols-2{grid-template-columns:1.1fr 1fr}}
    @media(min-width:980px){.cols-3{grid-template-columns:repeat(3,1fr)}}

    /* Calculator */
    .calc{display:grid;gap:.6rem}
    .calc .row{display:flex;flex-wrap:wrap;gap:.6rem}
    .calc label{display:flex;flex-direction:column;gap:.25rem;font-size:.92rem}
    .calc input,.calc select{
      background:#0b0f14;color:var(--ink);border:1px solid var(--stroke);
      border-radius:8px;padding:.5rem .55rem;min-width:120px
    }
    .calc .btn{padding:.55rem .8rem;border-radius:8px;background:var(--accent);color:#111;border:0;font-weight:800;cursor:pointer}
    .calc .out{margin-top:.35rem;color:var(--inkdim)}
    .results{display:grid;gap:.45rem;margin-top:.5rem}
    .kpi{background:#111418;border:1px solid var(--stroke);border-radius:10px;padding:.55rem .7rem}
    .kpi strong{display:block;font-size:1.05rem}
    .bar{height:10px;border-radius:999px;background:#0b0f14;border:1px solid var(--stroke);overflow:hidden}
    .bar span{display:block;height:100%;background:var(--accent);width:0%}

    /* Filters & recipes */
    .filters{display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:.6rem}
    .filters .tag{background:rgba(255,255,255,.08);border:1px solid var(--stroke);border-radius:999px;padding:.2rem .55rem;font-size:.85rem;cursor:pointer}
    .filters .tag.active{background:var(--accent);color:#111;font-weight:800;border-color:transparent}

    .card{background:#111418;border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
    .card figure{margin:0;position:relative}
    .card img{width:100%;height:180px;object-fit:cover;display:block}
    .card .body{padding:.75rem .9rem}
    .badge{background:rgba(255,255,255,.08);border:1px solid var(--stroke);border-radius:999px;padding:.16rem .5rem;font-size:.78rem;margin-right:.35rem}
    .macros{display:flex;gap:.6rem;margin-top:.35rem;font-size:.9rem;color:#c9c9d4}
    .allergens{font-size:.86rem;color:#cfcfe0;margin-top:.25rem}
    .actions{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.5rem}
    .actions .btn{padding:.4rem .6rem;border-radius:8px}

    /* Planner */
    .planner{display:grid;gap:.8rem}
    .planner table{width:100%;border-collapse:collapse}
    .planner th,.planner td{border:1px solid var(--stroke);padding:.5rem .6rem;vertical-align:top}
    .planner th{background:rgba(255,255,255,.06)}
    .slot{min-height:52px;background:#0b0f14;border-radius:6px;padding:.35rem}
    .slot .item{display:flex;justify-content:space-between;gap:.5rem;background:#141820;border:1px solid var(--stroke);border-radius:6px;padding:.3rem .5rem;margin:.25rem 0}
    .slot .item button{border:0;background:transparent;color:#bbb;cursor:pointer}
    .planner .controls{display:flex;gap:.5rem;flex-wrap:wrap}

    /* Food log */
    .log{display:grid;gap:.6rem}
    .log .row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
    .log input,.log select{
      background:#0b0f14;color:var(--ink);border:1px solid var(--stroke);
      border-radius:8px;padding:.45rem .55rem
    }
    .progress{display:grid;gap:.35rem}
    .progress .line{display:grid;grid-template-columns:100px 1fr min-content;gap:.6rem;align-items:center}
    .progress .line .bar{height:12px}

    /* Mobile balance: make goal explanation less dominant */
    @media (max-width:540px){ .goal-explain{font-size:.92rem} }
  </style>
</head>
<body>

<!-- HEADER (same as home) -->
<header class="site-header">
  <div class="container">
    <a href="index.html" class="logo"><img src="img/freefitfuel-logo.svg" alt="FreeFitFuel Logo" height="56"></a>
    <button class="hamburger" aria-label="Open menu" aria-controls="primary-nav" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
    <nav id="primary-nav" class="main-nav" aria-label="Primary">
      <a href="index.html">Home</a>
      <a href="ideas.html">Ideas</a>
      <a href="guides.html">Guides</a>
      <a href="workouts.html">Workouts</a>
      <a href="endurance.html">Endurance</a>
      <a href="nutrition.html" aria-current="page">Nutrition</a>
      <a href="wellbeing.html">Wellbeing</a>
      <a href="contact.html">Contact</a>
    </nav>
  </div>
</header>

<!-- HERO -->
<header class="hero-mini" role="banner" aria-label="Nutrition hero">
  <figure>
    <img src="img/nutrition-hero.jpg" alt="Budget-friendly, colourful whole foods on a table">
    <div class="overlay" aria-hidden="true"></div>
  </figure>
  <div class="content wrap">
    <h1><span class="accent">Fuel for real life</span></h1>
    <p>Goal-based macros, budget swaps, a planner that builds your shopping list, and a day log that tracks towards your targets.</p>
  </div>
</header>

<main class="wrap">
  <p class="lead">Pick a <strong>goal</strong>, calculate your <strong>targets</strong> (BMR → TDEE), then add meals to the <strong>planner</strong> and <strong>daily log</strong>. Toggle <strong>Budget</strong> to favour low-cost options. All data saves on this device.</p>

  <!-- Global controls -->
  <div class="toolbar" aria-label="Nutrition controls">
    <div class="seg" role="tablist" aria-label="Goal">
      <button role="tab" aria-pressed="true"  data-goal="maintain">Maintain</button>
      <button role="tab" aria-pressed="false" data-goal="cut">Cut</button>
      <button role="tab" aria-pressed="false" data-goal="build">Build</button>
      <button role="tab" aria-pressed="false" data-goal="transform">Transform</button>
    </div>
    <span class="pill"><input type="checkbox" id="budget"> <label for="budget">Budget mode</label></span>
  </div>

  <!-- Goal meanings -->
  <section class="section goal-explain">
    <h2>What the goals mean</h2>
    <div class="grid cols-2">
      <article class="kpi"><strong>Maintain</strong> Keep weight steady. Calories ≈ TDEE. Protein high enough to preserve muscle; flexible carbs/fats.</article>
      <article class="kpi"><strong>Cut</strong> Gentle fat loss. Calories ≈ TDEE − 10–20%. Higher protein & fibre to keep you fuller; carbs timed around training.</article>
      <article class="kpi"><strong>Build (Bulk)</strong> Muscle gain. Calories ≈ TDEE + 5–15%. Prioritise protein + carbs; steady surplus with progressive training.</article>
      <article class="kpi"><strong>Transform</strong> Recomp: small deficit/surplus depending on the day; keep protein high; focus on veg, sleep & steps.</article>
    </div>
  </section>

  <!-- Calculator -->
  <section class="section">
    <h2>Macro & Calorie Calculator</h2>
    <div class="grid cols-2">
      <div class="calc card" style="padding:12px">
        <div class="row">
          <label>Sex
            <select id="sex"><option value="female">Female</option><option value="male">Male</option></select>
          </label>
          <label>Age <input id="age" type="number" min="13" max="99" value="35"></label>
          <label>Height (cm) <input id="cm" type="number" min="120" max="220" value="175"></label>
          <label>Weight (kg) <input id="kg" type="number" min="35" max="250" value="75"></label>
          <label>Activity
            <select id="act">
              <option value="1.2">Sedentary</option>
              <option value="1.375">Light (1–3x/wk)</option>
              <option value="1.55" selected>Moderate (3–5x)</option>
              <option value="1.725">Active (6–7x)</option>
              <option value="1.9">Very active</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label>Protein (g/kg) <input id="pkk" type="number" step="0.1" value="1.8"></label>
          <label>Carb bias
            <select id="carbBias">
              <option value="balanced" selected>Balanced</option>
              <option value="lowerCarb">Lower carb</option>
              <option value="higherCarb">Higher carb</option>
            </select>
          </label>
          <label><input type="checkbox" id="knowbf"> I know body fat %</label>
          <label id="bfWrap" class="hidden">Body fat % <input id="bf" type="number" min="3" max="60" step="0.5" value="20"></label>
        </div>
        <div class="row">
          <button class="btn" id="calcBtn">Calculate</button>
          <span id="calcNote" class="out">Uses Mifflin–St Jeor (or Katch–McArdle if body fat is provided), then adjusts by activity and goal.</span>
        </div>
      </div>
      <div class="results">
        <div class="kpi"><strong id="outGoal">Maintain</strong><span id="outCals">— kcal / day</span></div>
        <div class="kpi"><strong>Protein</strong><span id="outP">— g</span><div class="bar"><span id="barP"></span></div></div>
        <div class="kpi"><strong>Carbs</strong><span id="outC">— g</span><div class="bar"><span id="barC"></span></div></div>
        <div class="kpi"><strong>Fats</strong><span id="outF">— g</span><div class="bar"><span id="barF"></span></div></div>
        <div class="note">Fibre: aim ~25–35 g/day. Hydration helper below.</div>
      </div>
    </div>
  </section>

  <!-- Recipes -->
  <section class="section" id="recipes">
    <h2>Recipe Library</h2>
    <div class="filters" id="recipeFilters" aria-label="Recipe filters">
      <button class="tag" data-tag="budget">Budget</button>
      <button class="tag" data-tag="high-protein">High-Protein</button>
      <button class="tag" data-tag="gluten-free">Gluten-Free</button>
      <button class="tag" data-tag="dairy-free">Dairy-Free</button>
      <button class="tag" data-tag="veg">Vegetarian</button>
      <button class="tag" data-tag="vegan">Vegan</button>
      <button class="tag" data-tag="quick">Quick (≤20m)</button>
      <button class="tag" data-tag="batch">Batch-cook</button>
      <button class="tag" data-tag="world">World cuisines</button>
      <button class="tag" data-tag="simple">Simple</button>
    </div>

    <div class="grid cols-3" id="recipeGrid"></div>
    <p class="note">Allergens are listed on every card (check labels for specific products & cross-contamination). Nutrition values are estimates.</p>
  </section>

  <!-- Weekly Planner -->
  <section class="section" id="planner">
    <h2>Weekly Meal Planner</h2>
    <p class="note">Click “＋ Planner” on any recipe to slot it into the week. Your plan saves on this device.</p>
    <div class="planner">
      <div class="controls">
        <button class="btn" id="clearPlan">Clear week</button>
        <button class="btn" id="printList">Print shopping list</button>
        <button class="btn" id="csvList">Download CSV</button>
      </div>
      <table>
        <thead><tr><th>Day</th><th>Breakfast</th><th>Lunch</th><th>Dinner</th><th>Snacks</th></tr></thead>
        <tbody id="planBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Food Log (per day) -->
  <section class="section" id="foodlog">
    <h2>Daily Food Log</h2>
    <div class="log">
      <div class="row">
        <label>Date <input type="date" id="logDate"></label>
        <button class="btn" id="addCustom">＋ Custom item</button>
        <button class="btn" id="clearLog">Clear day</button>
        <button class="btn" id="exportLog">Export CSV</button>
      </div>
      <div id="logItems"></div>
      <div class="progress">
        <div class="line"><strong>Calories</strong><div class="bar"><span id="pbCal"></span></div><span id="txCal">0 / 0</span></div>
        <div class="line"><strong>Protein</strong> <div class="bar"><span id="pbProt"></span></div><span id="txProt">0 / 0</span></div>
        <div class="line"><strong>Carbs</strong>   <div class="bar"><span id="pbCarb"></span></div><span id="txCarb">0 / 0</span></div>
        <div class="line"><strong>Fats</strong>    <div class="bar"><span id="pbFat"></span></div><span id="txFat">0 / 0</span></div>
      </div>
      <p class="note">Tip: log meals first, then tweak snacks to hit your targets.</p>
    </div>
  </section>

  <!-- Hydration & fibre -->
  <section class="section">
    <h2>Hydration & Fibre</h2>
    <div class="grid cols-2">
      <article class="card" style="padding:.8rem">
        <h3>Hydration helper</h3>
        <div class="calc">
          <div class="row">
            <label>Body weight (kg) <input id="h-kg" type="number" min="35" max="250" value="75"></label>
            <label>Extra per hour training (ml) <input id="h-train" type="number" min="0" step="50" value="400"></label>
          </div>
          <div class="row">
            <button class="btn" id="h-calc">Calculate</button>
            <span class="out" id="h-out">— ml / day</span>
          </div>
        </div>
        <p class="note">Rule of thumb: ~30–35 ml/kg + ~300–600 ml per training hour. Adjust to heat & thirst.</p>
      </article>
      <article class="card" style="padding:.8rem">
        <h3>Fibre targets</h3>
        <p>Aim 25–35 g/day from foods. Increase gradually with fluids to avoid gut discomfort.</p>
        <ul><li>Oats/porridge, wholegrains</li><li>Beans/lentils/chickpeas</li><li>Fruit (berries), veg, nuts/seeds</li></ul>
      </article>
    </div>
  </section>

  <!-- Disclaimer -->
  <section class="section">
    <h2>Important Note</h2>
    <p>The content on FreeFitFuel is for general nutrition education only and isn’t a substitute for personalised medical advice. If you have a medical condition (e.g., diabetes, kidney disease, IBS), allergies, or take medications, speak to a qualified professional before making major changes.</p>
  </section>
</main>

<footer class="site-footer">
  <div class="container">
    <img src="img/freefitfuel-logo.svg" alt="FreeFitFuel Logo" height="64">
    <p>© 2025 FreeFitFuel · All rights reserved.</p>
    <p class="credit">Created by Grant Cameron Anthony</p>
  </div>
</footer>

<!-- Minimal JS (no external deps) -->
<script>
/* Header burger */
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.querySelector('.hamburger');
  const nav = document.querySelector('.main-nav');
  if(btn && nav){
    btn.addEventListener('click', () => {
      const open = btn.classList.toggle('active');
      nav.classList.toggle('open', open);
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
    });
  }
});

/* ====== STATE ====== */
let goal = 'maintain';
let budgetMode = false;

document.querySelectorAll('[data-goal]').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('[data-goal]').forEach(x=>x.setAttribute('aria-pressed','false'));
    b.setAttribute('aria-pressed','true');
    goal = b.dataset.goal;
    document.getElementById('outGoal').textContent = goal[0].toUpperCase()+goal.slice(1);
    if(window.lastCalc){ doCalc(); updateLogBars(); }
  });
});
document.getElementById('budget').addEventListener('change', e=>{ budgetMode = e.target.checked; renderRecipes(); });

/* ====== CALCULATOR ====== */
const bfWrap = document.getElementById('bfWrap');
document.getElementById('knowbf').addEventListener('change', e=>{
  bfWrap.classList.toggle('hidden', !e.target.checked);
});

function mifflin(kg, cm, age, sex){
  return 10*kg + 6.25*cm - 5*age + (sex==='male'?5:-161);
}
function katch(kg, bfPerc){
  const lbm = kg * (1 - bfPerc/100);
  return 370 + 21.6 * lbm;
}
function clampTargets(cals, bmr){
  // keep target reasonable: not below 1.2×BMR for most cases (safety floor),
  // and not above BMR+1000 unless bulking hard.
  const floor = Math.round(bmr * 1.2);
  const ceil  = Math.round(bmr + 1000);
  return Math.max(floor, Math.min(ceil, Math.round(cals)));
}
function adjustForGoal(cals){
  switch(goal){
    case 'cut': return cals*0.85;         // ~15% deficit
    case 'build': return cals*1.10;       // ~10% surplus
    case 'transform': return cals*0.95;   // slight deficit
    default: return cals;
  }
}
function splitCarbFat(remainCals, bias){
  let fatK = 0.5, carbK = 0.5;
  if(bias==='lowerCarb'){ fatK = 0.6; carbK = 0.4; }
  if(bias==='higherCarb'){ fatK = 0.35; carbK = 0.65; }
  const fat = Math.round((remainCals * fatK) / 9);
  const carb = Math.round((remainCals * carbK) / 4);
  return {fat, carb};
}
let targets = {cal:0,p:0,c:0,f:0};
let lastCalc=false;

function doCalc(){
  const sex = document.getElementById('sex').value;
  const age = +document.getElementById('age').value||0;
  const cm  = +document.getElementById('cm').value||0;
  const kg  = +document.getElementById('kg').value||0;
  const act = +document.getElementById('act').value||1.55;
  const pkk = +document.getElementById('pkk').value||1.8;
  const bias= document.getElementById('carbBias').value;
  const know= document.getElementById('knowbf').checked;
  const bf  = +document.getElementById('bf').value||20;

  const bmr = know ? katch(kg,bf) : mifflin(kg,cm,age,sex);
  const tdee = bmr * act;
  const pre  = adjustForGoal(tdee);
  const cal  = clampTargets(pre, bmr);

  const p = Math.round(kg * pkk);
  const pCals = p*4;
  const remain = Math.max(0, cal - pCals);
  const {fat:f, carb:c} = splitCarbFat(remain, bias);

  targets = {cal:Math.round(cal), p, c, f};
  lastCalc=true; localStorage.setItem('fff-targets', JSON.stringify({goal,targets}));

  document.getElementById('outCals').textContent = targets.cal+' kcal / day';
  document.getElementById('outP').textContent = targets.p+' g';
  document.getElementById('outC').textContent = targets.c+' g';
  document.getElementById('outF').textContent = targets.f+' g';
  setBar('barP',100); setBar('barC',100); setBar('barF',100); // static bars for targets panel
  updateLogBars();
}
document.getElementById('calcBtn').addEventListener('click', doCalc);

/* Hydration */
document.getElementById('h-calc').addEventListener('click', ()=>{
  const kg = +document.getElementById('h-kg').value||0;
  const extra = +document.getElementById('h-train').value||0;
  const base = kg * 32; // 30–35 ml/kg midpoint
  document.getElementById('h-out').textContent = Math.round(base + extra)+' ml / day';
});

/* ====== RECIPES DATA ======
   Each recipe: k, name, cuisine, tags[], allergens[], img, servings, macros{kcal,p,c,f}, adds[], ingredients[{qty,unit,item}], steps[] */
const RECIPES = [
  // Simple & UK-friendly
  <!-- inside each recipe card footer/actions -->
<div class="rec-actions">
  <button class="btn-budget" data-k="{{k}}">£ Budget swap</button>
  <button class="btn-add-plan" data-k="{{k}}">Add to Planner</button>
</div>
  {k:'oats-pro', name:'Protein Oats & Berries', cuisine:'UK', tags:['budget','high-protein','veg','quick','simple'], allergens:['gluten (oats*)','dairy*'], img:'img/recipes/oats.jpg', servings:1,
    macros:{kcal:420,p:28,c:55,f:10},
    adds:['oats','milk or alt','protein powder','frozen berries','chia'],
    ingredients:[{qty:60,unit:'g',item:'oats'},{qty:200,unit:'ml',item:'semi-skimmed milk (or alt)'},{qty:25,unit:'g',item:'whey/plant protein'},{qty:80,unit:'g',item:'frozen berries'},{qty:10,unit:'g',item:'chia seeds'}],
    steps:['Heat oats with milk to desired thickness.','Stir in protein off heat.','Top with berries and chia.']},
  {k:'beans-toast', name:'Beans on Toast + Egg', cuisine:'UK', tags:['budget','veg','quick','simple'], allergens:['gluten (bread)','egg'], img:'img/recipes/beans.jpg', servings:1,
    macros:{kcal:480,p:28,c:60,f:14}, adds:['baked beans','wholemeal bread','egg','spinach'],
    ingredients:[{qty:1,unit:'tin',item:'baked beans'},{qty:2,unit:'slices',item:'wholemeal bread'},{qty:1,unit:'',item:'egg'},{qty:30,unit:'g',item:'spinach'}],
    steps:['Warm beans.','Toast bread.','Pan-fry or poach egg.','Layer toast, beans, spinach, egg.']},
  {k:'yoghurt-bowl', name:'Greek Yoghurt Bowl', cuisine:'Mediterranean', tags:['high-protein','quick','simple'], allergens:['dairy'], img:'img/recipes/yoghurt.jpg', servings:1,
    macros:{kcal:350,p:30,c:35,f:8}, adds:['greek yoghurt','banana','honey','mixed seeds'],
    ingredients:[{qty:200,unit:'g',item:'greek yoghurt'},{qty:1,unit:'',item:'banana'},{qty:1,unit:'tsp',item:'honey'},{qty:15,unit:'g',item:'mixed seeds'}],
    steps:['Bowl yoghurt.','Slice banana.','Top with honey and seeds.']},
  {k:'tuna-rice', name:'Tuna Rice Bowl', cuisine:'Global', tags:['budget','high-protein','gluten-free','quick','simple'], allergens:['fish','egg*'], img:'img/recipes/tuna.jpg', servings:1,
    macros:{kcal:520,p:38,c:65,f:10}, adds:['tinned tuna','rice','sweetcorn','peas','light mayo'],
    ingredients:[{qty:130,unit:'g',item:'cooked rice'},{qty:1,unit:'tin',item:'tuna (drained)'},{qty:60,unit:'g',item:'sweetcorn'},{qty:60,unit:'g',item:'peas'},{qty:15,unit:'g',item:'light mayo'}],
    steps:['Mix tuna with veg and mayo.','Serve over hot rice.']},

  // Batch / budget plant-based
  {k:'lentil-pot', name:'One-Pot Lentil Stew', cuisine:'Global', tags:['budget','vegan','gluten-free','batch','simple'], allergens:[], img:'img/recipes/lentils.jpg', servings:4,
    macros:{kcal:520,p:26,c:80,f:10}, adds:['red lentils','tinned tomatoes','carrots','onion','stock'],
    ingredients:[{qty:300,unit:'g',item:'red lentils'},{qty:2,unit:'tins',item:'chopped tomatoes'},{qty:2,unit:'',item:'carrots (diced)'},{qty:1,unit:'',item:'onion (diced)'},{qty:800,unit:'ml',item:'veg stock'}],
    steps:['Soften onion/carrots.','Add lentils, tomatoes, stock.','Simmer 20–25 min until soft.']},

  // World flavours
  {k:'chana', name:'Chana Masala', cuisine:'Indian', tags:['vegan','budget','world','gluten-free','batch'], allergens:[], img:'img/recipes/chana.jpg', servings:4,
    macros:{kcal:430,p:18,c:65,f:10}, adds:['chickpeas','onion','garlic','ginger','tomatoes','spices'],
    ingredients:[{qty:2,unit:'tins',item:'chickpeas (drained)'},{qty:1,unit:'',item:'onion (diced)'},{qty:2,unit:'cloves',item:'garlic (minced)'},{qty:1,unit:'tbsp',item:'ginger (grated)'},{qty:1,unit:'tin',item:'tomatoes'},{qty:1,unit:'tbsp',item:'garam masala'}],
    steps:['Sauté onion/garlic/ginger.','Add spices, tomatoes, chickpeas.','Simmer 15–20 min.']},
  {k:'teriyaki', name:'Teriyaki Chicken Rice Bowl', cuisine:'Japanese', tags:['high-protein','world','quick'], allergens:['soy','gluten*','sesame*'], img:'img/recipes/teriyaki.jpg', servings:2,
    macros:{kcal:560,p:38,c:70,f:12}, adds:['chicken thigh','soy sauce','mirin/sugar','rice','spring onion'],
    ingredients:[{qty:300,unit:'g',item:'chicken thigh (chunks)'},{qty:3,unit:'tbsp',item:'soy sauce'},{qty:2,unit:'tbsp',item:'mirin or 1 tbsp sugar'},{qty:260,unit:'g',item:'cooked rice'},{qty:2,unit:'',item:'spring onions'}],
    steps:['Brown chicken.','Add soy + mirin; reduce to glaze.','Serve on rice with spring onion.']},
  {k:'shakshuka', name:'Shakshuka', cuisine:'Middle Eastern', tags:['veg','world','gluten-free','simple'], allergens:['egg'], img:'img/recipes/shakshuka.jpg', servings:3,
    macros:{kcal:360,p:20,c:28,f:17}, adds:['eggs','peppers','onion','garlic','tomatoes','spices'],
    ingredients:[{qty:1,unit:'',item:'onion (sliced)'},{qty:2,unit:'',item:'peppers (sliced)'},{qty:2,unit:'cloves',item:'garlic'},{qty:1,unit:'tin',item:'tomatoes'},{qty:4,unit:'',item:'eggs'},{qty:1,unit:'tsp',item:'paprika/cumin'}],
    steps:['Soften veg with spices.','Add tomatoes; simmer.','Make wells; crack eggs; cover until set.']},
  {k:'thai-green', name:'Thai Green Curry (Chicken or Tofu)', cuisine:'Thai', tags:['world','gluten-free'], allergens:['soy*','fish*'], img:'img/recipes/thaigreen.jpg', servings:4,
    macros:{kcal:520,p:32,c:55,f:18}, adds:['green curry paste','coconut milk','chicken or tofu','veg','rice'],
    ingredients:[{qty:2,unit:'tbsp',item:'green curry paste'},{qty:1,unit:'tin',item:'coconut milk'},{qty:400,unit:'g',item:'chicken breast or firm tofu'},{qty:400,unit:'g',item:'mixed veg'},{qty:600,unit:'g',item:'cooked rice'}],
    steps:['Fry paste; add protein & veg.','Pour coconut milk; simmer 10 min.','Serve with rice.']},
  {k:'pasta-peas', name:'Pea & Pesto Pasta', cuisine:'Italian', tags:['veg','quick','world','simple'], allergens:['gluten (pasta)','nuts*','dairy*'], img:'img/recipes/pasta.jpg', servings:2,
    macros:{kcal:520,p:22,c:78,f:12}, adds:['pasta','peas','pesto','parmesan'],
    ingredients:[{qty:180,unit:'g',item:'pasta'},{qty:150,unit:'g',item:'peas'},{qty:2,unit:'tbsp',item:'pesto'},{qty:20,unit:'g',item:'parmesan'}],
    steps:['Boil pasta; add peas last 2–3 min.','Drain; stir through pesto & cheese.']},
  {k:'mex-bowl', name:'Mexican Bean Burrito Bowl', cuisine:'Mexican', tags:['vegan','world','budget','gluten-free','batch'], allergens:[], img:'img/recipes/mexbowl.jpg', servings:4,
    macros:{kcal:540,p:22,c:85,f:12}, adds:['rice','black beans','sweetcorn','tomatoes','spices'],
    ingredients:[{qty:600,unit:'g',item:'cooked rice'},{qty:2,unit:'tins',item:'black beans'},{qty:1,unit:'tin',item:'sweetcorn'},{qty:2,unit:'',item:'tomatoes (diced)'},{qty:2,unit:'tsp',item:'chilli/cumin'}],
    steps:['Warm beans with spices.','Serve over rice with toppings.']},
  {k:'jerk', name:'Jerk Chicken & Rice', cuisine:'Caribbean', tags:['world','high-protein'], allergens:[], img:'img/recipes/jerk.jpg', servings:3,
    macros:{kcal:600,p:42,c:65,f:16}, adds:['chicken','jerk seasoning','rice','peas (kidney beans)','spring onion'],
    ingredients:[{qty:500,unit:'g',item:'chicken thigh'},{qty:2,unit:'tbsp',item:'jerk seasoning'},{qty:450,unit:'g',item:'cooked rice'},{qty:1,unit:'tin',item:'kidney beans'},{qty:3,unit:'',item:'spring onions'}],
    steps:['Marinate chicken; roast or grill.','Fold beans & onion through rice; serve.']},
  {k:'bibimbap', name:'Bibimbap (beef or tofu)', cuisine:'Korean', tags:['world','high-protein'], allergens:['soy','sesame','gluten*'], img:'img/recipes/bibimbap.jpg', servings:2,
    macros:{kcal:620,p:35,c:82,f:16}, adds:['rice','beef mince or tofu','carrot','spinach','egg','soy','sesame'],
    ingredients:[{qty:260,unit:'g',item:'cooked rice'},{qty:250,unit:'g',item:'beef mince or tofu'},{qty:1,unit:'',item:'carrot (matchsticks)'},{qty:60,unit:'g',item:'spinach'},{qty:2,unit:'',item:'eggs'},{qty:2,unit:'tbsp',item:'soy'}],
    steps:['Cook rice.','Stir-fry toppings separately.','Assemble bowl; top with egg.']},
  {k:'menemen', name:'Menemen (Turkish eggs & peppers)', cuisine:'Turkish', tags:['veg','world','quick','simple'], allergens:['egg'], img:'img/recipes/menemen.jpg', servings:2,
    macros:{kcal:380,p:22,c:18,f:24}, adds:['eggs','tomatoes','peppers','onion','olive oil'],
    ingredients:[{qty:1,unit:'',item:'onion (sliced)'},{qty:2,unit:'',item:'peppers (sliced)'},{qty:2,unit:'',item:'tomatoes (diced)'},{qty:4,unit:'',item:'eggs'},{qty:1,unit:'tbsp',item:'olive oil'}],
    steps:['Soften onion/peppers in oil.','Add tomatoes; reduce.','Stir in beaten eggs till just set.']},

  // Protein-forward mains
  {k:'chilli-batch', name:'Turkey (or Bean) Chilli', cuisine:'US', tags:['high-protein','batch','gluten-free','world'], allergens:[], img:'img/recipes/chilli.jpg', servings:4,
    macros:{kcal:540,p:40,c:55,f:14}, adds:['turkey mince or beans','kidney beans','tomatoes','spices','onion'],
    ingredients:[{qty:500,unit:'g',item:'turkey mince (or beans for vegan)'},{qty:1,unit:'tin',item:'kidney beans'},{qty:1,unit:'tin',item:'tomatoes'},{qty:1,unit:'',item:'onion (diced)'},{qty:2,unit:'tsp',item:'chilli powder'}],
    steps:['Brown mince with onion.','Add tomatoes/beans/spices; simmer 20 min.']},
  {k:'fish-pot', name:'Smoked Fish & Potato Bake', cuisine:'UK', tags:['gluten-free','simple'], allergens:['fish','dairy'], img:'img/recipes/fish.jpg', servings:3,
    macros:{kcal:560,p:36,c:55,f:18}, adds:['smoked fish','potatoes','leeks','milk','cheese'],
    ingredients:[{qty:400,unit:'g',item:'smoked fish (flaked)'},{qty:600,unit:'g',item:'potatoes (sliced)'},{qty:1,unit:'',item:'leek (sliced)'},{qty:250,unit:'ml',item:'milk'},{qty:40,unit:'g',item:'cheese'}],
    steps:['Parboil potatoes.','Layer with fish/leeks; add milk/cheese.','Bake till tender & golden.']},
  {k:'pho-quick', name:'Quick Pho (cheat stock)', cuisine:'Vietnamese', tags:['world','gluten-free','simple'], allergens:['soy*'], img:'img/recipes/pho.jpg', servings:2,
    macros:{kcal:500,p:28,c:80,f:10}, adds:['rice noodles','stock','five-spice','beef or tofu','herbs'],
    ingredients:[{qty:160,unit:'g',item:'rice noodles'},{qty:800,unit:'ml',item:'good stock'},{qty:1,unit:'tsp',item:'five-spice'},{qty:200,unit:'g',item:'beef slices or tofu'},{qty:1,unit:'handful',item:'herbs/bean sprouts'}],
    steps:['Simmer stock with spice.','Poach protein; add noodles.','Top with herbs.']},
  {k:'tagine', name:'Moroccan Chickpea Tagine', cuisine:'Moroccan', tags:['vegan','world','batch','gluten-free'], allergens:[], img:'img/recipes/tagine.jpg', servings:4,
    macros:{kcal:480,p:20,c:75,f:10}, adds:['chickpeas','apricots','carrot','onion','spices','couscous*'],
    ingredients:[{qty:2,unit:'tins',item:'chickpeas'},{qty:80,unit:'g',item:'dried apricots (chopped)'},{qty:2,unit:'',item:'carrots (chunks)'},{qty:1,unit:'',item:'onion'},{qty:2,unit:'tsp',item:'ras el hanout'}],
    steps:['Sauté onion/spices.','Add veg/fruit/legumes + water; simmer 20–25 min.']},
  {k:'tortilla', name:'Spanish Tortilla', cuisine:'Spanish', tags:['veg','world','simple','gluten-free'], allergens:['egg'], img:'img/recipes/tortilla.jpg', servings:4,
    macros:{kcal:420,p:20,c:35,f:20}, adds:['eggs','potatoes','onion','olive oil'],
    ingredients:[{qty:8,unit:'',item:'eggs'},{qty:500,unit:'g',item:'potatoes (thin sliced)'},{qty:1,unit:'',item:'onion (sliced)'},{qty:2,unit:'tbsp',item:'olive oil'}],
    steps:['Pan-cook potatoes/onion in oil.','Add beaten eggs; cook gently; flip or grill to set.']},
  {k:'greek-salad', name:'Greek Salad + Beans', cuisine:'Greek', tags:['veg','gluten-free','quick','world','simple'], allergens:['dairy'], img:'img/recipes/greek.jpg', servings:2,
    macros:{kcal:420,p:18,c:30,f:24}, adds:['tomatoes','cucumber','olives','feta','mixed beans'],
    ingredients:[{qty:3,unit:'',item:'tomatoes'},{qty:1,unit:'',item:'cucumber'},{qty:60,unit:'g',item:'olives'},{qty:80,unit:'g',item:'feta'},{qty:1,unit:'tin',item:'mixed beans (drained)'}],
    steps:['Chop veg; toss with olives/beans.','Crumble feta on top.']},
  {k:'wrap-chicken', name:'Chicken, Hummus & Crunch Wrap', cuisine:'Global', tags:['high-protein','quick','simple'], allergens:['gluten (wrap)','sesame'], img:'img/recipes/wrap.jpg', servings:1,
    macros:{kcal:520,p:35,c:50,f:18}, adds:['wrap','chicken','hummus','lettuce','tomato'],
    ingredients:[{qty:1,unit:'',item:'wrap'},{qty:120,unit:'g',item:'cooked chicken'},{qty:40,unit:'g',item:'hummus'},{qty:2,unit:'leaves',item:'lettuce'},{qty:2,unit:'slices',item:'tomato'}],
    steps:['Spread hummus, add chicken & veg, wrap tightly.']}
  // === EXTRA RECIPES PACK ===
RECIPES = RECIPES.concat([
  /* --- Breakfasts & Quick Bites --- */
  {k:'overnight-oats', name:'Overnight Oats (PB & Banana)', cuisine:'UK', tags:['budget','veg','quick','simple'], allergens:['gluten (oats*)','peanuts*','dairy*'], img:'img/recipes/overnight-oats.jpg', servings:1,
    macros:{kcal:420,p:20,c:55,f:14},
    adds:['oats','milk or alt','peanut butter','banana'],
    ingredients:[{qty:60,unit:'g',item:'oats'},{qty:180,unit:'ml',item:'milk (or alt)'},{qty:1,unit:'tbsp',item:'peanut butter'},{qty:1,unit:'',item:'banana (sliced)'}],
    steps:['Combine oats & milk in jar.','Top with PB & banana.','Chill overnight.']},

  {k:'egg-muffins', name:'Veggie Egg Muffins', cuisine:'UK', tags:['high-protein','gluten-free','quick','simple'], allergens:['egg','dairy*'], img:'img/recipes/egg-muffins.jpg', servings:3,
    macros:{kcal:260,p:22,c:6,f:16},
    adds:['eggs','mixed veg','cheese*'],
    ingredients:[{qty:6,unit:'',item:'eggs'},{qty:1,unit:'cup',item:'mixed veg (chopped)'},{qty:30,unit:'g',item:'grated cheese*'}],
    steps:['Beat eggs; fold veg & cheese.','Bake in muffin tin 15–18 min @180°C.']},

  {k:'smoothie-green', name:'Green Protein Smoothie', cuisine:'Global', tags:['quick','high-protein','gluten-free','simple'], allergens:['dairy*'], img:'img/recipes/green-smoothie.jpg', servings:1,
    macros:{kcal:330,p:30,c:40,f:6},
    adds:['protein powder','spinach','frozen mango','yoghurt or alt','water'],
    ingredients:[{qty:25,unit:'g',item:'protein powder'},{qty:1,unit:'handful',item:'spinach'},{qty:150,unit:'g',item:'frozen mango'},{qty:100,unit:'g',item:'greek yoghurt (or alt)'},{qty:150,unit:'ml',item:'water'}],
    steps:['Blend until smooth.']},

  /* --- Sandwiches / Light Meals --- */
  {k:'tuna-sweetcorn-sand', name:'Tuna & Sweetcorn Sandwich (light mayo)', cuisine:'UK', tags:['budget','simple','quick','high-protein'], allergens:['fish','gluten (bread)','egg*'], img:'img/recipes/tuna-sweetcorn.jpg', servings:1,
    macros:{kcal:430,p:28,c:48,f:12},
    adds:['wholemeal bread','tuna','sweetcorn','light mayo'],
    ingredients:[{qty:2,unit:'slices',item:'wholemeal bread'},{qty:1,unit:'tin',item:'tuna (drained)'},{qty:50,unit:'g',item:'sweetcorn'},{qty:15,unit:'g',item:'light mayo'}],
    steps:['Mix tuna, corn, mayo.','Assemble sandwich.']},

  {k:'falafel-wrap', name:'Falafel Hummus Wrap', cuisine:'Middle Eastern', tags:['vegan','world','quick','simple'], allergens:['gluten (wrap)','sesame'], img:'img/recipes/falafel-wrap.jpg', servings:1,
    macros:{kcal:520,p:16,c:68,f:18},
    adds:['wrap','falafel','hummus','lettuce','tomato','onion'],
    ingredients:[{qty:1,unit:'',item:'wrap'},{qty:4,unit:'',item:'falafel'},{qty:40,unit:'g',item:'hummus'},{qty:2,unit:'leaves',item:'lettuce'},{qty:2,unit:'slices',item:'tomato'},{qty:2,unit:'rings',item:'onion'}],
    steps:['Warm wrap & falafel.','Spread hummus; add veg/falafel; roll.']},

  /* --- Hearty Bowls --- */
  {k:'salmon-rice-bowl', name:'Salmon Rice Bowl', cuisine:'Japanese', tags:['high-protein','gluten-free','world','simple'], allergens:['fish','soy*','sesame*'], img:'img/recipes/salmon-bowl.jpg', servings:1,
    macros:{kcal:610,p:38,c:65,f:18},
    adds:['salmon','rice','soy or tamari','edamame*','cucumber'],
    ingredients:[{qty:150,unit:'g',item:'salmon fillet'},{qty:150,unit:'g',item:'cooked rice'},{qty:1,unit:'tbsp',item:'soy/tamari'},{qty:60,unit:'g',item:'edamame (optional)'},{qty:0.5,unit:'',item:'cucumber (sliced)'}],
    steps:['Pan-cook salmon.','Serve over rice with toppings & soy.']},

  {k:'kimchi-fried-rice', name:'Kimchi Fried Rice (egg or tofu)', cuisine:'Korean', tags:['world','quick','simple'], allergens:['egg*','soy*','sesame*','gluten*'], img:'img/recipes/kimchi-rice.jpg', servings:2,
    macros:{kcal:520,p:18,c:78,f:14},
    adds:['rice','kimchi','egg or tofu','spring onion'],
    ingredients:[{qty:300,unit:'g',item:'cooked rice (day-old ideal)'},{qty:150,unit:'g',item:'kimchi (chopped)'},{qty:2,unit:'',item:'eggs or 200 g tofu'},{qty:2,unit:'',item:'spring onions'}],
    steps:['Stir-fry kimchi; add rice; push aside & scramble egg / add tofu.','Combine; season.']},

  /* --- Batch Curries, Stews & Soups --- */
  {k:'dhal', name:'Red Lentil Dhal', cuisine:'Indian', tags:['vegan','budget','batch','gluten-free','world'], allergens:[], img:'img/recipes/dhal.jpg', servings:4,
    macros:{kcal:460,p:24,c:70,f:10},
    adds:['red lentils','onion','garlic','turmeric','cumin','stock'],
    ingredients:[{qty:300,unit:'g',item:'red lentils'},{qty:1,unit:'',item:'onion (diced)'},{qty:2,unit:'cloves',item:'garlic (minced)'},{qty:1,unit:'tsp',item:'turmeric'},{qty:1,unit:'tsp',item:'cumin'},{qty:900,unit:'ml',item:'veg stock'}],
    steps:['Rinse lentils.','Simmer all 18–22 min till creamy; season.']},

  {k:'tomato-soup', name:'Roasted Tomato & Basil Soup', cuisine:'Italian', tags:['veg','budget','gluten-free','simple','batch'], allergens:[], img:'img/recipes/tomato-soup.jpg', servings:4,
    macros:{kcal:210,p:6,c:30,f:8},
    adds:['tomatoes','onion','garlic','basil','stock'],
    ingredients:[{qty:1,unit:'kg',item:'tomatoes'},{qty:1,unit:'',item:'onion'},{qty:3,unit:'cloves',item:'garlic'},{qty:600,unit:'ml',item:'veg stock'},{qty:1,unit:'handful',item:'basil'}],
    steps:['Roast tomatoes/onion/garlic 25m.','Blend with stock & basil.']},

  {k:'minestrone', name:'Minestrone (beans & pasta)', cuisine:'Italian', tags:['veg','world','budget','simple','batch'], allergens:['gluten (pasta)'], img:'img/recipes/minestrone.jpg', servings:6,
    macros:{kcal:360,p:16,c:60,f:6},
    adds:['mixed veg','beans','tomatoes','pasta','stock'],
    ingredients:[{qty:2,unit:'cups',item:'mixed veg (chopped)'},{qty:2,unit:'tins',item:'beans (cannellini/kidney)'},{qty:1,unit:'tin',item:'tomatoes'},{qty:120,unit:'g',item:'small pasta'},{qty:1,unit:'L',item:'veg stock'}],
    steps:['Simmer veg/stock 10m.','Add beans, pasta; cook to al dente.']},

  {k:'pho-chicken', name:'Chicken Pho (simple)', cuisine:'Vietnamese', tags:['world','gluten-free','high-protein','simple'], allergens:['soy*','fish*'], img:'img/recipes/pho-chicken.jpg', servings:2,
    macros:{kcal:520,p:35,c:80,f:8},
    adds:['rice noodles','stock','chicken','spices (five-spice/anise)','herbs'],
    ingredients:[{qty:160,unit:'g',item:'rice noodles'},{qty:800,unit:'ml',item:'chicken stock'},{qty:250,unit:'g',item:'chicken breast (sliced)'},{qty:1,unit:'tsp',item:'five-spice'},{qty:1,unit:'handful',item:'herbs/bean sprouts'}],
    steps:['Simmer stock + spice.','Poach chicken; add noodles; top herbs.']},

  /* --- Sheet-pan / One-pan --- */
  {k:'sheet-chicken', name:'Sheet-Pan Chicken & Veg', cuisine:'Global', tags:['high-protein','simple','batch','gluten-free'], allergens:[], img:'img/recipes/sheet-chicken.jpg', servings:4,
    macros:{kcal:490,p:42,c:38,f:16},
    adds:['chicken thighs','potatoes','carrots','onion','spice mix'],
    ingredients:[{qty:800,unit:'g',item:'chicken thighs'},{qty:600,unit:'g',item:'potatoes (chunks)'},{qty:2,unit:'',item:'carrots (chunks)'},{qty:1,unit:'',item:'onion (wedges)'},{qty:2,unit:'tbsp',item:'spice mix'}],
    steps:['Toss all on tray; roast 35–40m @200°C, turn once.']},

  {k:'sausage-tray', name:'Sausage, Apple & Onion Traybake', cuisine:'UK', tags:['simple','budget'], allergens:['gluten*','sulphites*'], img:'img/recipes/sausage-tray.jpg', servings:4,
    macros:{kcal:560,p:24,c:60,f:22},
    adds:['sausages','apples','onion','potatoes'],
    ingredients:[{qty:8,unit:'',item:'sausages'},{qty:3,unit:'',item:'apples (wedges)'},{qty:2,unit:'',item:'onions (wedges)'},{qty:600,unit:'g',item:'potatoes (chunks)'}],
    steps:['Tray everything with oil/salt/pepper; roast 35–40m @200°C.']},

  /* --- Fish & Seafood --- */
  {k:'prawn-stirfry', name:'Garlic Prawn Stir-fry & Rice', cuisine:'Asian', tags:['high-protein','quick','gluten-free'], allergens:['crustaceans','soy*','sesame*'], img:'img/recipes/prawn-stirfry.jpg', servings:2,
    macros:{kcal:520,p:34,c:74,f:8},
    adds:['prawns','veg mix','soy/tamari','rice'],
    ingredients:[{qty:250,unit:'g',item:'prawns'},{qty:300,unit:'g',item:'mixed stir-fry veg'},{qty:2,unit:'tbsp',item:'soy/tamari'},{qty:300,unit:'g',item:'cooked rice'}],
    steps:['Stir-fry prawns, add veg, sauce; serve with rice.']},

  {k:'tuna-pasta', name:'Tuna Sweetcorn Pasta', cuisine:'UK', tags:['budget','high-protein','simple'], allergens:['fish','gluten (pasta)','dairy*'], img:'img/recipes/tuna-pasta.jpg', servings:3,
    macros:{kcal:560,p:32,c:78,f:12},
    adds:['pasta','tuna','sweetcorn','yoghurt or light mayo'],
    ingredients:[{qty:300,unit:'g',item:'pasta'},{qty:2,unit:'tins',item:'tuna (drained)'},{qty:1,unit:'tin',item:'sweetcorn'},{qty:120,unit:'g',item:'greek yoghurt / light mayo'}],
    steps:['Boil pasta; fold through tuna, corn, yoghurt; season.']},

  /* --- Meat / Protein mains --- */
  {k:'beef-stirfry', name:'Beef & Broccoli Stir-fry', cuisine:'Chinese', tags:['high-protein','world','quick'], allergens:['soy','gluten*','sesame*'], img:'img/recipes/beef-broccoli.jpg', servings:2,
    macros:{kcal:580,p:40,c:60,f:16},
    adds:['beef strips','broccoli','soy/ginger/garlic','rice'],
    ingredients:[{qty:300,unit:'g',item:'beef strips'},{qty:300,unit:'g',item:'broccoli florets'},{qty:2,unit:'tbsp',item:'soy sauce'},{qty:1,unit:'tsp',item:'ginger/garlic'}],
    steps:['Sear beef; remove. Stir-fry broccoli; return beef with sauce. Serve rice.']},

  {k:'turkey-meatballs', name:'Turkey Meatballs in Tomato Sauce', cuisine:'Italian', tags:['high-protein','batch','simple'], allergens:['egg*','gluten*'], img:'img/recipes/turkey-meatballs.jpg', servings:4,
    macros:{kcal:520,p:42,c:48,f:16},
    adds:['turkey mince','egg*','breadcrumbs*','tomatoes','garlic'],
    ingredients:[{qty:500,unit:'g',item:'turkey mince'},{qty:1,unit:'',item:'egg* (optional)'},{qty:40,unit:'g',item:'breadcrumbs* (or oats)'},{qty:2,unit:'tins',item:'tomatoes'},{qty:2,unit:'cloves',item:'garlic'}],
    steps:['Mix, roll balls, brown.','Simmer 15m in tomatoes.']},

  /* --- Veg & Vegan mains --- */
  {k:'tofu-stirfry', name:'Crispy Tofu Veg Stir-fry', cuisine:'Asian', tags:['vegan','world','quick','simple'], allergens:['soy'], img:'img/recipes/tofu-stirfry.jpg', servings:2,
    macros:{kcal:520,p:28,c:60,f:16},
    adds:['firm tofu','stir-fry veg','soy/tamari','rice or noodles*'],
    ingredients:[{qty:300,unit:'g',item:'firm tofu (pressed, cubed)'},{qty:300,unit:'g',item:'stir-fry veg'},{qty:2,unit:'tbsp',item:'soy/tamari'},{qty:300,unit:'g',item:'cooked rice/noodles*'}],
    steps:['Crisp tofu in pan.','Add veg; finish with sauce; serve.']},

  {k:'stuffed-peppers', name:'Stuffed Peppers (rice & beans)', cuisine:'Mediterranean', tags:['veg','vegan','gluten-free','simple'], allergens:[], img:'img/recipes/stuffed-peppers.jpg', servings:4,
    macros:{kcal:440,p:16,c:72,f:10},
    adds:['peppers','rice','beans','tomatoes','cheese*'],
    ingredients:[{qty:4,unit:'',item:'peppers (halved)'},{qty:400,unit:'g',item:'cooked rice'},{qty:1,unit:'tin',item:'beans'},{qty:1,unit:'tin',item:'tomatoes'},{qty:40,unit:'g',item:'cheese* (optional)'}],
    steps:['Bake peppers 10m.','Fill with mix; bake 15m more.']},

  {k:'sweet-pot-chickpea', name:'Sweet Potato & Chickpea Tray', cuisine:'Global', tags:['vegan','budget','gluten-free','simple','batch'], allergens:[], img:'img/recipes/sweetpot-chickpea.jpg', servings:4,
    macros:{kcal:480,p:16,c:78,f:12},
    adds:['sweet potato','chickpeas','spices','greens'],
    ingredients:[{qty:800,unit:'g',item:'sweet potatoes (chunks)'},{qty:2,unit:'tins',item:'chickpeas (drained)'},{qty:2,unit:'tsp',item:'spice mix'},{qty:120,unit:'g',item:'greens (spinach/kale)'}],
    steps:['Roast potatoes & chickpeas 30m @200°C.','Toss through greens to wilt.']},

  /* --- Salads / Bowls --- */
  {k:'nicoise', name:'Tuna Niçoise Salad (easy)', cuisine:'French', tags:['gluten-free','simple','high-protein','world'], allergens:['fish','egg'], img:'img/recipes/nicoise.jpg', servings:2,
    macros:{kcal:520,p:36,c:40,f:22},
    adds:['tuna','new potatoes','eggs','green beans','olives'],
    ingredients:[{qty:2,unit:'',item:'eggs'},{qty:300,unit:'g',item:'new potatoes'},{qty:150,unit:'g',item:'green beans'},{qty:1,unit:'tin',item:'tuna'},{qty:40,unit:'g',item:'olives'}],
    steps:['Boil potatoes/eggs; steam beans.','Assemble with tuna/olives; dress.']},

  {k:'bulgur-feta', name:'Bulgur, Feta & Chickpea Bowl', cuisine:'Mediterranean', tags:['veg','world','simple'], allergens:['gluten (bulgur)','dairy'], img:'img/recipes/bulgur-feta.jpg', servings:3,
    macros:{kcal:520,p:20,c:74,f:14},
    adds:['bulgur','chickpeas','feta','tomatoes','cucumber','herbs'],
    ingredients:[{qty:240,unit:'g',item:'bulgur (cooked weight ~600 g)'},{qty:1,unit:'tin',item:'chickpeas'},{qty:120,unit:'g',item:'feta'},{qty:2,unit:'',item:'tomatoes'},{qty:0.5,unit:'',item:'cucumber'}],
    steps:['Cook bulgur; toss with chopped veg, feta, herbs.']},

  /* --- Air-fryer / Oven Hacks --- */
  {k:'air-chicken', name:'Air-Fryer Chicken & Greens', cuisine:'Global', tags:['high-protein','simple','quick','gluten-free'], allergens:[], img:'img/recipes/air-chicken.jpg', servings:2,
    macros:{kcal:480,p:46,c:14,f:24},
    adds:['chicken breast','broccoli','oil','spice mix'],
    ingredients:[{qty:2,unit:'',item:'chicken breasts'},{qty:300,unit:'g',item:'broccoli'},{qty:1,unit:'tbsp',item:'oil'},{qty:1,unit:'tbsp',item:'spice mix'}],
    steps:['Air-fry chicken ~12–15m @190°C.','Toss broccoli 8–10m; season.']},

  {k:'air-tofu', name:'Air-Fryer Tofu Nuggets', cuisine:'Global', tags:['vegan','gluten-free','simple','quick'], allergens:['soy'], img:'img/recipes/air-tofu.jpg', servings:2,
    macros:{kcal:420,p:28,c:30,f:18},
    adds:['firm tofu','cornflour','spices','dip'],
    ingredients:[{qty:400,unit:'g',item:'firm tofu (pressed, cubed)'},{qty:2,unit:'tbsp',item:'cornflour'},{qty:1,unit:'tsp',item:'paprika/garlic powder'},{qty:2,unit:'tbsp',item:'dip (yoghurt or vegan)'}],
    steps:['Coat tofu in cornflour + spices.','Air-fry 12–15m @190°C, shake halfway.']},

  /* --- Sides & Carb Bases --- */
  {k:'rice-coconut', name:'Coconut Rice', cuisine:'Asian', tags:['world','simple','gluten-free'], allergens:[], img:'img/recipes/coconut-rice.jpg', servings:4,
    macros:{kcal:330,p:6,c:58,f:8},
    adds:['rice','coconut milk','water','salt'],
    ingredients:[{qty:300,unit:'g',item:'rice (rinsed)'},{qty:200,unit:'ml',item:'coconut milk'},{qty:300,unit:'ml',item:'water'},{qty:0.5,unit:'tsp',item:'salt'}],
    steps:['Simmer covered 12m; rest 10m; fluff.']},

  {k:'roast-veg', name:'Roast Veg Mix', cuisine:'Global', tags:['vegan','simple','gluten-free','batch','budget'], allergens:[], img:'img/recipes/roast-veg.jpg', servings:4,
    macros:{kcal:160,p:4,c:28,f:4},
    adds:['root veg mix','oil','herbs/spices'],
    ingredients:[{qty:800,unit:'g',item:'mixed veg (carrot, parsnip, peppers, courgette)'},{qty:1,unit:'tbsp',item:'oil'},{qty:1,unit:'tsp',item:'herbs/spices'}],
    steps:['Roast 25–30m @200°C; season.']},

  /* --- Vegetarian Proteins --- */
  {k:'paneer-peas', name:'Paneer & Peas Curry', cuisine:'Indian', tags:['veg','world','high-protein','simple'], allergens:['dairy'], img:'img/recipes/paneer-peas.jpg', servings:3,
    macros:{kcal:560,p:32,c:36,f:30},
    adds:['paneer','peas','tomatoes','spices'],
    ingredients:[{qty:300,unit:'g',item:'paneer (cubed)'},{qty:200,unit:'g',item:'peas'},{qty:1,unit:'tin',item:'tomatoes'},{qty:1,unit:'tbsp',item:'curry powder'}],
    steps:['Brown paneer; add peas, tomatoes, spices; simmer 10m.']},

  {k:'quorn-chilli', name:'Quorn (or Bean) Chilli', cuisine:'UK', tags:['veg','budget','batch','high-protein'], allergens:['egg* (some quorn)'], img:'img/recipes/quorn-chilli.jpg', servings:4,
    macros:{kcal:480,p:32,c:60,f:10},
    adds:['quorn mince or beans','kidney beans','tomatoes','spices'],
    ingredients:[{qty:300,unit:'g',item:'quorn mince (or 2 tins beans)'},{qty:1,unit:'tin',item:'kidney beans'},{qty:1,unit:'tin',item:'tomatoes'},{qty:2,unit:'tsp',item:'chilli powder'}],
    steps:['Simmer everything 15–20m; season.']},

  /* --- World Favourites --- */
  {k:'yakisoba', name:'Chicken Yakisoba (noodle stir-fry)', cuisine:'Japanese', tags:['world','quick'], allergens:['gluten (noodles)','soy','sesame*'], img:'img/recipes/yakisoba.jpg', servings:2,
    macros:{kcal:580,p:32,c:86,f:12},
    adds:['wheat noodles','chicken','cabbage','soy/worcestershire*'],
    ingredients:[{qty:250,unit:'g',item:'noodles (cooked)'},{qty:250,unit:'g',item:'chicken strips'},{qty:200,unit:'g',item:'cabbage/carrot mix'},{qty:2,unit:'tbsp',item:'yaki sauce (soy/worcestershire*)'}],
    steps:['Stir-fry chicken; add veg & noodles; sauce to finish.']},

  {k:'shredded-chicken-tacos', name:'Shredded Chicken Tacos', cuisine:'Mexican', tags:['world','high-protein','quick'], allergens:['gluten* (tortillas)'], img:'img/recipes/chicken-tacos.jpg', servings:3,
    macros:{kcal:520,p:38,c:56,f:14},
    adds:['tortillas','chicken','spice mix','salsa','lettuce'],
    ingredients:[{qty:6,unit:'',item:'small tortillas'},{qty:450,unit:'g',item:'cooked shredded chicken'},{qty:1,unit:'tbsp',item:'taco spice'},{qty:1,unit:'cup',item:'salsa'},{qty:2,unit:'leaves',item:'lettuce (shredded)'}],
    steps:['Warm chicken with spice.','Fill tortillas with chicken, lettuce, salsa.']},

  {k:'dhansak', name:'Chicken or Lentil Dhansak', cuisine:'Parsi/Indian', tags:['world','batch'], allergens:[], img:'img/recipes/dhansak.jpg', servings:4,
    macros:{kcal:540,p:34,c:62,f:14},
    adds:['chicken or lentils','pumpkin/squash','tomatoes','spices'],
    ingredients:[{qty:400,unit:'g',item:'chicken thigh (or 250 g lentils)'},{qty:300,unit:'g',item:'pumpkin/squash (diced)'},{qty:1,unit:'tin',item:'tomatoes'},{qty:1,unit:'tbsp',item:'dhansak spice or curry powder'}],
    steps:['Simmer all 25–30m until tender.']},

  {k:'harissa-bowl', name:'Harissa Chickpea Grain Bowl', cuisine:'North African', tags:['vegan','world','simple'], allergens:['gluten* (some grains)'], img:'img/recipes/harissa-bowl.jpg', servings:3,
    macros:{kcal:520,p:18,c:78,f:14},
    adds:['grain (couscous/bulgur/quinoa)','chickpeas','harissa','veg'],
    ingredients:[{qty:450,unit:'g',item:'cooked grain'},{qty:1,unit:'tin',item:'chickpeas'},{qty:1,unit:'tbsp',item:'harissa'},{qty:1,unit:'cup',item:'mixed veg (roasted/steamed)'}],
    steps:['Toss grain with harissa; top with chickpeas & veg.']},

  /* --- Light & Fresh --- */
  {k:'shrimp-avocado', name:'Prawn & Avocado Salad', cuisine:'Global', tags:['gluten-free','quick','simple'], allergens:['crustaceans'], img:'img/recipes/prawn-avocado.jpg', servings:2,
    macros:{kcal:420,p:26,c:16,f:26},
    adds:['prawns','avocado','greens','citrus dressing'],
    ingredients:[{qty:250,unit:'g',item:'prawns (cooked)'},{qty:1,unit:'',item:'ripe avocado'},{qty:2,unit:'cups',item:'mixed greens'},{qty:1,unit:'tbsp',item:'lemon juice + oil'}],
    steps:['Toss everything; season.']},

  {k:'caprese-chicken', name:'Caprese Chicken (skillet)', cuisine:'Italian', tags:['high-protein','gluten-free','quick'], allergens:['dairy'], img:'img/recipes/caprese-chicken.jpg', servings:2,
    macros:{kcal:520,p:46,c:16,f:26},
    adds:['chicken breast','tomatoes','mozzarella','basil','balsamic'],
    ingredients:[{qty:2,unit:'',item:'chicken breasts'},{qty:2,unit:'',item:'tomatoes (sliced)'},{qty:100,unit:'g',item:'mozzarella'},{qty:1,unit:'handful',item:'basil'},{qty:1,unit:'tsp',item:'balsamic'}],
    steps:['Pan-cook chicken; top with tomato, mozzarella; cover to melt; basil & balsamic to finish.']},

  /* --- Comfort / Classic --- */
  {k:'shepherds-lite', name:'Shepherd’s Pie (lighter)', cuisine:'UK', tags:['batch','simple'], allergens:['gluten*','dairy'], img:'img/recipes/shepherds-pie.jpg', servings:4,
    macros:{kcal:560,p:36,c:58,f:18},
    adds:['lean mince or lentils','onion','carrot','peas','potatoes'],
    ingredients:[{qty:500,unit:'g',item:'lean lamb/beef mince (or 300 g lentils)'},{qty:1,unit:'',item:'onion'},{qty:2,unit:'',item:'carrots'},{qty:150,unit:'g',item:'peas'},{qty:700,unit:'g',item:'potatoes'}],
    steps:['Cook filling; top with mash; bake till golden.']},

  {k:'stirfry-udon', name:'Veg Udon Stir-fry', cuisine:'Japanese', tags:['veg','world','quick','simple'], allergens:['gluten (udon)','soy','sesame*'], img:'img/recipes/udon.jpg', servings:2,
    macros:{kcal:540,p:16,c:92,f:10},
    adds:['udon noodles','veg','soy/ginger/garlic'],
    ingredients:[{qty:400,unit:'g',item:'udon noodles (cooked)'},{qty:300,unit:'g',item:'stir-fry veg'},{qty:2,unit:'tbsp',item:'soy sauce'},{qty:1,unit:'tsp',item:'ginger/garlic'}],
    steps:['Stir-fry veg; add noodles & sauce; toss hot.']},

  /* --- Sweet / Snacks --- */
  {k:'baked-oats', name:'Baked Oats (1-pan)', cuisine:'UK', tags:['veg','budget','simple'], allergens:['gluten (oats*)','dairy*','egg*'], img:'img/recipes/baked-oats.jpg', servings:2,
    macros:{kcal:380,p:18,c:56,f:10},
    adds:['oats','milk','egg*','banana','baking powder'],
    ingredients:[{qty:100,unit:'g',item:'oats (blended fine)'} ,{qty:200,unit:'ml',item:'milk'},{qty:1,unit:'',item:'egg* (or flax egg)'},{qty:1,unit:'',item:'banana (mashed)'},{qty:0.5,unit:'tsp',item:'baking powder'}],
    steps:['Mix, pour into dish; bake 18–20m @180°C.']},

  {k:'chia-pudding', name:'Chia Pudding (2-ingredient)', cuisine:'Global', tags:['vegan','gluten-free','simple','quick'], allergens:['dairy*'], img:'img/recipes/chia.jpg', servings:2,
    macros:{kcal:280,p:10,c:24,f:14},
    adds:['chia seeds','milk or alt','sweetener*'],
    ingredients:[{qty:40,unit:'g',item:'chia seeds'},{qty:300,unit:'ml',item:'milk (or alt)'},{qty:1,unit:'tsp',item:'honey/syrup (optional)'}],
    steps:['Stir chia + milk; rest 10m; stir; chill until set.']},

  /* --- Extras for athletes --- */
  {k:'pasta-tuna-peas', name:'Endurance Carb Load: Pasta Tuna & Peas', cuisine:'UK', tags:['high-protein','world','simple'], allergens:['gluten (pasta)','fish','dairy*'], img:'img/recipes/pasta-tuna-peas.jpg', servings:3,
    macros:{kcal:660,p:36,c:100,f:12},
    adds:['pasta','tuna','peas','yoghurt or light mayo'],
    ingredients:[{qty:360,unit:'g',item:'pasta'},{qty:2,unit:'tins',item:'tuna'},{qty:180,unit:'g',item:'peas'},{qty:150,unit:'g',item:'greek yoghurt / light mayo'}],
    steps:['Boil pasta; fold through tuna/peas/yoghurt; season.']},

  {k:'rice-chicken-ez', name:'Simple Rice & Chicken (prep box)', cuisine:'Global', tags:['high-protein','batch','gluten-free','simple'], allergens:[], img:'img/recipes/rice-chicken.jpg', servings:4,
    macros:{kcal:520,p:40,c:62,f:10},
    adds:['rice','chicken breast','spice mix','veg'],
    ingredients:[{qty:600,unit:'g',item:'cooked rice'},{qty:600,unit:'g',item:'chicken breast (cubed)'},{qty:1,unit:'tbsp',item:'spice mix'},{qty:400,unit:'g',item:'mixed veg (steamed)'}],
    steps:['Grill/pan chicken with spice.','Serve with rice & veg.']},

  /* --- Desserts / Treats (balanced) --- */
  {k:'yoghurt-parfait', name:'Yoghurt Parfait (berry & granola)', cuisine:'Global', tags:['veg','quick','simple'], allergens:['dairy','gluten* (granola)'], img:'img/recipes/parfait.jpg', servings:2,
    macros:{kcal:320,p:18,c:40,f:8},
    adds:['greek yoghurt','berries','granola'],
    ingredients:[{qty:300,unit:'g',item:'greek yoghurt'},{qty:150,unit:'g',item:'berries'},{qty:60,unit:'g',item:'granola'}],
    steps:['Layer yoghurt, berries, granola in glasses.']},

  {k:'banana-ice', name:'One-Ingredient Banana Ice Cream', cuisine:'Global', tags:['vegan','gluten-free','simple','quick'], allergens:[], img:'img/recipes/banana-ice.jpg', servings:2,
    macros:{kcal:180,p:3,c:42,f:0},
    adds:['ripe bananas'],
    ingredients:[{qty:3,unit:'',item:'ripe bananas (frozen in chunks)'}],
    steps:['Blend frozen banana until creamy; serve immediately.']}
]);
];

const budgetSwaps = {
  'greek yoghurt':'plain yoghurt',
  'mixed seeds':'sunflower seeds',
  'frozen berries':'seasonal fruit',
  'tuna':'mackerel (tinned)',
  'rice':'oats or potatoes',
  'parmesan':'cheddar',
  'pesto':'olive oil + herbs',
  'chicken thigh':'chicken drumsticks or beans',
  'beef mince':'turkey mince or lentils'
};

/* ====== RECIPES UI ====== */
function recipeCard(r){
  const tags = r.tags.map(t=>`<span class="badge">${t}</span>`).join('');
  const m = r.macros;
  const allerg = r.allergens.length ? `Allergens: ${r.allergens.join(', ')} (check labels)` : 'Allergens: none listed (check labels)';
  return `
  <article class="card" data-tags="${r.tags.join(',')}">
    <figure><img src="${r.img}" alt="${r.name}" onerror="this.style.display='none'"></figure>
    <div class="body">
      <h3>${r.name}</h3>
      <div>${tags} <span class="badge">${r.cuisine}</span></div>
      <div class="macros">
        <span>⚡ ${m.kcal} kcal</span>
        <span>🥩 ${m.p}g</span>
        <span>🍚 ${m.c}g</span>
        <span>🫒 ${m.f}g</span>
      </div>
      <div class="allergens">${allerg}</div>
      <div class="actions">
        <button class="btn" data-planner="${r.k}">＋ Planner</button>
        <button class="btn" data-log="${r.k}">＋ Log 1 serving</button>
        <button class="btn" data-print="${r.k}">🖨 Print card</button>
      </div>
    </div>
  </article>`;
}

function renderRecipes(){
  const grid = document.getElementById('recipeGrid');
  const active = [...document.querySelectorAll('.filters .tag.active')].map(x=>x.dataset.tag);
  const list = RECIPES.filter(r => active.length===0 || active.every(t=>r.tags.includes(t)));
  grid.innerHTML = list.map(recipeCard).join('');

  grid.querySelectorAll('[data-planner]').forEach(b=>b.addEventListener('click', ()=> addToPlanner(b.getAttribute('data-planner')) ));
  grid.querySelectorAll('[data-log]').forEach(b=>b.addEventListener('click', ()=> logRecipeServing(b.getAttribute('data-log'), 1) ));
  grid.querySelectorAll('[data-print]').forEach(b=>b.addEventListener('click', ()=> printRecipe(b.getAttribute('data-print')) ));
}
document.getElementById('recipeFilters').addEventListener('click', e=>{
  if(!e.target.classList.contains('tag')) return;
  e.target.classList.toggle('active');
  renderRecipes();
});

/* ====== PLANNER ====== */
const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
const MEALS = ['Breakfast','Lunch','Dinner','Snacks'];
const planKey = 'fff-plan-week';

function loadPlan(){
  try{ const raw = localStorage.getItem(planKey); if(raw) return JSON.parse(raw); }catch(e){}
  const blank = {}; DAYS.forEach(d=>{ blank[d]={}; MEALS.forEach(m=>blank[d][m]=[]); }); return blank;
}
function savePlan(p){ localStorage.setItem(planKey, JSON.stringify(p)); }
function renderPlanner(){
  const body = document.getElementById('planBody');
  const plan = loadPlan();
  body.innerHTML = DAYS.map(d=>{
    const tds = MEALS.map(m=>{
      const items = plan[d][m]||[];
      const html = items.map((it,idx)=>`
        <div class="item"><span>${it.name}</span>
          <button title="Remove" data-del="${d}|${m}|${idx}">✕</button>
        </div>`).join('');
      return `<td><div class="slot">${html}</div></td>`;
    }).join('');
    return `<tr><th>${d}</th>${tds}</tr>`;
  }).join('');
  body.querySelectorAll('[data-del]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const [d,m,i] = btn.getAttribute('data-del').split('|');
      const plan = loadPlan();
      plan[d][m].splice(+i,1);
      savePlan(plan); renderPlanner();
    });
  });
}
function addToPlanner(k){
  const r = RECIPES.find(x=>x.k===k); if(!r) return;
  const day = prompt('Add to which day? (Mon/Tue/Wed/Thu/Fri/Sat/Sun)','Mon');
  if(!DAYS.includes(day)) return;
  const meal = prompt('Meal slot? (Breakfast/Lunch/Dinner/Snacks)','Dinner');
  if(!MEALS.includes(meal)) return;

  const plan = loadPlan(); plan[day][meal].push({ref:r.k, name:r.name});
  savePlan(plan); renderPlanner();
}
document.getElementById('clearPlan').addEventListener('click', ()=>{ if(confirm('Clear the whole week?')){ localStorage.removeItem(planKey); renderPlanner(); }});
function aggregateList(){
  const plan = loadPlan(); const items = [];
  DAYS.forEach(d=>MEALS.forEach(m=>{
    (plan[d][m]||[]).forEach(it=>{
      const r = RECIPES.find(x=>x.k===it.ref); if(!r) return;
      let adds = [...(r.adds||[])];
      if(budgetMode){
        adds = adds.map(x=>{
          const key = Object.keys(budgetSwaps).find(k=>x.toLowerCase().includes(k));
          return key ? (budgetSwaps[key] + ' (swap)') : x;
        });
      }
      items.push(...adds);
    });
  }));
  // naive dedupe
  return [...new Set(items.map(s=>s.toLowerCase()))];
}
document.getElementById('printList').addEventListener('click', ()=>{
  const items = aggregateList();
  const w = window.open('','PRINT','width=600,height=700');
  if(!w) return;
  w.document.write('<h3>Shopping List</h3><ul>'+items.map(i=>'<li>'+i+'</li>').join('')+'</ul>');
  w.document.close(); w.focus(); w.print();
});
document.getElementById('csvList').addEventListener('click', ()=>{
  const items = aggregateList();
  const csv = 'item\n' + items.map(x=>'"'+x.replace(/"/g,'""')+'"').join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='shopping-list.csv'; a.click(); URL.revokeObjectURL(url);
});

/* ====== FOOD LOG ====== */
const logKey = 'fff-foodlog';
const dateInput = document.getElementById('logDate');
dateInput.valueAsNumber = Date.now() - (new Date()).getTimezoneOffset()*60000; // today
function getLogStore(){
  try{ const raw=localStorage.getItem(logKey); if(raw) return JSON.parse(raw); }catch(e){}
  return {};
}
function saveLogStore(s){ localStorage.setItem(logKey, JSON.stringify(s)); }

function logFor(dateStr){ const s=getLogStore(); return s[dateStr] || {items:[]}; }
function saveLog(dateStr, data){ const s=getLogStore(); s[dateStr]=data; saveLogStore(s); }

function logRecipeServing(k, servings){
  const r = RECIPES.find(x=>x.k===k); if(!r) return;
  const ds = dateInput.value || new Date().toISOString().slice(0,10);
  const data = logFor(ds);
  const m = r.macros, s = servings||1;
  data.items.push({type:'recipe', name:r.name, servings:s, kcal:m.kcal*s, p:m.p*s, c:m.c*s, f:m.f*s});
  saveLog(ds, data); renderLog(); updateLogBars();
}
function addCustomItem(){
  const name = prompt('Food name (e.g., Apple 150g or “Custom shake”)','Custom');
  if(!name) return;
  const kcal = +prompt('Calories (kcal per entry):','150')||0;
  const p = +prompt('Protein (g):','2')||0;
  const c = +prompt('Carbs (g):','32')||0;
  const f = +prompt('Fats (g):','1')||0;
  const ds = dateInput.value || new Date().toISOString().slice(0,10);
  const data = logFor(ds);
  data.items.push({type:'custom', name, servings:1, kcal, p, c, f});
  saveLog(ds, data); renderLog(); updateLogBars();
}
document.getElementById('addCustom').addEventListener('click', addCustomItem);
document.getElementById('clearLog').addEventListener('click', ()=>{
  const ds = dateInput.value || new Date().toISOString().slice(0,10);
  if(confirm('Clear all logged items for '+ds+'?')){ saveLog(ds,{items:[]}); renderLog(); updateLogBars(); }
});
document.getElementById('exportLog').addEventListener('click', ()=>{
  const ds = dateInput.value || new Date().toISOString().slice(0,10);
  const data = logFor(ds);
  const csv = 'name,servings,kcal,protein,carbs,fats\n' + data.items.map(it=>
    [it.name,it.servings,it.kcal,it.p,it.c,it.f].map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')
  ).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='foodlog-'+ds+'.csv'; a.click(); URL.revokeObjectURL(url);
});
dateInput.addEventListener('change', ()=>{ renderLog(); updateLogBars(); });

function renderLog(){
  const ds = dateInput.value || new Date().toISOString().slice(0,10);
  const data = logFor(ds);
  const box = document.getElementById('logItems');
  if(!data.items.length){ box.innerHTML='<p class="note">No items logged yet. Use “＋ Log 1 serving” on a recipe or add a custom item.</p>'; return; }
  box.innerHTML = data.items.map((it,i)=>`
    <div class="slot item">
      <div><strong>${it.name}</strong> — ${it.kcal} kcal · ${it.p}P / ${it.c}C / ${it.f}F</div>
      <button title="Remove" data-del="${i}">✕</button>
    </div>
  `).join('');
  box.querySelectorAll('[data-del]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const idx = +btn.getAttribute('data-del'); const data = logFor(ds);
      data.items.splice(idx,1); saveLog(ds,data); renderLog(); updateLogBars();
    });
  });
}
function sumDay(){
  const ds = dateInput.value || new Date().toISOString().slice(0,10);
  const data = logFor(ds);
  return data.items.reduce((a,x)=>({kcal:a.kcal+x.kcal,p:a.p+x.p,c:a.c+x.c,f:a.f+x.f}),{kcal:0,p:0,c:0,f:0});
}
function pct(a,b){ return b? Math.max(0, Math.min(100, Math.round(100*a/b))) : 0; }
function setBar(id, v){ const el=document.getElementById(id); if(el) el.style.width = v+'%'; }
function updateLogBars(){
  const t = targets; const s = sumDay();
  document.getElementById('txCal').textContent = `${s.kcal} / ${t.cal||0}`;
  document.getElementById('txProt').textContent= `${s.p} / ${t.p||0}g`;
  document.getElementById('txCarb').textContent= `${s.c} / ${t.c||0}g`;
  document.getElementById('txFat').textContent = `${s.f} / ${t.f||0}g`;
  setBar('pbCal', pct(s.kcal, t.cal||0));
  setBar('pbProt',pct(s.p, t.p||0));
  setBar('pbCarb',pct(s.c, t.c||0));
  setBar('pbFat', pct(s.f, t.f||0));
}

/* ====== PRINT RECIPE ====== */
function printRecipe(k){
  const r = RECIPES.find(x=>x.k===k); if(!r) return;
  const s = +prompt('Servings for print (default '+r.servings+'):', r.servings) || r.servings;
  const scale = s / r.servings;
  const fmtQty = v => {
    if(typeof v!=='number') return v;
    const n = Math.round(v*10)/10;
    return (n % 1 === 0)? n.toString(): n.toFixed(1);
  };
  let adds = r.adds || [];
  if(budgetMode){
    adds = adds.map(x=>{
      const key = Object.keys(budgetSwaps).find(k=>x.toLowerCase().includes(k));
      return key ? (budgetSwaps[key] + ' (swap)') : x;
    });
  }
  const win = window.open('','PRINT','width=720,height=900');
  if(!win) return;
  win.document.write(`
    <h2>${r.name}</h2>
    <p><strong>Cuisine:</strong> ${r.cuisine} · <strong>Servings:</strong> ${s}</p>
    <p><strong>Macros/serving (base):</strong> ${r.macros.kcal} kcal — ${r.macros.p}P / ${r.macros.c}C / ${r.macros.f}F</p>
    <p><strong>Allergens:</strong> ${r.allergens.length?r.allergens.join(', '):'none listed'} (check labels & cross-contamination)</p>
    <h3>Ingredients</h3>
    <ul>
      ${r.ingredients.map(it=>`<li>${fmtQty(it.qty*scale)} ${it.unit} ${it.item}</li>`).join('')}
    </ul>
    <h3>Method</h3>
    <ol>${(r.steps||[]).map(s=>`<li>${s}</li>`).join('')}</ol>
    <h3>Shopping items</h3>
    <ul>${adds.map(a=>`<li>${a}</li>`).join('')}</ul>
    <hr>
    <p style="font-size:0.9rem;color:#555">
      Nutrition values are estimates. Always adjust for your ingredients and tastes. Allergens vary by brand; check labels.
    </p>
  `);
  win.document.close(); win.focus(); win.print();
}

/* ====== FILTERS + RENDER ====== */
document.getElementById('recipeFilters').addEventListener('keydown', e=>{
  if(e.key==='Enter' && e.target.classList.contains('tag')){ e.target.click(); }
});

/* ====== LOAD targets if present ====== */
(function boot(){
  try{
    const saved = JSON.parse(localStorage.getItem('fff-targets')||'null');
    if(saved && saved.targets){
      goal = saved.goal || goal;
      targets = saved.targets;
      document.querySelectorAll('[data-goal]').forEach(x=>{
        x.setAttribute('aria-pressed', x.dataset.goal===goal ? 'true':'false');
      });
      document.getElementById('outGoal').textContent = goal[0].toUpperCase()+goal.slice(1);
      document.getElementById('outCals').textContent = targets.cal+' kcal / day';
      document.getElementById('outP').textContent = targets.p+' g';
      document.getElementById('outC').textContent = targets.c+' g';
      document.getElementById('outF').textContent = targets.f+' g';
      lastCalc=true;
    }
  }catch(e){}
  renderRecipes(); renderPlanner(); renderLog(); updateLogBars();
})();

/* FILTER CLICK HANDLER defined earlier; add also base toggle for filters */
document.getElementById('recipeFilters').addEventListener('click', e=>{
  if(!e.target.classList.contains('tag')) return;
  e.target.classList.toggle('active'); renderRecipes();
});
</script>
</body>
</html>
