<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="style.css?v=24">
  <link rel="icon" type="image/svg+xml" href="img/freefitfuel-logo.svg">

  <style>
    /* Page-only additions (keeps your global style.css intact) */
    .wrap{max-width:var(--maxw);margin:0 auto;padding:18px 20px}
    .lead{color:var(--inkdim)}

    /* HERO */
    header.hero-mini{position:relative;border-bottom:1px solid #1b1b22}
    header.hero-mini figure{margin:0;position:relative}
    header.hero-mini img{width:100%;height:46vh;min-height:320px;object-fit:cover;display:block;filter:brightness(.88) saturate(1.05)}
    header.hero-mini .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.65))}
    /* key: hero text sits BELOW the image */
    header.hero-mini .content{position:static;inset:auto;padding:16px 20px 22px;max-width:var(--maxw);margin:0 auto}
    header.hero-mini h1{margin:0 0 .35rem}
    header.hero-mini p{max-width:70ch;margin:.2rem 0 0;color:#d0d0da}

    /* Toolbar */
    .toolbar{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;margin:1rem 0 1.1rem}
    .seg{display:inline-flex;border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
    .seg button{background:var(--glass);color:var(--ink);border:0;padding:.45rem .85rem;cursor:pointer}
    .seg button[aria-pressed="true"]{background:var(--accent);color:#111;font-weight:800}
    .equip{display:flex;align-items:center;gap:.45rem;flex-wrap:wrap;margin-left:auto}
    .equip .label{opacity:.9}
    .pill{display:inline-flex;align-items:center;gap:.35rem;background:var(--glass);border:1px solid var(--stroke);border-radius:999px;padding:.35rem .65rem;font-size:.92rem}
    .pill input{accent-color:var(--accent)}

    /* Sections & blocks */
    .section{background:var(--glass);border:1px solid var(--stroke);border-radius:14px;margin:12px 0;padding:14px}
    .section>h2{margin:.15rem 0 .45rem;font-size:1.2rem}
    .plan{display:grid;gap:12px}
    @media (min-width:780px){.plan{grid-template-columns:repeat(2,1fr)}}
    .block{background:#111418;border:1px solid var(--stroke);border-radius:12px;padding:12px}
    .block h3{margin:.1rem 0 .35rem;font-size:1.05rem}

    /* Movement rows + logging drawer */
    .mov{border:1px dashed var(--stroke);border-radius:10px;padding:.55rem .6rem;margin:.45rem 0}
    .mov-head{display:flex;gap:.6rem;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .mov-title a{color:var(--ink);text-decoration:underline dotted}
    .mov-title a:hover{color:var(--accent)}
    .rx{opacity:.9}
    .mov-tools{display:flex;gap:.4rem;align-items:center}
    .btn-sm{border:1px solid var(--stroke);background:var(--glass);color:var(--ink);padding:.35rem .6rem;border-radius:8px;cursor:pointer}
    .drawer{display:none;margin:.45rem 0 0}
    .drawer.open{display:block}
    .log-grid{display:grid;gap:.35rem}
    .log-row{display:grid;grid-template-columns:80px 1fr 1fr 1fr auto;gap:.35rem;align-items:center}
    .log-row input{background:#0b0f14;border:1px solid var(--stroke);border-radius:8px;color:var(--ink);padding:.35rem .45rem}
    .meta-row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin-top:.35rem}
    .meta-row .pb{color:#90ee90}
    .meta-row .badge{border:1px solid var(--stroke);border-radius:999px;padding:.2rem .5rem;background:rgba(255,255,255,.06)}
    .quote{font-size:.92rem;color:var(--inkdim);margin-top:.25rem}

    /* Export/import + timers */
    .backup{display:flex;flex-wrap:wrap;gap:.5rem;margin:.6rem 0 0}
    .backup .btn-sm{white-space:nowrap}
    .restbar{display:flex;align-items:center;gap:.4rem;margin-top:.4rem;flex-wrap:wrap}
    .restbar .left{opacity:.9}
    .timer .left{margin-left:.4rem;opacity:.9}
  </style>
  <title>FreeFitFuel Workouts â€” Dumbbell, Bodyweight & Bands</title>
  <meta name="description" content="Smart free workouts for all levels. Log sets, track PBs, use calisthenics progressions and cross-training circuits. Dumbbell, bands & bodyweight training.">

  <!-- OpenGraph -->
  <meta property="og:title" content="FreeFitFuel Workouts â€” Dumbbell, Bodyweight & Bands">
  <meta property="og:description" content="Weekly splits, calisthenics progressions & cross-training circuits. Log reps, save PBs & build consistency.">
  <meta property="og:image" content="https://www.freefitfuel.com/img/workouts-hero.png">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://www.freefitfuel.com/workouts.html">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="FreeFitFuel Workouts â€” Dumbbell, Bodyweight & Bands">
  <meta name="twitter:description" content="Free structured workouts. Track PBs. Train anywhere with dumbbells, bands & bodyweight.">
  <meta name="twitter:image" content="https://www.freefitfuel.com/img/workouts-hero.png">
</head>
<body>
  <!-- Shared header -->
  <div id="site-header"></div>
  <script src="/js/header-loader.js" defer></script>

  <!-- HERO -->
  <header class="hero-mini" role="banner" aria-label="Workouts hero">
    <figure>
      <img src="img/curl.jpg" alt="Seated dumbbell curl at home">
      <div class="overlay" aria-hidden="true"></div>
    </figure>
    <div class="content wrap">
      <h1><span class="accent">Workouts that fit life</span></h1>
      <p class="lead">Clear plans with clickable form lookups, personal logging, badges and gentle nudges. Train smart with dumbbells, bands or bodyweight.</p>
    </div>
  </header>

  <main class="wrap">
    <p class="lead">Pick your <strong>difficulty</strong>, <strong>goal</strong> and <strong>equipment</strong>. Titles open a YouTube search for form. Your logs stay on this device (with export/import backup).</p>

    <!-- ===== Controls ===== -->
    <div class="toolbar" aria-label="Workout controls">
      <!-- Difficulty -->
      <div class="seg" role="tablist" aria-label="Difficulty">
        <button role="tab" aria-pressed="true"  data-level="beginner">Beginner</button>
        <button role="tab" aria-pressed="false" data-level="intermediate">Intermediate</button>
        <button role="tab" aria-pressed="false" data-level="advanced">Advanced</button>
      </div>

      <!-- Goals -->
      <div class="seg" role="tablist" aria-label="Goal" style="margin-left:.5rem">
        <button role="tab" aria-pressed="true"  data-goal="maintain">Maintain</button>
        <button role="tab" aria-pressed="false" data-goal="cut">Cut</button>
        <button role="tab" aria-pressed="false" data-goal="build">Build</button>
        <button role="tab" aria-pressed="false" data-goal="transform">Transform</button>
      </div>

      <!-- Equipment -->
      <div class="equip" aria-label="Equipment filters">
        <span class="label">Equipment:</span>
        <span class="pill"><input type="checkbox" id="f-db"   checked> <label for="f-db">Dumbbells</label></span>
        <span class="pill"><input type="checkbox" id="f-band" checked> <label for="f-band">Bands</label></span>
        <span class="pill"><input type="checkbox" id="f-bw"   checked> <label for="f-bw">Bodyweight</label></span>
        <span class="pill"><input type="checkbox" id="f-rack"> <label for="f-rack">Bar / Door anchor</label></span>
        <span class="pill"><input type="checkbox" id="f-rings"><label for="f-rings">Rings</label></span>
      </div>
    </div>

    <!-- Backup -->
    <div class="backup" aria-label="Backup controls">
      <button class="btn-sm" id="btnExport">Export logs (.json)</button>
      <label class="btn-sm" for="importFile" style="cursor:pointer">Import logs</label>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <span class="meta">Tip: export occasionally to guard against browser cleanup.</span>
      <button class="btn-sm" id="btnResetAll" title="Delete all saved logs & PBs">Reset all logs</button>
    </div>

    <!-- ===== Weekly Split (Chunk 1) ===== -->
    <section class="section">
      <h2>Weekly Split</h2>
      <div id="plan" class="plan"></div>
      <p class="meta">Short on time? Run the <strong>Full-Body</strong> day 2â€“3Ã—/week and sprinkle easy cardio or mobility between.</p>
    </section>

    <!-- ===== Calisthenics (Chunk 2) ===== -->
    <section class="section">
      <h2>Calisthenics Progressions</h2>
      <div id="cal" class="plan"></div>
      <p class="meta">Bodyweight mastery: start with regressions, progress steadily to harder versions. Adjust volume by your selected difficulty.</p>
    </section>

    <!-- ===== Cross Training (Chunk 3) ===== -->
    <section class="section" id="circuits-section">
      <h2>Cross-Training Circuits</h2>
      <div id="circuits" class="plan"></div>
      <p class="meta">
        Simple formats to build engine and grit. Click any exercise name for a YouTube form search.
        FreeFitFuel is not affiliated with any third-party fitness brand.
      </p>
    </section>

    <section class="section">
      <h2>Important Note</h2>
      <p>The content on FreeFitFuelâ„¢ is for general fitness education only and isnâ€™t a substitute for personalised medical advice. Consult a qualified professional before starting a new programme, especially if you have any health conditions or injuries. Stop any exercise that causes sharp pain, dizziness, chest pain, or unusual shortness of breath.</p>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="container">
      <img src="img/freefitfuel-logo.svg" alt="FreeFitFuel Logo" height="64">
      <p>&copy; 2025 FreeFitFuelâ„¢ Â· All rights reserved.</p>
      <p class="credit">Created by Grant Cameron Anthony</p>
    </div>
  </footer>

  <script>
/* ========= NAMESPACE / PREFS ========= */
const NS = 'fff.workouts.v1.';
const PREFS_KEY = NS + 'prefs';

function defaultPrefs(){
  return {
    level: 'beginner',
    goal:  'maintain',
    equip: { db:true, band:true, bw:true, rack:false, rings:false }
  };
}
function loadPrefs(){
  try{
    const p = JSON.parse(localStorage.getItem(PREFS_KEY)||'{}');
    const d = defaultPrefs();
    return {
      level: p.level || d.level,
      goal:  p.goal  || d.goal,
      equip: {...d.equip, ...(p.equip||{})}
    };
  }catch{ return defaultPrefs(); }
}
function savePrefs(p){ try{ localStorage.setItem(PREFS_KEY, JSON.stringify(p)); }catch{} }

/* ========= DATA ========= */
const EXERCISES = [
  /* PUSH */
  {k:'pushup',  n:'Push-up',                        eq:'bw',   yt:'push up form'},
  {k:'dbfloor', n:'Dumbbell Floor Press',           eq:'db',   yt:'dumbbell floor press form'},
  {k:'dbbench', n:'Dumbbell Bench Press',           eq:'db',   yt:'dumbbell bench press form'},
  {k:'latraise',n:'Lateral Raise',                  eq:'db',   yt:'lateral raise form'},
  {k:'ohpress', n:'Dumbbell Overhead Press',        eq:'db',   yt:'standing dumbbell overhead press form'},

  /* PULL */
  {k:'bandrow', n:'Band Row',                       eq:'band', yt:'resistance band row form'},
  {k:'doorrow', n:'Door/Table Row',                 eq:'bw',   yt:'bodyweight row at home form'},
  {k:'bandlat', n:'Band Lat Pulldown',              eq:'band', yt:'band lat pulldown form'},
  {k:'csrow',   n:'Chest-Supported DB Row',         eq:'db',   yt:'chest supported dumbbell row form'},
  {k:'chin',    n:'Chin-up (assisted if needed)',   eq:'rack', yt:'chin up progression form'},

  /* LEGS / CORE */
  {k:'stepup',  n:'Step-up',                        eq:'db',   yt:'dumbbell step up form'},
  {k:'dbrdl',   n:'Dumbbell Romanian Deadlift',     eq:'db',   yt:'dumbbell romanian deadlift form'},
  {k:'split',   n:'Split Squat / Bulgarian',        eq:'db',   yt:'bulgarian split squat form'},
  {k:'sidepl',  n:'Side Plank',                     eq:'bw',   yt:'side plank form'},

  /* FULL BODY */
  {k:'dbcp',    n:'DB Clean & Press',               eq:'db',   yt:'dumbbell clean and press form'},
  {k:'manmaker',n:'Man Maker',                      eq:'db',   yt:'dumbbell man maker form'},

  /* Simple BW for circuits */
  {k:'airsquat', n:'Air Squat',                     eq:'bw',   yt:'air squat form'},
  {k:'jumprope', n:'Jump Rope',                     eq:'bw',   yt:'jump rope single unders form'},
  {k:'situp',    n:'Sit-up',                        eq:'bw',   yt:'abmat sit up form'},

  /* RINGS */
  {k:'ringrow',   n:'Ring Row',                eq:'rings', yt:'gymnastic ring row form'},
  {k:'ringdip',   n:'Ring Dip',                eq:'rings', yt:'ring dip progression form'},
  {k:'ringpush',  n:'Ring Push-up',            eq:'rings', yt:'ring push up form'},
  {k:'ringsup',   n:'Ring Support Hold',       eq:'rings', yt:'ring support hold form'},
  {k:'ringlsit',  n:'Ring L-Sit (tuckâ†’L)',     eq:'rings', yt:'ring l sit progression'}
];

/* ===== Alternatives (ordered) ===== */
const ALTS = {
  // Pull
  chin:['ringrow','doorrow','bandlat','bandrow'],
  bandlat:['ringrow','doorrow','bandrow'],
  csrow:['ringrow','doorrow','bandrow'],
  doorrow:['ringrow','bandrow','bandlat'],
  ringrow:['doorrow','bandrow','bandlat'],
  // Push / Shoulders
  dbbench:['ringpush','pushup','dbfloor'],
  dbfloor:['ringpush','pushup'],
  ohpress:['ringpush','pushup'],
  latraise:['ohpress','ringpush','pushup'],
  pushup:['ringpush','dbfloor'],
  // Legs / Core
  stepup:['split','sidepl'],
  dbrdl:['split','sidepl'],
  split:['stepup','sidepl'],
  sidepl:['ringsup'],
  ringsup:['sidepl'],
  // Full body
  dbcp:['manmaker','pushup','doorrow'],
  manmaker:['dbcp','pushup','doorrow']
};

/* ===== Weekly Split ===== */
const PLAN = {
  push:{
    beginner:     [{k:'pushup',rx:'3Ã—6â€“10'},{k:'dbfloor',rx:'3Ã—8â€“12'},{k:'latraise',rx:'3Ã—12â€“15'}],
    intermediate: [{k:'dbbench',rx:'4Ã—6â€“10'},{k:'ohpress',rx:'4Ã—6â€“10'},{k:'latraise',rx:'3Ã—12â€“15'}],
    advanced:     [{k:'dbbench',rx:'5Ã—5â€“8'},{k:'ohpress',rx:'5Ã—6â€“8'},{k:'latraise',rx:'4Ã—12â€“15'}]
  },
  pull:{
    beginner:     [{k:'doorrow',rx:'3Ã—8â€“12'},{k:'bandrow',rx:'3Ã—10â€“12'}],
    intermediate: [{k:'csrow',rx:'4Ã—8â€“12'},{k:'bandlat',rx:'4Ã—10â€“12'}],
    advanced:     [{k:'chin',rx:'5Ã—AMRAP'},{k:'csrow',rx:'5Ã—6â€“10'}]
  },
  legs:{
    beginner:     [{k:'stepup',rx:'3Ã—8â€“12'},{k:'dbrdl',rx:'3Ã—8â€“12'},{k:'sidepl',rx:'2Ã—25â€“40s'}],
    intermediate: [{k:'stepup',rx:'4Ã—8â€“12'},{k:'dbrdl',rx:'4Ã—6â€“10'},{k:'split',rx:'3Ã—8â€“12/leg'}],
    advanced:     [{k:'stepup',rx:'5Ã—8â€“12'},{k:'dbrdl',rx:'5Ã—6â€“8'},{k:'split',rx:'4Ã—8â€“12/leg'}]
  },
  full:{
    beginner:     [{k:'pushup',rx:'3Ã—6â€“10'},{k:'bandrow',rx:'3Ã—10â€“12'},{k:'stepup',rx:'3Ã—8â€“12'},{k:'sidepl',rx:'2Ã—25â€“40s'}],
    intermediate: [{k:'dbbench',rx:'4Ã—6â€“10'},{k:'csrow',rx:'4Ã—8â€“12'},{k:'dbrdl',rx:'4Ã—8â€“12'},{k:'dbcp',rx:'3Ã—6â€“8'}],
    advanced:     [{k:'dbcp',rx:'5Ã—3â€“5'},{k:'dbbench',rx:'5Ã—5â€“8'},{k:'csrow',rx:'5Ã—6â€“10'},{k:'manmaker',rx:'4Ã—8â€“10'}]
  }
};

/* ===== Calisthenics ===== */
const CAL = [
  {title:'Push', items:[
    {k:'pushup', name:'Push-up', eq:'bw',
     rxB:'Incline push-up â€” 3Ã—8â€“12',
     rxI:'Flat push-up â€” 4Ã—8â€“12',
     rxA:'Feet-elevated or ring push-up â€” 5Ã—6â€“10'},
    {k:'ringpush', name:'Ring Push-up', eq:'rings',
     rxB:'Rings high (inclined) â€” 3Ã—8â€“12',
     rxI:'Rings mid-height â€” 4Ã—8â€“12 (tempo 3â€“1â€“1)',
     rxA:'Rings low / feet-elevated â€” 5Ã—6â€“10 (slow negative)'}
  ]},
  {title:'Pull', items:[
    {k:'doorrow', name:'Bodyweight Row (table/door)', eq:'bw',
     rxB:'Row (high angle) â€” 3Ã—8â€“12',
     rxI:'Row (feet further) â€” 4Ã—8â€“12',
     rxA:'Row (feet elevated) â€” 5Ã—6â€“10'},
    {k:'ringrow', name:'Ring Row', eq:'rings',
     rxB:'Rings high, knees bent â€” 3Ã—8â€“12',
     rxI:'Rings mid, straight body â€” 4Ã—8â€“12',
     rxA:'Rings low, feet elevated â€” 5Ã—6â€“10 (1s pause top)'}
  ]},
  {title:'Core / Stability', items:[
    {k:'sidepl',   name:'Side Plank', eq:'bw',
     rxB:'3Ã—25â€“40s/side', rxI:'3Ã—35â€“50s/side', rxA:'3Ã—45â€“60s/side (long lever)'},
    {k:'ringsup',  name:'Ring Support Hold', eq:'rings',
     rxB:'Support holds â€” 5Ã—10â€“20s', rxI:'Support + knee raises â€” 4Ã—6â€“10', rxA:'Support + tuckâ†’L pulses â€” 4Ã—6â€“8'},
    {k:'ringlsit', name:'Ring L-Sit (tuckâ†’L)', eq:'rings',
     rxB:'Tuck holds â€” 6Ã—5â€“10s', rxI:'Advanced tuck â€” 5Ã—5â€“10s', rxA:'Partialâ†’full L â€” 8â€“10Ã—3â€“8s'}
  ]},
  {title:'Legs', items:[
    {k:'stepup', name:'Step-up', eq:'db',
     rxB:'Box just below knee â€” 3Ã—8â€“12/leg',
     rxI:'Add load â€” 4Ã—8â€“12/leg',
     rxA:'Higher box / tempo pauses â€” 5Ã—6â€“10/leg'}
  ]}
];

/* ===== Cross-Training Circuits ===== */
const CIRCUITS = [
  {
    k:'amrap20-triplet',
    title:'Triplet â€” AMRAP 20',
    desc:'20:00 continuous: pull/row â€¢ push â€¢ squat. Keep sets submax.',
    presetSec:1200,
    scoreHint:'Score = rounds + extra reps',
    scoreType:'roundsreps',
    items:[
      {k:'doorrow',  name:'Row / Pull-up',   yt:'bodyweight row form',
       rx:{beginner:'3',  intermediate:'5',  advanced:'5'}},
      {k:'pushup',   name:'Push-up',         yt:'push up form',
       rx:{beginner:'6 (incline)', intermediate:'10', advanced:'10'}},
      {k:'airsquat', name:'Air Squat',       yt:'air squat form',
       rx:{beginner:'10', intermediate:'15', advanced:'15'}}
    ],
    tailNote:' â€” repeat for 20:00'
  },
  {
    k:'emom30-triplet',
    title:'Triplet â€” EMOM 30',
    desc:'Every minute for 30:00 do the triplet; rest in the remainder.',
    presetSec:1800,
    scoreHint:'Score = minutes completed unbroken (or total minutes)',
    scoreType:'higher',
    items:[
      {k:'doorrow',  name:'Row / Pull-up', yt:'pull up strict form',
       rx:{beginner:'3',  intermediate:'5',  advanced:'5 strict'}},
      {k:'pushup',   name:'Push-up',       yt:'push up form',
       rx:{beginner:'6 (incline)', intermediate:'10', advanced:'10'}},
      {k:'airsquat', name:'Air Squat',     yt:'air squat form',
       rx:{beginner:'10', intermediate:'15', advanced:'15'}}
    ],
    tailNote:' â€” every minute Ã—30'
  },
  {
    k:'ladder-rope-situp',
    title:'Rope + Sit-up Ladder â€” For Time',
    desc:'50-40-30-20-10 of jump-rope & sit-ups.',
    presetSec:900,
    scoreHint:'Score = finish time (mm:ss) â€” lower is better',
    scoreType:'lower',
    items:[
      {k:'jumprope', name:'Jump Rope', yt:'single unders jump rope form',
       rx:{beginner:'Singles', intermediate:'Singles (2:1) or DU attempts', advanced:'Double-unders'}},
      {k:'situp',    name:'Sit-up',    yt:'abmat sit up form',
       rx:{beginner:'Sit-ups', intermediate:'Sit-ups', advanced:'Sit-ups'}}
    ],
    tailNote:' â€” cap 12â€“15 min'
  }
];

/* ===== Quotes ===== */
const QUOTES = [
  "Small wins compound. Log the set, own the day.",
  "Perfect form, steady breath, then add a little.",
  "Consistency beats intensity when intensity is inconsistent.",
  "One clean rep beats five messy ones.",
  "Show up. Scale smart. Keep going."
];

/* ========= STATE ========= */
let PREFS = loadPrefs();
let level = PREFS.level;
let goal  = PREFS.goal;

/* ========= GENERAL HELPERS ========= */
function filters(){
  const d = PREFS.equip;
  return {
    db:    document.getElementById('f-db')?.checked    ?? d.db,
    band:  document.getElementById('f-band')?.checked  ?? d.band,
    bw:    document.getElementById('f-bw')?.checked    ?? d.bw,
    rack:  document.getElementById('f-rack')?.checked  ?? d.rack,
    rings: document.getElementById('f-rings')?.checked ?? d.rings
  };
}
function ytSearchURL(term){ return 'https://www.youtube.com/results?search_query='+encodeURIComponent(term); }
function applyGoal(rx){
  if(goal==='cut')       return rx+' Â· short rests';
  if(goal==='build')     return rx.replace(/(\d+)Ã—/,(m,n)=>(+n+1)+'Ã—')+' Â· add load';
  if(goal==='transform') return rx+' + finisher';
  return rx;
}
function findExerciseByKey(k){ return EXERCISES.find(e=>e.k===k); }
function gearOK(ex){ return !!filters()[ex.eq]; }
/** pick primary or first matching alt */
function pickExerciseOrAlt(primaryKey){
  let ex = findExerciseByKey(primaryKey);
  if(ex && gearOK(ex)) return {ex, isAlt:false};
  const tries = (ALTS[primaryKey]||[]).map(k=>findExerciseByKey(k)).filter(Boolean);
  for(const cand of tries){ if(gearOK(cand)) return {ex:cand, isAlt:true}; }
  return {ex:null, isAlt:false};
}
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function flash(el, text){ if(!el) return; el.textContent = text; el.style.opacity = '1'; setTimeout(()=>{ el.style.opacity='.92'; }, 50); }
function bestScore(obj){
  let best = 0;
  for(let i=1;i<=5;i++){
    const w = parseFloat(obj['w'+i]||'0')||0;
    const r = parseFloat(obj['r'+i]||'0')||0;
    best = Math.max(best, w*r);
  }
  return best;
}
function milestoneText(count){
  const n = typeof count==='number' ? count : parseInt(localStorage.getItem(NS+'saves')||'0',10);
  if(n>=200) return 'Milestone: 200 logs saved ðŸ”¥';
  if(n>=100) return 'Milestone: 100 logs saved ðŸŽ‰';
  if(n>=50)  return 'Milestone: 50 logs saved ðŸ’ª';
  if(n>=25)  return 'Milestone: 25 logs saved ðŸ™Œ';
  if(n>=10)  return 'Milestone: 10 logs saved âœ…';
  if(n>=5)   return 'Milestone: 5 logs saved âœ¨';
  return '';
}

/* ====== Beeper (3-beep lead-in & finish) ====== */
function beepOnce(freq=880, dur=140, vol=0.03){
  try{
    const Ctx = window.AudioContext || window.webkitAudioContext;
    const ctx = new Ctx();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='sine'; o.frequency.value=freq; g.gain.value=vol;
    o.connect(g); g.connect(ctx.destination);
    o.start(); setTimeout(()=>{o.stop(); ctx.close();}, dur);
  }catch{}
}
function beepSeries(n=3, gap=220){ for(let i=0;i<n;i++){ setTimeout(()=>beepOnce(880,140,0.03), i*gap); } }

/* ========= SECTION QUOTES ========= */
function setSectionQuote(containerEl){
  if(!containerEl) return;
  const sec = containerEl.closest('.section') || containerEl.parentElement;
  if(!sec) return;
  let q = sec.querySelector('.section-quote');
  if(!q){ q = document.createElement('p'); q.className='section-quote quote'; sec.appendChild(q); }
  q.textContent = pick(QUOTES);
}

/* ========= RENDER: WEEKLY SPLIT ========= */
const planEl = document.getElementById('plan');

function renderPlan(){
  if(!planEl) return;
  planEl.innerHTML = '';
  const groups = [
    ['push', 'Push Day'],
    ['pull', 'Pull Day'],
    ['legs', 'Legs / Core Day'],
    ['full', 'Full-Body Day']
  ];

  groups.forEach(([key,label])=>{
    const blk = document.createElement('div');
    blk.className = 'block';
    blk.innerHTML = `<h3>${label}</h3>`;
    PLAN[key][level].forEach(item=>{
      const pickRes = pickExerciseOrAlt(item.k);
      if(!pickRes.ex) return;
      const ex = pickRes.ex;

      const row = document.createElement('div');
      row.className = 'mov';
      row.innerHTML = `
        <div class="mov-head">
          <div class="mov-title">
            <a href="${ytSearchURL(ex.yt)}" target="_blank" rel="noopener" title="YouTube form search">
              ${ex.n}${pickRes.isAlt ? ' <span class="meta">(alt)</span>' : ''}
            </a>
          </div>
          <div class="rx">${applyGoal(item.rx)}</div>
          <div class="mov-tools">
            <button class="btn-sm" data-open>Log</button>
            <button class="btn-sm" data-clear title="Clear this exerciseâ€™s saved data">Clear</button>
          </div>
        </div>
        ${pickRes.isAlt ? '<p class="meta" style="margin:.35rem 0 0">Suggested alternative shown based on current equipment.</p>' : ''}
        <div class="drawer" data-drawer>
          <div class="log-grid" data-log>
            ${[1,2,3,4,5].map(i=>`
              <div class="log-row">
                <strong>Set ${i}</strong>
                <input inputmode="decimal" placeholder="kg"   data-field="w${i}">
                <input inputmode="numeric" placeholder="reps" data-field="r${i}">
                <input placeholder="notes" data-field="n${i}">
                <button class="btn-sm" data-save>Save</button>
              </div>
              <div class="restbar">
                <input type="number" value="60" min="5" step="5" aria-label="Rest seconds for set ${i}">
                <button class="btn-sm" data-act="rest">Rest</button>
                <span class="left" aria-live="polite"></span>
              </div>
            `).join('')}
          </div>
          <div class="meta-row">
            <span class="pb" data-pb></span>
            <span class="badge" data-badge></span>
          </div>
          <div class="quote" data-quote></div>
        </div>
      `;

      const drawer = row.querySelector('[data-drawer]');
      row.querySelector('[data-open]').addEventListener('click', ()=>drawer.classList.toggle('open'));
      row.querySelector('[data-clear]').addEventListener('click', ()=>{
        localStorage.removeItem(NS+ex.k);
        localStorage.removeItem(NS+ex.k+'.best');
        populateFromStore();
        flash(row.querySelector('[data-quote]'), "Cleared. Fresh start.");
      });

      const logArea = row.querySelector('[data-log]');
      const pbEl    = row.querySelector('[data-pb]');
      const badgeEl = row.querySelector('[data-badge]');
      const quoteEl = row.querySelector('[data-quote]');

      function populateFromStore(){
        const saved = JSON.parse(localStorage.getItem(NS+ex.k) || '{}');
        logArea.querySelectorAll('[data-field]').forEach(inp=>{
          const id = inp.dataset.field;
          if(saved[id]) inp.value = saved[id];
        });
        const bestWas = parseFloat(localStorage.getItem(NS+ex.k+'.best')||'0')||0;
        pbEl.textContent = bestWas>0 ? `PB score: ${bestWas.toFixed(1)} (wÃ—r best set)` : '';
        badgeEl.textContent = milestoneText();
      }
      populateFromStore();

      logArea.querySelectorAll('[data-save]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const obj = {};
          logArea.querySelectorAll('[data-field]').forEach(inp=>{
            obj[inp.dataset.field] = inp.value.trim();
          });
          localStorage.setItem(NS+ex.k, JSON.stringify(obj));

          const bestNow = bestScore(obj);
          const bestWas = parseFloat(localStorage.getItem(NS+ex.k+'.best')||'0')||0;
          if(bestNow > bestWas){
            localStorage.setItem(NS+ex.k+'.best', bestNow);
            pbEl.textContent = `New PB! ${bestNow.toFixed(1)} (best wÃ—r)`;
            flash(quoteEl, pick(QUOTES));
          }else{
            pbEl.textContent = bestWas>0 ? `PB score: ${bestWas.toFixed(1)} (wÃ—r best set)` : 'Saved.';
            flash(quoteEl, pick(QUOTES));
          }

          const total = (parseInt(localStorage.getItem(NS+'saves')||'0',10) + 1);
          localStorage.setItem(NS+'saves', total);
          badgeEl.textContent = milestoneText(total);
        });
      });

      blk.appendChild(row);
    });

    planEl.appendChild(blk);
  });

  // bind rest bars & add section quote
  hookRestTimers();
  setSectionQuote(planEl);
}

/* ========= RENDER: CALISTHENICS ========= */
function renderCal(){
  const calEl = document.getElementById('cal');
  if(!calEl) return;
  calEl.innerHTML = '';

  CAL.forEach(group=>{
    const blk = document.createElement('div');
    blk.className = 'block';
    blk.innerHTML = `<h3>${group.title}</h3>`;

    group.items.forEach(item=>{
      const pickRes = pickExerciseOrAlt(item.k);
      if(!pickRes.ex) return;
      const ex = pickRes.ex;
      const displayName = item.name || ex.n || item.k;
      const q = ex.yt || (displayName + ' exercise form');
      const url = ytSearchURL(q);
      const rx = (level==='beginner') ? item.rxB
              : (level==='intermediate') ? item.rxI
              : item.rxA;

      const row = document.createElement('div');
      row.className = 'mov';
      row.innerHTML = `
        <div class="mov-head">
          <div class="mov-title">
            <a href="${url}" target="_blank" rel="noopener" title="YouTube form search">
              ${displayName}${pickRes.isAlt ? ' <span class="meta">(alt)</span>' : ''}
            </a>
          </div>
          <div class="rx">${rx}</div>
          <div class="mov-tools">
            <button class="btn-sm" data-open>Log</button>
            <button class="btn-sm" data-clear title="Clear this exerciseâ€™s saved data">Clear</button>
          </div>
        </div>
        ${pickRes.isAlt ? '<p class="meta" style="margin:.35rem 0 0">Alternative shown based on equipment.</p>' : ''}
        <div class="drawer" data-drawer>
          <div class="log-grid" data-log>
            ${[1,2,3,4,5].map(i=>`
              <div class="log-row">
                <strong>Set ${i}</strong>
                <input inputmode="decimal" placeholder="kg/mins" data-field="w${i}">
                <input inputmode="numeric" placeholder="reps/RPE" data-field="r${i}">
                <input placeholder="notes" data-field="n${i}">
                <button class="btn-sm" data-save>Save</button>
              </div>
              <div class="restbar">
                <input type="number" value="60" min="5" step="5" aria-label="Rest seconds for set ${i}">
                <button class="btn-sm" data-act="rest">Rest</button>
                <span class="left" aria-live="polite"></span>
              </div>
            `).join('')}
          </div>
          <div class="meta-row">
            <span class="pb" data-pb></span>
            <span class="badge" data-badge></span>
          </div>
          <div class="quote" data-quote></div>
        </div>
      `;

      const drawer = row.querySelector('[data-drawer]');
      row.querySelector('[data-open]').addEventListener('click', ()=>drawer.classList.toggle('open'));
      row.querySelector('[data-clear]').addEventListener('click', ()=>{
        localStorage.removeItem(NS+ex.k);
        localStorage.removeItem(NS+ex.k+'.best');
        populateFromStore();
        flash(row.querySelector('[data-quote]'), "Cleared. Fresh start.");
      });

      const logArea = row.querySelector('[data-log]');
      const pbEl    = row.querySelector('[data-pb]');
      const badgeEl = row.querySelector('[data-badge]');
      const quoteEl = row.querySelector('[data-quote]');

      function populateFromStore(){
        const saved = JSON.parse(localStorage.getItem(NS+ex.k) || '{}');
        logArea.querySelectorAll('[data-field]').forEach(inp=>{
          const id = inp.dataset.field;
          if(saved[id]) inp.value = saved[id];
        });
        const bestWas = parseFloat(localStorage.getItem(NS+ex.k+'.best')||'0')||0;
        pbEl.textContent = bestWas>0 ? `PB score: ${bestWas.toFixed(1)} (wÃ—r best set)` : '';
        badgeEl.textContent = milestoneText();
      }
      populateFromStore();

      logArea.querySelectorAll('[data-save]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const obj = {};
          logArea.querySelectorAll('[data-field]').forEach(inp=>{
            obj[inp.dataset.field] = inp.value.trim();
          });
          localStorage.setItem(NS+ex.k, JSON.stringify(obj));

          const bestNow = bestScore(obj);
          const bestWas = parseFloat(localStorage.getItem(NS+ex.k+'.best')||'0')||0;
          if(bestNow > bestWas){
            localStorage.setItem(NS+ex.k+'.best', bestNow);
            pbEl.textContent = `New PB! ${bestNow.toFixed(1)} (best wÃ—r)`;
            flash(quoteEl, pick(QUOTES));
          }else{
            pbEl.textContent = bestWas>0 ? `PB score: ${bestWas.toFixed(1)} (wÃ—r best set)` : 'Saved.';
            flash(quoteEl, pick(QUOTES));
          }

          const total = (parseInt(localStorage.getItem(NS+'saves')||'0',10) + 1);
          localStorage.setItem(NS+'saves', total);
          badgeEl.textContent = milestoneText(total);
        });
      });

      blk.appendChild(row);
    });

    calEl.appendChild(blk);
  });

  hookRestTimers();
  setSectionQuote(calEl);
}

/* ========= RENDER: CIRCUITS (with one drawer timer per circuit) ========= */
function renderCircuits(){
  const wrap = document.getElementById('circuits');
  if(!wrap) return;
  wrap.innerHTML = '';

  CIRCUITS.forEach(c=>{
    const blk = document.createElement('div');
    blk.className = 'block';

    const presc = c.items.map(it=>{
      const ex = EXERCISES.find(e=>e.k===it.k);
      const q  = ex ? ex.yt : (it.yt || (it.name + ' exercise form'));
      const link = `<a href="${ytSearchURL(q)}" target="_blank" rel="noopener" title="YouTube form search">${it.name}</a>`;
      const dose = (level==='beginner') ? it.rx.beginner
                 : (level==='intermediate') ? it.rx.intermediate
                 : it.rx.advanced;
      return `${link} â€” ${dose}`;
    }).join(' &nbsp;â€¢&nbsp; ');

    blk.innerHTML = `
      <h3>${c.title}</h3>
      <p class="meta">${c.desc}</p>

      <div class="mov">
        <div class="mov-head">
          <div class="mov-title"><span>${presc}${c.tailNote||''}</span></div>
          <div class="rx">${c.scoreHint}</div>
          <div class="mov-tools">
            <button class="btn-sm" data-open>Log</button>
            <button class="btn-sm" data-clear title="Clear saved attempts">Clear</button>
          </div>
        </div>

        <div class="drawer" data-drawer>
          <div class="log-grid" data-log>
            ${[1,2,3,4,5].map(i=>`
              <div class="log-row">
                <strong>Attempt ${i}</strong>
                <input inputmode="numeric" placeholder="rounds" data-field="r${i}">
                <input inputmode="numeric" placeholder="reps"   data-field="x${i}">
                <input placeholder="time mm:ss (optional)"      data-field="t${i}">
                <button class="btn-sm" data-save>Save</button>
              </div>
            `).join('')}
          </div>

          <div class="meta-row">
            <span class="pb" data-pb></span>
            <span class="badge" data-badge></span>
          </div>
          <div class="quote" data-quote></div>

          <!-- Single circuit timer -->
          <div class="timer" data-timer="${c.k}">
            <label class="visually-hidden" for="t-${c.k}">Timer (seconds)</label>
            <input id="t-${c.k}" type="number" min="5" step="5" value="${c.presetSec}">
            <button class="btn-sm" data-act="start">Start</button>
            <button class="btn-sm" data-act="stop">Stop</button>
            <span class="left" aria-live="polite">${c.presetSec}s</span>
          </div>
        </div>
      </div>
    `;

    const drawer  = blk.querySelector('[data-drawer]');
    const openBtn = blk.querySelector('[data-open]');
    const clrBtn  = blk.querySelector('[data-clear]');
    const logArea = blk.querySelector('[data-log]');
    const pbEl    = blk.querySelector('[data-pb]');
    const badgeEl = blk.querySelector('[data-badge]');
    const quoteEl = blk.querySelector('[data-quote]');
    openBtn.addEventListener('click', ()=> drawer.classList.toggle('open'));

    const baseK = NS + 'ct.' + c.k;

    function scoreCircuit(obj){
      let best = 0;
      for(let i=1;i<=5;i++){
        const rounds = parseFloat(obj['r'+i]||'0')||0;
        const reps   = parseFloat(obj['x'+i]||'0')||0;
        const time   = (obj['t'+i]||'').trim();
        const sec = (/^\d{1,2}:\d{2}$/.test(time))
          ? (parseInt(time.split(':')[0],10)*60 + parseInt(time.split(':')[1],10))
          : 0;
        let s = 0;
        if(c.scoreType==='lower' && sec>0) s = 100000 - sec;  // lower is better
        else s = rounds + reps/1000;
        best = Math.max(best, s);
      }
      return best;
    }

    function populate(){
      const saved = JSON.parse(localStorage.getItem(baseK) || '{}');
      logArea.querySelectorAll('[data-field]').forEach(inp=>{
        const id = inp.dataset.field; if(saved[id]) inp.value = saved[id];
      });
      const bestWas = parseFloat(localStorage.getItem(baseK+'.best')||'0')||0;
      pbEl.textContent = bestWas>0 ? `PB: ${bestWas.toFixed(3)} (see rounds/reps or time)` : '';
      badgeEl.textContent = milestoneText();
    }
    populate();

    logArea.querySelectorAll('[data-save]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const obj = {};
        logArea.querySelectorAll('[data-field]').forEach(inp=>{
          obj[inp.dataset.field] = inp.value.trim();
        });
        localStorage.setItem(baseK, JSON.stringify(obj));
        const bestNow = scoreCircuit(obj);
        const bestWas = parseFloat(localStorage.getItem(baseK+'.best')||'0')||0;
        if(bestNow > bestWas){
          localStorage.setItem(baseK+'.best', bestNow);
          pbEl.textContent = `New PB! ${bestNow.toFixed(3)}`;
        }else{
          pbEl.textContent = bestWas>0 ? `PB: ${bestWas.toFixed(3)}` : 'Saved.';
        }
        const total = (parseInt(localStorage.getItem(NS+'saves')||'0',10) + 1);
        localStorage.setItem(NS+'saves', total);
        badgeEl.textContent = milestoneText(total);
        flash(quoteEl, pick(QUOTES));
      });
    });

    clrBtn.addEventListener('click', ()=>{
      localStorage.removeItem(baseK);
      localStorage.removeItem(baseK+'.best');
      populate(); flash(quoteEl, 'Cleared. Fresh slate.');
    });

    wrap.appendChild(blk);
  });

  hookCircuitTimers();  // ensure timers are bound
  setSectionQuote(wrap); // section quote after circuits grid
}

/* ========= REST TIMERS (per set) ========= */
function hookRestTimers(){
  document.querySelectorAll('.restbar').forEach(bar=>{
    if(bar.dataset.bound==='1') return; bar.dataset.bound='1';
    const input=bar.querySelector('input[type="number"]');
    const span =bar.querySelector('.left');
    const btn  =bar.querySelector('[data-act="rest"]');
    let iv=null;

    function show(sec){
      sec = Math.max(0, Math.floor(Number(sec)||0));
      span.textContent = sec>0 ? `${sec}s` : 'Done!';
    }

    btn?.addEventListener('click', ()=>{
      let t = Math.max(5, parseInt(input?.value||'0',10)||0);
      clearInterval(iv);
      // 3-beep lead-in, then start
      beepSeries(3);
      setTimeout(()=>{
        show(t);
        iv = setInterval(()=>{
          t -= 1; show(t);
          if(t<=0){ clearInterval(iv); beepSeries(3); }
        }, 1000);
      }, 3*220 + 120); // small delay after beeps
    });
  });
}

/* ========= CIRCUIT TIMERS (one per drawer) ========= */
function hookCircuitTimers(){
  document.querySelectorAll('.timer').forEach(box=>{
    if (box.dataset.bound === '1') return;
    box.dataset.bound = '1';

    const input  = box.querySelector('input[type="number"]');
    const leftEl = box.querySelector('.left');
    const start  = box.querySelector('[data-act="start"]');
    const stop   = box.querySelector('[data-act="stop"]');
    let tick = null;

    function fmt(sec){
      sec = Math.max(0, Math.floor(Number(sec)||0));
      const m = Math.floor(sec/60), s = sec%60;
      return m > 0 ? `${m}:${String(s).padStart(2,'0')}` : `${s}s`;
    }
    function show(sec){ leftEl.textContent = fmt(sec); }
    show(parseInt(input?.value||'0',10));

    start?.addEventListener('click', ()=>{
      let remaining = Math.max(5, parseInt(input?.value||'0',10)||0);
      clearInterval(tick);
      // 3-beep lead-in
      beepSeries(3);
      setTimeout(()=>{
        show(remaining);
        tick = setInterval(()=>{
          remaining -= 1;
          show(remaining);
          if(remaining <= 0){
            clearInterval(tick);
            leftEl.textContent = 'Done!';
            // 3-beep finish
            beepSeries(3);
            box.animate([{opacity:1},{opacity:.3},{opacity:1}], {duration:600, iterations:2});
          }
        }, 1000);
      }, 3*220 + 120);
    });

    stop?.addEventListener('click', ()=>{
      clearInterval(tick);
      show(parseInt(input?.value||'0',10));
    });

    input?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ start?.click(); } });
  });
}

/* ========= EXPORT / IMPORT / RESET ========= */
document.getElementById('btnExport')?.addEventListener('click', ()=>{
  const dump = {};
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k && k.startsWith(NS)){ dump[k] = localStorage.getItem(k); }
  }
  const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'freefitfuel-workouts-backup.json';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

document.getElementById('importFile')?.addEventListener('change', (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(String(reader.result||'{}'));
      Object.keys(obj).forEach(k=>{ if(k.startsWith(NS)) localStorage.setItem(k, obj[k]); });
      alert('Logs imported âœ…');
      renderPlan(); renderCal(); renderCircuits();
    }catch{ alert('Import failed â€” invalid file.'); }
  };
  reader.readAsText(file);
});

document.getElementById('btnResetAll')?.addEventListener('click', ()=>{
  if(!confirm('Delete all saved logs, PBs and preferences?')) return;
  const keys = [];
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k && k.startsWith(NS)) keys.push(k);
  }
  keys.forEach(k=>localStorage.removeItem(k));
  localStorage.removeItem(PREFS_KEY);
  PREFS = loadPrefs();
  applyPrefsToUI();
  renderPlan(); renderCal(); renderCircuits();
  alert('All logs & prefs cleared.');
});

/* ========= PREFS â†’ UI + CONTROLS ========= */
function applyPrefsToUI(){
  // Difficulty
  document.querySelectorAll('.seg [data-level]').forEach(b=>{
    b.setAttribute('aria-pressed', b.dataset.level===PREFS.level ? 'true' : 'false');
  });
  // Goal
  document.querySelectorAll('.seg [data-goal]').forEach(b=>{
    b.setAttribute('aria-pressed', b.dataset.goal===PREFS.goal ? 'true' : 'false');
  });
  // Equipment
  const e = PREFS.equip;
  const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.checked = !!val; };
  set('f-db',   e.db);
  set('f-band', e.band);
  set('f-bw',   e.bw);
  set('f-rack', e.rack);
  set('f-rings',e.rings);
}

function wireControls(){
  // Difficulty
  document.querySelectorAll('.seg [data-level]').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.seg [data-level]').forEach(x=>x.setAttribute('aria-pressed','false'));
      b.setAttribute('aria-pressed','true');
      level = b.dataset.level;
      PREFS.level = level; savePrefs(PREFS);
      renderPlan(); renderCal(); renderCircuits();
    });
  });
  // Goal
  document.querySelectorAll('.seg [data-goal]').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.seg [data-goal]').forEach(x=>x.setAttribute('aria-pressed','false'));
      b.setAttribute('aria-pressed','true');
      goal = b.dataset.goal;
      PREFS.goal = goal; savePrefs(PREFS);
      renderPlan(); renderCal(); renderCircuits();
    });
  });
  // Equipment
  ['f-db','f-band','f-bw','f-rack','f-rings'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('change', ()=>{
      PREFS.equip = filters();
      savePrefs(PREFS);
      renderPlan(); renderCal(); renderCircuits();
    });
  });
}

/* ========= MOUNT ========= */
applyPrefsToUI();   // set UI from saved prefs first
wireControls();     // then wire controls
renderPlan();
renderCal();
renderCircuits();
</script>
</body>
</html>
