<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="style.css?v=26">
  <link rel="icon" type="image/svg+xml" href="img/freefitfuel-logo.svg">

  <!-- jsPDF (load early so it's ready by click time) -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Nutrition page tweaks -->
  <style>
    .wrap{max-width:var(--maxw);margin:0 auto;padding:18px 20px}
    .section{background:var(--glass);border:1px solid var(--stroke);border-radius:14px;margin:12px 0;padding:14px}

    /* Collapsible panels */
    details.collapsible{
      border:1px solid var(--stroke);
      border-radius:14px;
      margin:12px 0;
      background:var(--glass);
      overflow:hidden;
    }
    details.collapsible > summary{
      cursor:pointer;
      font-weight:700;
      padding:14px 16px;
      list-style:none;
    }
    details.collapsible > summary::-webkit-details-marker{ display:none; }
    details.collapsible > summary::after{
      content:"‚ñ∏";
      float:right;
      transition:transform .2s ease;
    }
    details.collapsible[open] > summary::after{ transform:rotate(90deg); }

    /* Drawer content for collapsibles (renamed from .panel to avoid conflict) */
    details.collapsible > .drawer { padding:0 16px 16px 16px; }

    /* Start-empty state: hide recipe cards until a filter is chosen */
    html[data-start-empty] #recipeGrid > * { display:none !important; }
    html[data-start-empty] #clearFiltersBtn { display:none !important; }

    /* Print: expand everything */
    @media print{
      details.collapsible > summary{ display:none; }
      details.collapsible .drawer{ display:block !important; }
      details.collapsible{ border:none; }
    }

    /* Recipe grid */
    #recipeGrid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    #recipeGrid .card{padding:10px 12px;border:1px solid var(--stroke);border-radius:10px;background:var(--glass);display:flex;flex-direction:column;gap:.4rem}
    #recipeGrid .card h3{font-size:1.05rem;margin:0}
    #recipeGrid .card .meta{font-size:.9rem;color:var(--inkdim)}
    #recipeGrid .card .mini-nav{display:flex;flex-wrap:wrap;gap:.3rem}
    #recipeGrid .card .mini-nav .chip{background:var(--glass);border:1px solid var(--stroke);border-radius:999px;padding:.2rem .5rem;font-size:.78rem}
    #recipeGrid .card .btn{font-size:.85rem;padding:.4rem .6rem}
    #recipeGrid .card img, #recipeGrid img.card-img{display:none !important}

    /* Filter chips */
    #filterChips{display:flex;flex-wrap:wrap;gap:.5rem;margin:.75rem 0 1rem}
    #filterChips .chip{background:var(--glass);border:1px solid var(--stroke);color:var(--ink);padding:.45rem .8rem;border-radius:999px;font-size:.92rem;cursor:pointer}
    #filterChips .chip[aria-pressed="true"]{background:var(--accent);color:#111;font-weight:800}

    /* Off-canvas panels (unchanged) */
    .panel{position:fixed;top:0;right:0;height:100%;width:min(420px,100%);background:#0b0f14;color:var(--ink);
      border-left:1px solid var(--stroke);transform:translateX(100%);transition:transform .25s ease;z-index:1000;overflow:auto}
    .panel.open{transform:translateX(0)}
    .panel .panel-header{position:sticky;top:0;background:#0b0f14;border-bottom:1px solid var(--stroke);padding:12px}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .2s;z-index:900}
    .overlay.show{opacity:1;pointer-events:auto}

    /* Dialog modal base */
    dialog.recipe-modal{width:min(900px,96vw);max-height:90vh;border:0;border-radius:12px;padding:0;background:#0b0f14;color:var(--ink);z-index:3000}
    dialog.recipe-modal::backdrop{background:rgba(0,0,0,.5)}
    dialog.recipe-modal.fallback-open{
      position:fixed; top:5vh; left:50%; transform:translateX(-50%);
      width:min(900px,96vw); max-height:90vh; overflow:auto;
      display:block; border:0; border-radius:12px; padding:0; background:#0b0f14; z-index:3000;
    }
    .recipe-modal .modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--stroke)}
    .recipe-modal .modal-body{padding:14px 16px}
    .recipe-modal h2{margin:.2rem 0}
    .recipe-modal .meta{color:var(--inkdim)}
    .recipe-modal .cols{display:grid;gap:12px;grid-template-columns:1fr 2fr}
    @media (max-width:700px){ .recipe-modal .cols{grid-template-columns:1fr} }
    .recipe-modal ul{margin:.4rem 0 .6rem .9rem}
    .recipe-modal .btn-row{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.6rem}

    /* PDF download button */
    .pdf-download { margin: 20px 0; text-align: center; }
    .pdf-download a {
      display: inline-block; padding: 12px 20px; background-color: #FF6A00;
      color: #fff; text-decoration: none; font-weight: bold; border-radius: 6px;
      transition: background 0.2s ease-in-out;
    }
    .pdf-download a:hover { background-color: #e55e00; }

    /* --- Mobile tidy-up just for the calculator (overrides inline styles) --- */
    @media (max-width: 600px){
      #macro-calc .drawer{ padding:12px 12px 16px; }
      #macro-calc .section{ padding:12px; }
      #macro-calc .seg{ display:flex; flex-wrap:wrap; gap:.4rem .5rem; }
      #macro-calc .goal-chip{ margin:0; }
      #macro-calc .grid{ display:grid !important; grid-template-columns:1fr 1fr !important; gap:10px !important; }
      #macro-calc label{ font-size:.95rem; }
      #macro-calc .input, #macro-calc select{ font-size:.95rem; height:38px; padding:8px 10px; }
      #macro-calc #bfWrap, #macro-calc #targetBfWrap{ grid-column:1 / -1; }
      #macro-calc .btns-row{ display:grid !important; grid-template-columns:1fr 1fr; gap:10px !important; align-items:stretch !important; }
      #macro-calc .btns-row #generatePDF{ grid-column:1 / -1; }
      #macro-calc .btn{ padding:.55rem .8rem; font-size:.95rem; }
    }
    @media (max-width: 360px){
      #macro-calc .grid{ grid-template-columns:1fr !important; }
      #macro-calc .btns-row{ grid-template-columns:1fr; }
    }
  </style>

  <title>FreeFitFuel Nutrition ‚Äî Recipes, Macros & Hydration</title>
  <meta name="description" content="Free healthy recipes, macro breakdowns, hydration trackers and meal ideas. Balanced nutrition to fuel strength, weight loss and wellbeing.">
  <meta property="og:title" content="FreeFitFuel Nutrition ‚Äî Recipes, Macros & Hydration">
  <meta property="og:description" content="Budget-friendly recipes with macro tracking and hydration support. Vegetarian & vegan options included.">
  <meta property="og:image" content="https://www.freefitfuel.com/img/nutrition-hero.png">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://www.freefitfuel.com/nutrition.html">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="FreeFitFuel Nutrition ‚Äî Recipes, Macros & Hydration">
  <meta name="twitter:description" content="Nutrition made simple: free recipes, hydration logs & macro breakdowns.">
  <meta name="twitter:image" content="https://www.freefitfuel.com/img/nutrition-hero.png">
</head>
<body>

<!-- Shared header mount -->
<div id="site-header"></div>
<script src="/js/header-loader.js"></script>

<header class="hero-mini" role="banner" aria-label="Nutrition hero">
  <figure>
    <img src="img/nutrition-hero.png" alt="Fresh colourful food ingredients on a table">
    <div class="overlay" aria-hidden="true"></div>
  </figure>
  <div class="content wrap">
    <h1><span class="accent">Fuel That Fits Your Life</span></h1>
    <p>Balanced macros, budget-friendly recipes, Pantry mode, and a simple planner.</p>
    <div class="cta-row">
      <a class="btn" href="#macro-calc">Start Calculator</a>
      <a class="btn" href="pdf/macro-cheatsheet.pdf">Macro Cheat Sheet (PDF)</a>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- CALCULATOR (collapsible) -->
  <details id="macro-calc" class="collapsible" open>
    <summary>Calories & Macros Calculator</summary>
    <div class="drawer">

      <div class="toolbar" aria-label="Goal selector">
        <div class="seg" role="tablist" aria-label="Goal">
          <button role="tab" class="goal-chip" aria-pressed="true"  data-goal="Maintain">Maintain</button>
          <button role="tab" class="goal-chip" aria-pressed="false" data-goal="Cut">Cut</button>
          <button role="tab" class="goal-chip" aria-pressed="false" data-goal="Build/Bulk">Build/Bulk</button>
          <button role="tab" class="goal-chip" aria-pressed="false" data-goal="Transform">Transform (Recomposition)</button>
        </div>
      </div>
      
      <div class="grid">
        <label>Sex
          <select id="bmrSex" class="input"><option value="male">Male</option><option value="female">Female</option></select>
        </label>
        <label>Age (years)
          <input id="bmrAge" class="input" type="number" min="13" max="90" value="30">
        </label>
        <label>Height (cm)
          <input id="bmrHeight" class="input" type="number" min="120" max="220" value="175">
        </label>
        <label>Weight (kg)
          <input id="bmrWeight" class="input" type="number" min="35" max="250" value="75">
        </label>
        <label>Activity
          <select id="bmrActivity" class="input">
            <option value="1.2">Sedentary (x1.2)</option>
            <option value="1.375">Light (x1.375)</option>
            <option value="1.55" selected>Moderate (x1.55)</option>
            <option value="1.725">Very active (x1.725)</option>
            <option value="1.9">Athlete (x1.9)</option>
          </select>
        </label>

        <!-- Katch‚ÄìMcArdle toggle + input -->
        <label style="grid-column:1 / -1; display:flex; align-items:center; gap:.5rem;">
          <input type="checkbox" id="useBodyFat"> I know my body fat %
        </label>

        <label id="bfWrap" style="grid-column:1 / -1; display:none;">
          Body Fat % 
          <input id="bodyFat" class="input" type="number" min="1" max="70" step="0.1" style="max-width:140px; margin-left:.5rem">
        </label>

        <!-- Target Body Fat % (optional) -->
        <label id="targetBfWrap" style="grid-column:1 / -1;">
          Target Body Fat %
          <input id="targetBodyFat" class="input" type="number" min="6" max="40" step="0.5" value="10" style="max-width:140px; margin-left:.5rem">
          <span class="meta" style="margin-left:.5rem">Optional ‚Äî used for phase planning & the PDF</span>
        </label>

        <div class="btns-row">
  <button id="calcNow" class="btn">Calculate</button>
  <button id="calcCopy" class="btn">Copy</button>
  <button id="generatePDF" class="btn">Generate My Roadmap (PDF)</button>
  <a id="openWorkoutPlan" class="btn" href="workout-plan.html">Open My Workout Plan</a>
</div>
      </div>

      <div class="section" style="margin-top:.8rem">
        <h3>Your targets</h3>
        <p class="meta" id="goalLine">Goal: <strong>Maintain</strong> ‚Äî based on Mifflin‚ÄìSt Jeor + activity</p>
        <div class="grid" style="grid-template-columns:repeat(4,1fr)">
          <div><strong>Calories</strong><br><span id="outKcal">‚Äî</span> kcal/day</div>
          <div><strong>Protein</strong><br><span id="outProtein">‚Äî</span> g/day</div>
          <div><strong>Carbs</strong><br><span id="outCarbs">‚Äî</span> g/day</div>
          <div><strong>Fat</strong><br><span id="outFat">‚Äî</span> g/day</div>
        </div>
      </div>

      <div class="pdf-download">
        <a href="/pdf/weight-loss-explained.pdf" target="_blank">üìÑ Download: How Weight Loss Works (PDF)</a>
      </div>

      <div class="pdf-download">
        <a href="/pdf/bulk-cut-maintain-recomp.pdf" target="_blank">üìÑ Download: Bulk, Cut, Maintain and Recomposition Explained (PDF)</a>
      </div>

    </div>
  </details>

  <!-- WEEK SUMMARY (collapsible) -->
  <details id="week-plan" class="collapsible">
    <summary>This Week‚Äôs Plan</summary>
    <div class="drawer">

      <div style="display:flex;justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap">
        <h2 style="margin:0;font-size:1.1rem">Planner Summary</h2>
        <div>
          <button id="weekAutoBtn" class="btn">Auto-plan Week (no duplicates)</button>
          <button id="weekClearBtn" class="btn">Clear Week</button>
        </div>
      </div>

      <p class="meta" style="margin:.4rem 0">Swap any slot to rotate in a different unique recipe. This summary mirrors the planner panel.</p>
      <div id="weekSummaryGrid" class="grid" style="grid-template-columns:repeat(4,1fr)"></div>

    </div>
  </details>

  <!-- TOOLS -->
  <section class="section" aria-label="Recipe tools">
    <div class="grid" style="grid-template-columns:2fr 1fr">
      <div>
        <label for="recipeSearch" class="visually-hidden">Search recipes</label>
        <input id="recipeSearch" class="input" type="search" placeholder="Search recipes, ingredients, tags‚Ä¶">
      </div>
      <div style="display:flex;gap:.6rem;justify-content:flex-end;align-items:center;">
        <button id="pantryOpenBtn" class="btn">Pantry</button>
        <button id="openPlannerBtn" class="btn">Open Meal Planner</button>
      </div>
    </div>

    <div id="filterChips" role="toolbar" aria-label="Recipe filters">
      <!-- No default selection; ALL is available but not pressed -->
      <button class="chip" data-filter="ALL" aria-pressed="false">ALL</button>
      <!-- JS appends the rest -->
    </div>

    <p id="recipeCount" class="meta" aria-live="polite">Choose a filter to begin</p>
    <button id="exportIndexBtn" class="btn">Export Index</button>
    <button id="clearFiltersBtn" class="btn" style="display:none">Clear filters</button>
  </section>

  <!-- GRID -->
  <section class="section">
    <div id="recipeGrid" class="grid" aria-live="polite" aria-busy="false"></div>
  </section>

  <!-- INFO -->
  <section class="section">
    <div class="grid">
      <article class="card">
        <h3>Macros 101</h3>
        <p>Protein rebuilds muscle; carbs fuel effort; fats support hormones and vitamins.</p>
      </article>
      <article class="card">
        <h3>Hydration</h3>
        <p>Guide: ~30‚Äì35 ml/kg/day. Add ~500‚Äì1000 ml around workouts depending on sweat and duration.</p>
        <div class="calc" style="margin-top:.6rem">
          <label>Your weight (kg)
            <input id="hydrWeight" type="number" value="75" class="input" style="max-width:100px">
          </label>
          <button id="hydrCalc" class="btn">Calculate</button>
        </div>
        <p class="meta" id="hydrOut">Daily target: ‚Äî ml</p>
      </article>
    </div>
  </section>

  <section class="section">
    <h2>Important Note</h2>
    <p>The content on FreeFitFuel‚Ñ¢ is for general fitness education only and isn‚Äôt a substitute for personalised medical advice. Consult a qualified professional before starting a new programme, especially if you have any health conditions or injuries. Stop any exercise that causes sharp pain, dizziness, chest pain, or unusual shortness of breath.</p>
  </section>
</main>

<!-- FOOTER -->
<footer class="site-footer">
  <div class="container">
    <img src="img/freefitfuel-logo.svg" alt="FreeFitFuel Logo" height="64">
    <p>&copy; 2025 FreeFitFuel‚Ñ¢ ¬∑ All rights reserved.</p>
    <p class="credit">Created by Grant Cameron Anthony</p>
  </div>
</footer>

<!-- Panels & modal shells -->
<aside id="pantryPanel" class="panel" aria-hidden="true"></aside>
<aside id="plannerPanel" class="panel" aria-hidden="true"></aside>

<!-- Keep dialog present; JS fills its contents if empty -->
<dialog id="recipeModal" class="recipe-modal" aria-hidden="true"></dialog>

<div id="printArea" hidden></div>
<div id="overlay" class="overlay"></div>

<!-- Inline scripts (burger + calculators) -->
<script>
/* ===========================
   Nutrition page inline JS
   - Burger menu
   - Macros calculator (Mifflin / Katch‚ÄìMcArdle if BF% provided)
   - Copy results
   - Hydration calculator
   - Roadmap PDF generator with STAGED approach
   - Saves roadmap JSON to localStorage: fff_roadmap_v2
   =========================== */

document.addEventListener('DOMContentLoaded', () => {
  /* ---------- Burger / Mobile nav ---------- */
  const btn = document.querySelector('.hamburger');
  const nav = document.querySelector('.main-nav');
  if (btn && nav) {
    btn.addEventListener('click', () => {
      const open = btn.classList.toggle('active');
      nav.classList.toggle('open', open);
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
    });
  }

  /* ---------- Calculator (goals + BMR/TDEE) ---------- */
  const goalChips = [...document.querySelectorAll('.goal-chip')];
  let GOAL = 'Maintain';

  goalChips.forEach(b => b.addEventListener('click', () => {
    goalChips.forEach(x => x.setAttribute('aria-pressed', 'false'));
    b.setAttribute('aria-pressed', 'true');
    GOAL = b.dataset.goal;
    update();
  }));

  const sex = document.getElementById('bmrSex'),
        age = document.getElementById('bmrAge'),
        ht  = document.getElementById('bmrHeight'),
        wt  = document.getElementById('bmrWeight'),
        act = document.getElementById('bmrActivity'),
        useBodyFat = document.getElementById('useBodyFat'),
        bodyFat = document.getElementById('bodyFat'),
        bfWrap  = document.getElementById('bfWrap'),
        targetBFInput = document.getElementById('targetBodyFat');

  const outK = document.getElementById('outKcal'),
        outP = document.getElementById('outProtein'),
        outC = document.getElementById('outCarbs'),
        outF = document.getElementById('outFat'),
        goalLine = document.getElementById('goalLine');

  if (useBodyFat) {
    useBodyFat.addEventListener('change', () => {
      bfWrap.style.display = useBodyFat.checked ? 'block' : 'none';
      update();
    });
    if (bodyFat) bodyFat.addEventListener('input', update);
  }
  if (targetBFInput) targetBFInput.addEventListener('input', () => { /* stage planner uses this later */ });

  function calcBMR(s, kg, cm, yrs) {
    // If BF% present, use Katch‚ÄìMcArdle
    if (useBodyFat && useBodyFat.checked) {
      const bf = parseFloat(bodyFat?.value || 0);
      if (bf > 0 && bf < 70 && kg > 0) {
        const lbm = kg * (1 - bf/100);
        return 370 + (21.6 * lbm);
      }
    }
    // Mifflin‚ÄìSt Jeor
    return s === 'male'
      ? 10 * kg + 6.25 * cm - 5 * yrs + 5
      : 10 * kg + 6.25 * cm - 5 * yrs - 161;
  }

  function targetsFromTDEE(tdee, goal) {
    let kcal = tdee;
    if (goal === 'Cut') kcal = tdee * 0.82;
    if (goal === 'Build/Bulk') kcal = tdee * 1.15;
    if (goal === 'Transform') kcal = tdee * 0.97;

    const kg = parseFloat(wt.value || 0);
    // Protein per kg shifts by phase
    let p_perkg = 1.6;
    if (goal === 'Cut') p_perkg = 2.0;
    if (goal === 'Build/Bulk') p_perkg = 1.8;
    if (goal === 'Transform') p_perkg = 2.2;

    const protein_g = Math.round(Math.max(1, p_perkg) * kg);

    // Macro splits by phase (carb bias for performance; fat steady)
    let carb_pct = 0.50, fat_pct = 0.30;
    if (goal === 'Cut')       { carb_pct = 0.40; fat_pct = 0.30; }
    if (goal === 'Build/Bulk'){ carb_pct = 0.55; fat_pct = 0.25; }
    if (goal === 'Transform') { carb_pct = 0.45; fat_pct = 0.30; }

    const carbs_g = Math.round((kcal * carb_pct) / 4);
    const fat_g   = Math.round((kcal * fat_pct) / 9);

    return { kcal: Math.round(kcal), protein_g, carbs_g, fat_g };
  }

  function update() {
    const kg  = parseFloat(wt.value || 0);
    const cm  = parseFloat(ht.value || 0);
    const yrs = parseFloat(age.value || 0);
    const s   = sex.value;
    const actMult = parseFloat(act.value || 1);

    const bmr  = calcBMR(s, kg, cm, yrs);
    const tdee = bmr * actMult;
    const t    = targetsFromTDEE(tdee, GOAL);

    outK.textContent = t.kcal.toString();
    outP.textContent = t.protein_g + ' g';
    outC.textContent = t.carbs_g + ' g';
    outF.textContent = t.fat_g + ' g';

    const used = (useBodyFat && useBodyFat.checked && parseFloat(bodyFat?.value || 0) > 0)
      ? 'Katch‚ÄìMcArdle (uses body fat %)'
      : 'Mifflin‚ÄìSt Jeor';
    goalLine.innerHTML = `Goal: <strong>${GOAL}</strong> ‚Äî based on ${used} + activity`;
  }

  document.getElementById('calcNow').addEventListener('click', update);
  document.getElementById('calcCopy').addEventListener('click', () => {
    const txt = `Goal: ${GOAL}
Calories: ${outK.textContent} kcal
Protein: ${outP.textContent}
Carbs: ${outC.textContent}
Fat: ${outF.textContent}`;
    navigator.clipboard.writeText(txt);
    alert('Copied targets to clipboard.');
  });
  update();

  /* ---------- Hydration ---------- */
  const hydrBtn = document.getElementById('hydrCalc');
  const hydrOut = document.getElementById('hydrOut');
  const hydrW   = document.getElementById('hydrWeight');

  function calcHydr() {
    const kg = parseFloat(hydrW.value || 0);
    if (!kg) { hydrOut.textContent = 'Daily target: ‚Äî ml'; return; }
    const low  = Math.round(kg * 30), high = Math.round(kg * 35);
    hydrOut.textContent = `Daily target: ${low} ‚Äì ${high} ml (‚âà ${(low/1000).toFixed(1)} ‚Äì ${(high/1000).toFixed(1)} L, plus extra if training)`;
  }
  if (hydrBtn) hydrBtn.addEventListener('click', calcHydr);
  if (hydrW)   hydrW.addEventListener('input', calcHydr);
  calcHydr();

  /* ---------- PDF + Roadmap generator (staged) ---------- */

  // Ensure jsPDF is ready (robust CDN+local fallback)
  function ensureJsPDF() {
    return new Promise((resolve, reject) => {
      if (window.jspdf && window.jspdf.jsPDF) return resolve(true);
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
      s.onload = () => resolve(!!(window.jspdf && window.jspdf.jsPDF));
      s.onerror = () => {
        const l = document.createElement('script');
        l.src = '/assets/js/jspdf.umd.min.js';
        l.onload = () => resolve(!!(window.jspdf && window.jspdf.jsPDF));
        l.onerror = () => reject(new Error('jsPDF failed to load from CDN and local'));
        document.head.appendChild(l);
      };
      document.head.appendChild(s);
    });
  }

  // Helpers for stage planning
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const approxWeeks = (min, max, adherence=1)=> {
    // adherence: 1 (good) ‚Üí range as given; <1 ‚Üí expand; >1 ‚Üí contract slightly
    const adj = (w)=>Math.round(clamp(w / adherence, 1, 40));
    return { min: adj(min), max: adj(max) };
  };

  function inferStartBF() {
    // prefer user BF%; else rough BMI inflow (very rough)
    const kg = parseFloat(wt.value || 0);
    const cm = parseFloat(ht.value || 0);
    const bf = (useBodyFat && useBodyFat.checked) ? parseFloat(bodyFat?.value || 0) : NaN;
    if (!isNaN(bf) && bf > 0) return bf;

    // crude Deurenberg-style estimate: BF% ‚âà 1.20*BMI + 0.23*age - 10.8*sex - 5.4
    // sex: male=1, female=0
    const m  = (parseFloat(sex.value) || 0);
    const BMI = (kg && cm) ? kg / Math.pow(cm/100, 2) : NaN;
    const A = parseFloat(age.value || 0);
    if (isNaN(BMI) || !isFinite(BMI)) return NaN;
    const s = (sex.value === 'male') ? 1 : 0;
    return Math.round((1.20*BMI + 0.23*A - 10.8*s - 5.4) * 10) / 10;
  }

  // Build stage ‚Üí program (push/pull/legs/core) with per-stage variations (no machines)
  function buildProgram(stageId) {
    // Common rest presets & RIR scales will differ by stage
    // Stages: cut, transform, maintain, bulk
    const R = {
      cut:       { mainSets: '3‚Äì4',  accSets: '2‚Äì3', mainReps: '6‚Äì10', accReps: '10‚Äì15', mainRIR: '2‚Äì3', accRIR: '1‚Äì2', restMain: 90, restAcc: 45,
                   cardio: { lissPerWeek: '2‚Äì4√ó 20‚Äì35 min', hiit: '0‚Äì1√ó 6‚Äì10 rounds (30s / 60s)' } },
      transform: { mainSets: '3‚Äì4',  accSets: '3',   mainReps: '6‚Äì10', accReps: '8‚Äì12',  mainRIR: '1‚Äì2', accRIR: '1‚Äì2', restMain: 90, restAcc: 60,
                   cardio: { lissPerWeek: '1‚Äì3√ó 20‚Äì30 min', hiit: '0‚Äì1√ó 6‚Äì8 rounds' } },
      maintain:  { mainSets: '3‚Äì4',  accSets: '2‚Äì3', mainReps: '6‚Äì10', accReps: '8‚Äì12',  mainRIR: '1‚Äì2', accRIR: '1‚Äì2', restMain: 90, restAcc: 60,
                   cardio: { lissPerWeek: '1‚Äì2√ó 20‚Äì25 min', hiit: 'optional easy intervals' } },
      bulk:      { mainSets: '4‚Äì5',  accSets: '3‚Äì4', mainReps: '5‚Äì8',  accReps: '8‚Äì12',  mainRIR: '0‚Äì2 (last set 0‚Äì1)', accRIR: '1‚Äì2', restMain: 120, restAcc: 75,
                   cardio: { lissPerWeek: '0‚Äì2√ó 15‚Äì20 min (easy)', hiit: 'generally skip' } }
    }[stageId];

    const ex = (name, type, kind='main', alts=[]) => {
      const sets = (kind==='main') ? R.mainSets : R.accSets;
      const reps = (kind==='main') ? R.mainReps : R.accReps;
      const rir  = (kind==='main') ? R.mainRIR : R.accRIR;
      const rest = (kind==='main') ? R.restMain : R.restAcc;
      return { name, type, sets, reps, rir, rest, alts };
    };

    // Distinct flavour per stage (progressively harder/stronger biases)
    if (stageId === 'cut') {
      return {
        split: ["Mon Push","Tue Pull","Wed Rest / Easy Cardio","Thu Legs","Fri Core & Conditioning","Sat Optional LISS","Sun Rest"],
        programByDay: {
          0: [
            ex('Push-up (hands elevated if needed)','compound','main',['DB Floor Press','Kneeling Push-up','Band Press']),
            ex('Pike Push-up','compound','main',['DB Strict Press','Elevated Pike','Wall HS Hold (accum.)']),
            ex('Dip (bench/box)','accessory','acc',['Close-grip Push-up','Band OH Triceps']),
            ex('Lateral Raise (DB/band)','accessory','acc',['Y-Raise (floor)','Wall Slides'])
          ],
          1: [
            ex('Inverted Row (table/TRX)','compound','main',['One-arm DB Row','Band Row']),
            ex('Chin-up / Band-assist','compound','main',['Negative Chin-up','Mixed-grip Inverted Row']),
            ex('Rear-delt Fly (DB/band)','accessory','acc',['Face Pull (band)']),
            ex('Curl (DB/band)','accessory','acc',['Hammer Curl','Zottman Curl'])
          ],
          2: [ { name:'LISS (walk/easy bike/row)', type:'cardio', duration_min:30, cue:'Conversational pace' } ],
          3: [
            ex('Goblet Squat','compound','main',['Split Squat','Box Squat (BW)']),
            ex('Romanian Deadlift (DB)','compound','main',['Band Hip Hinge','Good Morning (band)']),
            ex('Reverse Lunge','accessory','acc',['Step-back Lunge','Split Squat']),
            ex('Calf Raise (single-leg)','accessory','acc',['Seated Calf Raise (DB on knee)'])
          ],
          4: [
            ex('Ab-Wheel / Walk-outs','accessory','acc',['Plank (3√ó30‚Äì45s)','Dead Bug']),
            { name:'Carry (farmer/one-side)', type:'accessory', sets:4, reps:'20‚Äì40m', rir:'‚Äî', rest:60, alts:['Suitcase Hold 20‚Äì40s/side'] },
            { name:'Intervals (bike/run/row)', type:'cardio', work_s:30, rest_s:60, rounds:8, cue:'Leave 2‚Äì3 RIR (not all-out)' }
          ],
          5: [ { name:'Optional LISS', type:'cardio', duration_min:35, cue:'Nasal breathing only' } ],
          6: []
        }
      };
    }

    if (stageId === 'transform') {
      return {
        split: ["Mon Push","Tue Pull","Wed Rest / Easy Cardio","Thu Legs","Fri Core & Conditioning","Sat Optional LISS","Sun Rest"],
        programByDay: {
          0: [
            ex('Deficit Push-up (feet elevated)','compound','main',['Standard Push-up','DB Bench on Floor']),
            ex('DB Shoulder Press (standing)','compound','main',['Pike Push-up','Half-kneeling Press']),
            ex('Close-grip Push-up','accessory','acc',['Diamond Push-up','Band Press-down']),
            ex('Lateral Raise (DB/band)','accessory','acc',['Lean-away Raise','Y-Raise'])
          ],
          1: [
            ex('Pull-up (band as needed)','compound','main',['Chin-up','Chest-to-bar Eccentrics']),
            ex('Chest-supported DB Row','compound','main',['One-arm DB Row','Band Row']),
            ex('Rear-delt Fly (high reps)','accessory','acc',['Face Pull (band)']),
            ex('Curl (alternating DB)','accessory','acc',['Hammer Curl'])
          ],
          2: [ { name:'LISS or Brisk Walk', type:'cardio', duration_min:25, cue:'Easy-moderate' } ],
          3: [
            ex('Front-loaded Squat (goblet)','compound','main',['Tempo Squat (3s down)','Split Squat']),
            ex('DB RDL (pause 1s bottom)','compound','main',['B-Stance RDL','Hip Hinge (band)']),
            ex('Walking Lunge','accessory','acc',['Reverse Lunge']),
            ex('Calf Raise (tempo 2‚Äì1‚Äì2)','accessory','acc',['Single-leg Raise'])
          ],
          4: [
            ex('Hanging Knee Raise','accessory','acc',['Dead Bug','RKC Plank 3√ó20‚Äì30s']),
            { name:'Intervals (moderate)', type:'cardio', work_s:30, rest_s:60, rounds:6, cue:'Finish with 1‚Äì2 RIR' },
            { name:'Carry (suitcase)', type:'accessory', sets:3, reps:'20‚Äì40m/side', rir:'‚Äî', rest:60, alts:['Front Rack Carry (DB)'] }
          ],
          5: [ { name:'Optional LISS', type:'cardio', duration_min:25, cue:'Very easy' } ],
          6: []
        }
      };
    }

    if (stageId === 'maintain') {
      return {
        split: ["Mon Push","Tue Pull","Wed Rest","Thu Legs","Fri Core","Sat Optional LISS","Sun Rest"],
        programByDay: {
          0: [
            ex('Push-up (weighted/backpack)','compound','main',['Feet-elevated Push-up']),
            ex('DB Strict Press','compound','main',['Pike Push-up']),
            ex('Dips (bench)','accessory','acc',['Close-grip Push-up']),
            ex('Lateral Raise','accessory','acc',['Band Lateral Raise'])
          ],
          1: [
            ex('Pull-up (bodyweight)','compound','main',['Chin-up','Band Assist']),
            ex('One-arm DB Row (heavy)','compound','main',['Chest-supported DB Row']),
            ex('Rear-delt Fly','accessory','acc',['Face Pull (band)']),
            ex('Curl','accessory','acc',['Hammer Curl'])
          ],
          2: [],
          3: [
            ex('Goblet Squat (heavier)','compound','main',['Tempo Squat']),
            ex('RDL (DB)','compound','main',['Hip Thrust (DB)','Good Morning (band)']),
            ex('Reverse Lunge','accessory','acc',['Walking Lunge']),
            ex('Calf Raise','accessory','acc',['Single-leg Raise'])
          ],
          4: [
            ex('Ab-Wheel / Walk-outs','accessory','acc',['Plank','Dead Bug']),
            { name:'Carry (farmer/one-side)', type:'accessory', sets:3, reps:'20‚Äì40m', rir:'‚Äî', rest:60, alts:['Suitcase Hold 20‚Äì40s'] },
            { name:'Optional Intervals (easy)', type:'cardio', work_s:20, rest_s:60, rounds:6, cue:'Stay fresh' }
          ],
          5: [ { name:'Optional LISS', type:'cardio', duration_min:20, cue:'Easy' } ],
          6: []
        }
      };
    }

    // bulk
    return {
      split: ["Mon Push","Tue Pull","Wed Legs","Thu Push (strength)","Fri Pull (strength)","Sat Optional Arms/Core","Sun Rest"],
      programByDay: {
        0: [
          ex('Weighted Push-up (backpack)','compound','main',['DB Floor Press']),
          ex('DB Shoulder Press (standing)','compound','main',['Half-kneeling Press']),
          ex('Dip (bench)','accessory','acc',['Close-grip Push-up']),
          ex('Lateral Raise (high volume)','accessory','acc',['Lean-away Raise'])
        ],
        1: [
          ex('Pull-up (added load if ready)','compound','main',['Chin-up']),
          ex('Chest-supported DB Row (heavy)','compound','main',['One-arm DB Row']),
          ex('Rear-delt Fly (slow)','accessory','acc',['Face Pull (band)']),
          ex('Curl (strict)','accessory','acc',['Hammer Curl'])
        ],
        2: [
          ex('Goblet Squat (heavy)','compound','main',['Front Rack DB Squat']),
          ex('DB RDL (heavy)','compound','main',['B-Stance RDL']),
          ex('Split Squat (rear foot elevated)','accessory','acc',['Reverse Lunge']),
          ex('Calf Raise (heavy)','accessory','acc',['Single-leg Raise'])
        ],
        3: [
          ex('Push-up (deficit or weight)','compound','main',['DB Floor Press']),
          ex('DB Shoulder Press (top set + back-offs)','compound','main',['Pike Push-up']),
          ex('Dips','accessory','acc',['Close-grip Push-up']),
          ex('Lateral Raise (rest-pause)','accessory','acc',['Band Ladder Raise'])
        ],
        4: [
          ex('Pull-up (top set + back-offs)','compound','main',['Chin-up']),
          ex('Row (heavy strict)','compound','main',['One-arm DB Row']),
          ex('Rear-delt Fly','accessory','acc',['Face Pull']),
          ex('Curl (slow eccentrics)','accessory','acc',['Hammer Curl'])
        ],
        5: [
          ex('Curls (variety superset)','accessory','acc',['Alt. DB Curl / Band Curl']),
          ex('Triceps OH Extension (DB/band)','accessory','acc',['Diamond Push-up']),
          ex('Ab-Wheel / Walk-outs','accessory','acc',['Plank']),
          { name:'Optional Easy LISS', type:'cardio', duration_min:15, cue:'Stay easy, recovery focus' }
        ],
        6: []
      }
    };
  }

  // Given start and target BF, build staged list with targets + durations (adjusted by activity)
  function buildStagesFlow(startBF, userTargetBF, actMult, userOverrideFlow=null) {
    const stages = [];
    const youtubeTip = 'For exercise form, search YouTube: exercise name + ‚Äúform‚Äù.';
    const restPresets = [10,30,45,60,90];

    // Adherence proxy from activity (sedentary likely slower progress)
    let adherence = 1.0;
    if      (actMult <= 1.25) adherence = 0.8;
    else if (actMult <= 1.45) adherence = 0.9;
    else if (actMult >= 1.75) adherence = 1.1;

    // Default staged logic (may be overridden)
    // If high BF% (‚â•30%), we‚Äôll suggest Cut -> Transform -> Maintain (hold) -> Lean Bulk (optional)
    const flow = userOverrideFlow || (
      (startBF && startBF >= 30)
        ? ['cut','transform','maintain','bulk']
        : ['transform','maintain','bulk']
    );

    // Stage targets
    const targets = {
      cut:       (s,t) => `~${Math.max(t ?? 24, s ? Math.ceil(s - 4) : 26)}%`,  // rough next plateau
      transform: (s,t) => `~${Math.max(t ?? 20, 20)}%`,
      maintain:  (s,t) => `Hold current`,
      bulk:      (s,t) => (t ? `+1‚Äì2% from ${t}% end` : `+1‚Äì2% from end`)
    };

    // Durations (weeks) ‚Äî adjusted for adherence proxy
    const baseDur = {
      cut:       { min: 6,  max: 14 },
      transform: { min: 8,  max: 16 },
      maintain:  { min: 2,  max: 4  },
      bulk:      { min: 8,  max: 16 }
    };

    for (const id of flow) {
      const bw = approxWeeks(baseDur[id].min, baseDur[id].max, adherence);
      const program = buildProgram(id);
      stages.push({
        id,
        name: id==='cut' ? 'Cutting' : id==='transform' ? 'Transform (Recomp)' : id==='maintain' ? 'Maintenance (Hold)' : 'Lean Bulk',
        bf_target: targets[id](startBF, userTargetBF),
        weeks_min: bw.min,
        weeks_max: bw.max,
        blurb:
          id==='cut' ? 'Calorie deficit, protein priority, progressive overload. LISS 2‚Äì4√ó/week; optional short intervals.' :
          id==='transform' ? 'Small deficit near maintenance. Keep lifts progressing. Add steps/easy cycling.' :
          id==='maintain' ? 'Calories at/near TDEE; maintain strength. Low-stress conditioning.' :
          'Slight surplus. Progressive overload focus; keep conditioning easy.',
        split: program.split,
        programByDay: program.programByDay
      });
    }

    return { stages, meta: { youtubeTip, restPresets } };
  }

  // Build roadmap JSON (single-goal OR staged) and also generate the PDF pages
  async function generatePDFAndSaveRoadmap(staged) {
    const ok = (window.jspdf && window.jspdf.jsPDF) ? true : await ensureJsPDF();
    if (!ok) { alert('PDF library could not be loaded. Please refresh and try again.'); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4', compress:true });

    // Layout helpers
    const marginX = 56;
    let y = 72;
    const wrapW = 460;
    const R = n => Math.round(n);

    const line = (yy) => {
      doc.setDrawColor(255,106,0);
      doc.setLineWidth(1);
      doc.line(marginX, yy, 539, yy);
    };
    function addWrapped(text, step=16){
      const lines = doc.splitTextToSize(text, wrapW);
      for (const t of lines){
        if (y > 770) { doc.addPage(); y = 72; }
        doc.text(t, marginX, y); y += step;
      }
    }
    function newSection(pad=10) { y += pad; if (y > 730) { doc.addPage(); y = 72; } }

    // Inputs
    const kg  = parseFloat(wt.value || 0);
    const cm  = parseFloat(ht.value || 0);
    const yrs = parseFloat(age.value || 0);
    const sx  = sex.value;
    const actMult = parseFloat(act.value || 1);
    const currentBF = inferStartBF();  // may be NaN if cannot infer
    const tBFraw = parseFloat(targetBFInput?.value || '');
    const userTargetBF = !isNaN(tBFraw) && tBFraw > 0 ? tBFraw : null;

    // Baselines
    const bmr  = calcBMR(sx, kg, cm, yrs);
    const tdee = bmr * actMult;
    const lbm  = (!isNaN(currentBF)) ? (kg * (1 - currentBF/100)) : null;

    // If staged==false -> single-goal using selected GOAL with macro targets
    // If staged==true  -> create flow Cut ‚Üí Transform ‚Üí Maintain ‚Üí Bulk (or simplified) with BF targets/durations
    const flowData = buildStagesFlow(currentBF, userTargetBF, actMult, null);

    // Build ‚Äúroadmap‚Äù JSON we‚Äôll persist for the workout-plan page
    const roadmap = staged ? {
      goal: GOAL,
      startBF: isNaN(currentBF) ? null : Math.round(currentBF*10)/10,
      endBF: userTargetBF,
      stages: flowData.stages,
      meta: flowData.meta
    } : {
      goal: GOAL,
      startBF: isNaN(currentBF) ? null : Math.round(currentBF*10)/10,
      endBF: userTargetBF,
      stages: [ // single stage plan with the currently-selected GOAL and its program flavour
        (() => {
          const mapId = GOAL==='Cut' ? 'cut' : GOAL==='Build/Bulk' ? 'bulk' : GOAL==='Transform' ? 'transform' : 'maintain';
          const p = buildProgram(mapId);
          const weeks = mapId==='cut' ? {min:6,max:14} : mapId==='transform' ? {min:8,max:16} : mapId==='maintain' ? {min:2,max:4} : {min:8,max:16};
          const adj = approxWeeks(weeks.min,weeks.max, (actMult<=1.25?0.8:(actMult<=1.45?0.9:(actMult>=1.75?1.1:1.0))));
          const label = mapId==='cut' ? 'Cutting' : mapId==='transform' ? 'Transform (Recomp)' : mapId==='maintain' ? 'Maintenance (Hold)' : 'Lean Bulk';
          const bt = mapId==='cut' ? (userTargetBF ? `~${Math.max(userTargetBF, 24)}%` : '~26‚Äì28%')
                   : mapId==='transform' ? (userTargetBF ? `~${Math.max(userTargetBF, 20)}%` : '~20‚Äì22%')
                   : mapId==='maintain' ? 'Hold current'
                   : (userTargetBF ? `+1‚Äì2% from ${userTargetBF}% end` : '+1‚Äì2% from end');
          return {
            id: mapId,
            name: label,
            bf_target: bt,
            weeks_min: adj.min, weeks_max: adj.max,
            blurb: mapId==='cut' ? 'Calorie deficit, protein priority, progressive overload. LISS 2‚Äì4√ó/week; optional short intervals.'
                 : mapId==='transform' ? 'Small deficit near maintenance. Keep lifts progressing. Add steps/easy cycling.'
                 : mapId==='maintain' ? 'Calories at/near TDEE; maintain strength. Low-stress conditioning.'
                 : 'Slight surplus. Progressive overload focus; keep conditioning easy.',
            split: p.split,
            programByDay: p.programByDay
          };
        })()
      ],
      meta: flowData.meta
    };

    // Persist for the workout-plan page (GDPR-friendly, client-only)
    localStorage.setItem('fff_roadmap_v2', JSON.stringify(roadmap));

    /* -------- PDF CONTENT -------- */
    // Title
    doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.setTextColor(255,106,0);
    doc.text('Personalised Body Recomposition Roadmap', marginX, y); y += 18;
    doc.setTextColor(60); doc.setFontSize(12); doc.setFont('helvetica','normal');
    doc.text(userTargetBF ? `End target: ~${userTargetBF}% body fat` : `Goal: ${GOAL}`, marginX, y);
    y += 12; line(y+8); y += 24; newSection();

    // Baseline
    doc.setFont('helvetica','bold'); doc.setFontSize(13); doc.setTextColor(0);
    doc.text('Baseline (Your Starting Point)', marginX, y); y += 16;
    doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.setTextColor(0);
    [
      `Weight: ${kg || '‚Äî'} kg`,
      `Height: ${cm || '‚Äî'} cm`,
      `Age: ${yrs || '‚Äî'} years`,
      `Sex: ${sx==='male' ? 'Male' : 'Female'}`,
      `Body fat (approx.): ${!isNaN(currentBF) ? currentBF + '%' : '‚Äî'}`,
      `Target Body Fat: ${userTargetBF ?? '‚Äî'}`,
      `Lean Body Mass: ${lbm!==null ? (Math.round(lbm*10)/10)+' kg' : '‚Äî'}`,
      `BMR: ~${R(bmr)} kcal/day`,
      `Estimated TDEE (activity x${actMult}): ~${R(tdee)} kcal/day`,
      `Selected Goal chip: ${GOAL}`
    ].forEach(t => addWrapped('‚Ä¢ ' + t));
    newSection(8);

    // Stage index
    doc.setFont('helvetica','bold'); doc.setFontSize(13);
    doc.text(staged ? 'Stage Plan (Science-based sequence)' : 'Plan (Single Phase)', marginX, y); y += 16;
    doc.setFont('helvetica','normal'); doc.setFontSize(11);

    roadmap.stages.forEach((s, i) => {
      addWrapped(`${i+1}. ${s.name} ‚Äî BF target: ${s.bf_target}; Estimated duration: ${s.weeks_min}‚Äì${s.weeks_max} weeks`);
    });
    newSection(8);

    // Quote strip (consistency)
    doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor(0);
    addWrapped('‚ÄúWe are what we repeatedly do. Excellence, then, is not an act, but a habit.‚Äù ‚Äî Will Durant (on Aristotle)');
    addWrapped('‚ÄúThe impediment to action advances action. What stands in the way becomes the way.‚Äù ‚Äî Marcus Aurelius');
    newSection();

    // Training blueprint per stage (day-by-day)
    const youtubeTip = roadmap.meta.youtubeTip;
    roadmap.stages.forEach((stage, idx) => {
      doc.addPage(); y = 72;
      doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.setTextColor(0);
      doc.text(`Stage ${idx+1} ‚Äî ${stage.name}`, marginX, y); y += 18;

      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      addWrapped(`BF target: ${stage.bf_target}`);
      addWrapped(`Estimated duration: ${stage.weeks_min}‚Äì${stage.weeks_max} weeks`);
      addWrapped(stage.blurb);
      addWrapped(`Form tip: ${youtubeTip}`);
      newSection();

      const split = stage.split || ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
      split.forEach((label, dayI) => {
        doc.setFont('helvetica','bold'); doc.setFontSize(12);
        addWrapped(label);
        doc.setFont('helvetica','normal'); doc.setFontSize(11);

        const items = (stage.programByDay && stage.programByDay[dayI]) ? stage.programByDay[dayI] : [];
        if (!items.length) { addWrapped('‚Ä¢ Rest / No structured work today'); newSection(4); return; }

        items.forEach(it => {
          const line = (it.type==='cardio')
            ? `‚Ä¢ ${it.name} ‚Äî ${it.duration_min ? (it.duration_min+' min') : (it.rounds? it.rounds+' rounds':'' )} ${it.work_s? `(work ${it.work_s}s / rest ${it.rest_s||60}s)` : ''} ${it.cue? '‚Ä¢ '+it.cue:''}`
            : `‚Ä¢ ${it.name} ‚Äî ${it.sets||''}√ó${it.reps||''}, RIR ${it.rir||'‚Äî'}, rest ${it.rest||60}s`;
          addWrapped(line);
        });
        newSection(6);
      });
    });

    // Nutrition + Recovery quick hits
    doc.addPage(); y = 72;
    doc.setFont('helvetica','bold'); doc.setFontSize(13);
    doc.text('Nutrition & Recovery Essentials', marginX, y); y += 16;
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    [
      'Protein each meal (aim 25‚Äì45 g) across 4‚Äì5 meals/snacks.',
      'Whole-food carbs around training; veggies & fruit daily.',
      'Healthy fats: olive oil, nuts, avocado, oily fish.',
      'Hydration: ~30‚Äì35 ml/kg/day; +500‚Äì1000 ml around training.',
      'Sleep: 7‚Äì9 hours; keep a regular schedule.',
      'Steps or easy cycling add meaningful energy expenditure.'
    ].forEach(t => addWrapped('‚Ä¢ ' + t));
    newSection();

    // Footer
    const bottom = 790;
    line(bottom-20);
    doc.setFont('helvetica','normal'); doc.setTextColor(120); doc.setFontSize(10);
    doc.text('¬© 2025 FreeFitFuel‚Ñ¢ ¬∑ Client-side only. Consistency across training, nutrition, sleep and stress = success.', marginX, bottom);

    // Save
    doc.save('freefitfuel-roadmap.pdf');
  }

  // Button + popup flow (as requested):
  // - When clicking "Generate My Roadmap (PDF)", show confirm:
  //   OK  = generate single-goal (the chip the user selected)
  //   Cancel = generate staged plan (suggested flow; user can still override target BF input)
  const genBtn = document.getElementById('generatePDF');
  if (genBtn) {
    genBtn.addEventListener('click', async () => {
      if (genBtn.dataset.busy === '1') return;
      genBtn.dataset.busy = '1';
      const old = genBtn.textContent;
      genBtn.textContent = 'Preparing‚Ä¶';
      genBtn.disabled = true;

      try {
        const single = confirm(
          `Create plan for your selected goal: "${GOAL}"?\n\nPress OK for a single-phase ${GOAL} plan.\nPress Cancel for a staged plan (e.g., Cut ‚Üí Transform ‚Üí Maintain ‚Üí Lean Bulk).`
        );
        await generatePDFAndSaveRoadmap(!single);
      } catch (e) {
        console.error(e);
        alert('Error generating your roadmap. Please try again.');
      } finally {
        genBtn.dataset.busy = '0';
        genBtn.textContent = old;
        genBtn.disabled = false;
      }
    });
    // ===== Open Workout Plan redirect =====
const openBtn = document.getElementById('openWorkoutPlan');
if (openBtn) {
  openBtn.addEventListener('click', () => {
    window.location.href = 'workout-plan.html';
  });
}
  }
});
</script>

<!-- Nutrition JS -->
<script src="assets/js/nutrition.js?v=20250928b"></script>
</body>
</html>
