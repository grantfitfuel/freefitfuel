<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Personalised Workout Plan ‚Äî FreeFitFuel</title>

  <link rel="stylesheet" href="style.css?v=31">

  <style>
    :root{
      --bg:#0b0f14; --ink:#e6e6ea; --inkdim:#b7b7c2;
      --glass:#0f131a; --stroke:#1f2630; --accent:#ff6a00;
      --maxw:1100px;
    }
    body{background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Arial,sans-serif}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:18px 20px}
    h1{margin:.2rem 0 .6rem;font-size:1.8rem}
    .lead{color:var(--inkdim)}

    .section{background:var(--glass);border:1px solid var(--stroke);border-radius:14px;margin:14px 0;padding:14px}
    .section>h2{margin:.15rem 0 .6rem;font-size:1.2rem;color:var(--accent)}
    .block{background:#111418;border:1px solid var(--stroke);border-radius:12px;padding:12px;margin:.7rem 0}

    .days{display:grid;gap:12px}
    @media (min-width:780px){ .days{grid-template-columns:repeat(2,1fr)} }

    .mov{border:1px dashed var(--stroke);border-radius:10px;padding:.55rem .6rem;margin:.45rem 0}
    .mov-head{display:flex;gap:.6rem;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .mov-title a{color:var(--ink);text-decoration:underline dotted}
    .mov-title a:hover{color:var(--accent)}
    .rx{opacity:.9}
    .mov-tools{display:flex;gap:.4rem;align-items:center}
    .btn-sm{border:1px solid var(--stroke);background:var(--glass);color:var(--ink);padding:.35rem .6rem;border-radius:8px;cursor:pointer}

    .drawer{display:none;margin:.45rem 0 0}
    .drawer.open{display:block}
    .log-grid{display:grid;gap:.35rem}
    .log-row{display:grid;grid-template-columns:72px 1fr 1fr 1fr auto;gap:.35rem;align-items:center}
    .log-row input{background:#0b0f14;border:1px solid var(--stroke);border-radius:8px;color:var(--ink);padding:.38rem .45rem}
    .meta-row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin-top:.35rem}
    .pb{color:#90ee90}
    .badge{border:1px solid var(--accent);
      border-radius:999px;
      padding:.15rem .55rem;
      background:rgba(255,106,0,.15);
      color:var(--accent);
      font-size:.8rem;
      font-weight:600;
      margin-left:.4rem;}
    .quote{font-size:.92rem;color:var(--inkdim);margin-top:.25rem}

    .restbar{display:flex;align-items:center;gap:.4rem;margin:.45rem 0 .1rem;flex-wrap:wrap}
    .restbar .left{opacity:.9;min-width:44px}
    .restbar input[type="number"]{width:84px;background:#0b0f14;border:1px solid var(--stroke);border-radius:8px;color:var(--ink);padding:.34rem .45rem}

    @media (max-width:520px){
      .log-row{grid-template-columns:60px 1fr 1fr; grid-auto-rows:auto}
      .log-row input[placeholder="kg"]{grid-column:1 / span 1}
      .log-row input[placeholder="reps"]{grid-column:2 / span 1}
      .log-row input[placeholder="notes"]{grid-column:1 / span 2}
    }

    .grid{display:grid;gap:.6rem}
    .log-grid-compact{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.6rem}
    label{display:flex;align-items:center;gap:.5rem}
    input[type="checkbox"]{accent-color:var(--accent)}
    input[type="number"], input[type="text"]{
      background:#0c1118;border:1px solid var(--stroke);border-radius:8px;color:var(--ink);padding:.4rem .5rem;width:100%;
    }
    .warn{background:#23140f;border:1px solid #3a2016;color:#ffb89a;padding:.55rem .6rem;border-radius:8px}
    .ok{background:#142316;border:1px solid #203a23;color:#b9ffb9;padding:.55rem .6rem;border-radius:8px}

    /* Accordion */
    .accordion{border:1px solid var(--stroke); border-radius:12px; background:#111418; padding:12px; margin-bottom:1rem}
    .acc-head{display:flex; align-items:center; justify-content:space-between; gap:.75rem; cursor:pointer}
    .acc-toggle{all:unset; cursor:pointer; color:var(--accent); font-size:1.05rem}
    .accordion .acc-toggle::after{content:"‚ñ∏"; margin-left:.45rem; opacity:.8}
    .accordion.open .acc-toggle::after{content:"‚ñæ"; margin-left:.45rem; opacity:.8}
    .acc-body{margin-top:.5rem}
    [hidden]{display:none !important;}

    .alt-chips{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.25rem}
    .alt-chip{border:1px solid var(--stroke);border-radius:999px;padding:.15rem .55rem;
      background:rgba(255,255,255,.06);font-size:.85rem}

    /* Legend (only shown if any terms detected) */
    .legend{background:#0f131a;border:1px solid var(--stroke);border-radius:12px;padding:10px;margin:.6rem 0}
    .legend summary{cursor:pointer;color:var(--accent);font-weight:600;list-style:none}
    .legend summary::-webkit-details-marker{display:none}
    .legend .row{display:grid;grid-template-columns:140px 1fr;gap:.6rem;margin-top:.5rem}
    .legend .term{color:var(--ink);font-weight:600}
    .legend .def{color:var(--inkdim)}
    @media (max-width:520px){ .legend .row{grid-template-columns:1fr} .legend .term{opacity:.9} }
  </style>
</head>
<body>
  <div id="site-header"></div>
  <script src="/js/header-loader.js" defer></script>
  <div class="wrap">
    <h1>My Workout Plan</h1>
    <p class="lead">Client-side only. Your plan, logs, PBs and checks stay in this browser.</p>

    <section class="section">
      <h2>Daily Wellness Check</h2>
      <div class="log-grid-compact">
        <label><input type="checkbox" id="hydrDone"> Hydration hit</label>
        <label><input type="checkbox" id="sleepDone"> Sleep goal met</label>
        <label><input type="checkbox" id="macroDone"> Macros on target</label>
        <label>
          <input type="checkbox" id="activityCardio" aria-label="Did you walk, cycle or run today?">
          Walk / Bike / Run
        </label>
      </div>
      <p class="quote">Consistency across training, nutrition, sleep & stress = success.</p>
    </section>

    <section class="section">
      <h2>Your Personalised Plan</h2>

      <!-- Dynamic legend mounts here if any terms are detected -->
      <div id="legendMount"></div>

      <div id="plan"></div>
      <p id="planMsg" class="meta"></p>
    </section>

    <section class="section">
      <h2>Backup / Reset</h2>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <button class="btn-sm" id="btnExport">Export all workout data (.json)</button>
        <label class="btn-sm" for="importFile" style="cursor:pointer;display:inline-flex;align-items:center;justify-content:center">Import data</label>
        <input id="importFile" type="file" accept="application/json" style="display:none">
        <button class="btn-sm" id="btnReset">Reset (PBs + wellness only)</button>
      </div>
      <p class="meta">Roadmap is read from <code>localStorage["fff.roadmap.plan.v1"]</code>.</p>
    </section>

    <footer class="site-footer">
      <div class="container">
        <img src="img/freefitfuel-logo.svg" alt="FreeFitFuel Logo" height="64">
        <p>&copy; 2025 FreeFitFuel‚Ñ¢ ¬∑ All rights reserved.</p>
        <p class="credit">Created by Grant Cameron Anthony</p>
      </div>
    </footer>
  </div>

<script>
const ROADMAP_KEY   = 'fff.roadmap.plan.v1';
const NS_PB         = 'fff.workoutplan.pb.';
const NS_CHECK      = 'fff.workoutplan.check.';

/* Accordion all closed */
function setupAccordions(){
  document.querySelectorAll('.accordion').forEach(acc=>{
    const btn=acc.querySelector('.acc-toggle');
    const body=acc.querySelector('.acc-body');
    acc.classList.remove('open');btn.setAttribute('aria-expanded','false');body.hidden=true;
    btn.addEventListener('click',()=>{
      const isOpen=acc.classList.contains('open');
      acc.classList.toggle('open',!isOpen);
      btn.setAttribute('aria-expanded',!isOpen?'true':'false');
      body.hidden=isOpen;
    });
  });
}

function yt(q){return 'https://www.youtube.com/results?search_query='+encodeURIComponent(q+' form');}
function pick(arr){return arr[Math.floor(Math.random()*arr.length)];}
const QUOTES=["Small wins compound. Log the set, own the day.","Perfect form, steady breath, then add a little.","Consistency beats intensity when intensity is inconsistent.","One clean rep beats five messy ones.","Show up. Scale smart. Keep going."];

function restControlsHTML(id){
  return `<div class="restbar" data-rest="${id}" data-bound="0">
    <span>‚è± Rest:</span>
    <input type="number" min="5" step="5" value="90" aria-label="Rest seconds">
    <button class="btn-sm" data-act="rest-start">Start</button>
    <button class="btn-sm" data-act="rest-stop">Stop</button>
    <span class="left" aria-live="polite">90s</span>
  </div>`;
}

function hookRestTimers(scope){
  scope.querySelectorAll('.restbar').forEach(bar=>{
    if(bar.dataset.bound==='1')return;bar.dataset.bound='1';
    const input=bar.querySelector('input[type="number"]');
    const left=bar.querySelector('.left');
    const start=bar.querySelector('[data-act="rest-start"]');
    const stop=bar.querySelector('[data-act="rest-stop"]');
    let t=null;
    const fmt=s=>{s=Math.max(0,Math.floor(Number(s)||0));const m=Math.floor(s/60),r=s%60;return m?`${m}:${String(r).padStart(2,'0')}`:`${r}s`;};
    const show=s=>left.textContent=fmt(s);
    show(parseInt(input?.value||'0',10));
    start?.addEventListener('click',()=>{
      let total=Math.max(5,parseInt(input?.value||'0',10)||0);
      clearInterval(t);let remain=total;show(remain);
      t=setInterval(()=>{remain--;show(remain);if(remain<=0){clearInterval(t);left.textContent='Go!';}},1000);
    });
    stop?.addEventListener('click',()=>{clearInterval(t);show(parseInt(input?.value||'0',10));});
  });
}

/* ===== Dynamic Legend ===== */
const LEGEND_DEFS = {
  "Compound": "Big multi-joint lifts. Shown as an orange badge next to the exercise name.",
  "Accessory": "Support/isolation work to build weak links or volume.",
  "RIR": "Reps In Reserve ‚Äî how many reps you could still do at the end of a set (e.g., 2 RIR = stop two shy of failure).",
  "LISS": "Low-Intensity Steady State cardio (easy pace, conversational, longer duration).",
  "MISS": "Moderate-Intensity Steady State cardio (comfortably hard, steady).",
  "HIIT": "High-Intensity Interval Training ‚Äî short hard efforts with recovery intervals.",
  "AMRAP": "As Many Reps/Rounds As Possible within the target.",
  "EMOM": "Every Minute On the Minute ‚Äî start a set each minute.",
  "RPE": "Rate of Perceived Exertion (1‚Äì10 scale for effort).",
  "ROM": "Range of Motion ‚Äî how far a joint moves during the exercise.",
  "SS": "Superset ‚Äî perform two exercises back-to-back with minimal rest.",
  "Tempo": "Numbers like 3-1-3 indicate eccentric‚Äìpause‚Äìconcentric seconds for each rep."
};

function detectLegendTerms(data){
  const found = new Set();
  const pushIf = (term, cond)=>{ if(cond) found.add(term); };

  (data.stages||[]).forEach(stage=>{
    (stage.programByDay||[]).forEach(day=>{
      (day||[]).forEach(it=>{
        const name = String(it?.name||'');
        const cue  = String(it?.cue||'');
        const extras = [name, cue].join(' ').toUpperCase();

        // Badges (compound/accessory) ‚Äî only if present in any exercise
        if (it.type && it.type.toLowerCase() === 'compound') pushIf('Compound', true);
        if (it.type && it.type.toLowerCase() === 'accessory') pushIf('Accessory', true);

        // Common abbreviations
        ['LISS','MISS','HIIT','AMRAP','EMOM','RPE','ROM','SS'].forEach(t=>{
          if (extras.includes(t)) pushIf(t, true);
        });

        // RIR is in prescription for resistance
        if (it.rir != null && String(it.rir).trim() !== '') pushIf('RIR', true);

        // Tempo patterns like 3-1-3 / 4-0-1
        if (/\b\d-\d-\d\b/.test(name) || /\b\d-\d-\d\b/.test(cue)) pushIf('Tempo', true);
      });
    });
  });

  return Array.from(found);
}

function renderLegend(terms){
  const mount = document.getElementById('legendMount');
  if (!terms.length) { mount.innerHTML=''; return; }
  const rows = terms.map(t=>`
    <div class="row">
      <div class="term">${t}</div>
      <div class="def">${LEGEND_DEFS[t]}</div>
    </div>`).join('');
  mount.innerHTML = `
    <details class="legend" open>
      <summary>Legend & abbreviations</summary>
      ${rows}
    </details>`;
}

/* ===== Render Plan ===== */
function renderPlan(){
  const wrap=document.getElementById('plan');const msg=document.getElementById('planMsg');
  let raw=localStorage.getItem(ROADMAP_KEY);if(!raw){wrap.innerHTML=`<div class="warn">No roadmap found.</div>`;renderLegend([]);return;}
  let data;try{data=JSON.parse(raw);}catch{wrap.innerHTML=`<div class="warn">Unreadable roadmap.</div>`;renderLegend([]);return;}
  const stages=Array.isArray(data.stages)?data.stages:[]; if(!stages.length){wrap.innerHTML=`<div class="warn">Empty roadmap.</div>`;renderLegend([]);return;}

  // Build dynamic legend first
  const terms = detectLegendTerms(data);
  renderLegend(terms);

  let html='';stages.forEach((stage,si)=>{
    html+=`<div class="accordion">
      <div class="acc-head"><button class="acc-toggle" aria-expanded="false">${stage.name||`Stage ${si+1}`}</button></div>
      <div class="acc-body" hidden>
        ${stage.blurb?`<p class="meta">${stage.blurb}</p>`:''}
        <div class="days">`;

    const days = stage.split || ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    for(let di=0; di<7; di++){
      const label = days[di] || ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][di];
      const items = (stage.programByDay && stage.programByDay[di]) ? stage.programByDay[di] : [];
      html+=`<div class="mov"><div class="mov-head"><div class="mov-title"><strong>${label}</strong></div></div>`;

      (items||[]).forEach((it,ei)=>{
        const presc=(it.type==='cardio')
          ? [it.duration_min?`${it.duration_min} min`:null,it.work_s?`work ${it.work_s}s`:null,it.rest_s?`rest ${it.rest_s}s`:null,it.rounds?`${it.rounds} rounds`:null].filter(Boolean).join(' ¬∑ ')
          : `${it.sets||'‚Äî'}√ó${it.reps||'‚Äî'} ¬∑ ${it.rir||'‚Äî'} RIR ¬∑ ${it.rest||60}s rest`;

        html+=`<div class="mov" style="margin:.5rem 0 0">
          <div class="mov-head">
            <div class="mov-title">
              <a href="${yt(it.name||'exercise')}" target="_blank" rel="noopener">${it.name||'Exercise'}</a>
              ${it.type && it.type!=='cardio' ? `<span class="badge">${it.type}</span>`:''}
            </div>
            <div class="rx">${presc}</div>
            <div class="mov-tools"><button class="btn-sm" data-open>Log</button></div>
          </div>
          ${it.cue?`<p class="meta" style="margin:.3rem 0 0">${it.cue}</p>`:''}
          ${Array.isArray(it.alts)&&it.alts.length?`<div class="alt-chips">${it.alts.map(alt=>`<a class="alt-chip" href="${yt(alt)}" target="_blank" rel="noopener">${alt}</a>`).join('')}</div>`:''}
          <div class="drawer" data-drawer>
            <div class="log-grid" data-log>
              ${[1,2,3,4,5].map(i=>`
                <div class="log-row">
                  <strong>Set ${i}</strong>
                  <input inputmode="decimal" placeholder="kg"   data-field="w${i}">
                  <input inputmode="numeric" placeholder="reps" data-field="r${i}">
                  <input placeholder="notes" data-field="n${i}">
                  <button class="btn-sm" data-save>Save</button>
                </div>
                ${it.type==='cardio' ? '' : restControlsHTML('s'+si+'d'+di+'e'+ei+'.s'+i)}
              `).join('')}
            </div>
            <div class="meta-row">
              <span class="pb" data-pb></span>
              <span class="badge" data-badge></span>
            </div>
            <div class="quote" data-quote></div>
          </div>
        </div>`;
      });

      html+=`</div>`; // end day box
    }

    html+=`</div></div></div>`; // end days + acc-body + accordion
  });

  wrap.innerHTML=html;
  msg.textContent = `Loaded ${stages.length} stage${stages.length>1?'s':''} from local plan.`;

  setupAccordions();

  // Wire drawers + timers + PB save logic
  wrap.querySelectorAll('.mov .btn-sm[data-open]').forEach(btn=>{
    const drawer = btn.closest('.mov')?.querySelector('[data-drawer]');
    btn.addEventListener('click', ()=>{
      drawer?.classList.toggle('open');
      if(drawer?.classList.contains('open')) hookRestTimers(drawer);
    });
  });

  wrap.querySelectorAll('[data-drawer]').forEach(drawer=>{
    const logArea = drawer.querySelector('[data-log]');
    const pbEl    = drawer.querySelector('[data-pb]');
    const badgeEl = drawer.querySelector('[data-badge]');
    const quoteEl = drawer.querySelector('[data-quote]');

    function bestScore(obj){
      let best=0; for(let i=1;i<=5;i++){
        const w=parseFloat(obj['w'+i]||'0')||0, r=parseFloat(obj['r'+i]||'0')||0;
        best=Math.max(best, w*r);
      } return best;
    }
    function milestoneText(n){
      if(n>=200) return 'Milestone: 200 logs saved üî•';
      if(n>=100) return 'Milestone: 100 logs saved üéâ';
      if(n>=50)  return 'Milestone: 50 logs saved üí™';
      if(n>=25)  return 'Milestone: 25 logs saved üôå';
      if(n>=10)  return 'Milestone: 10 logs saved ‚úÖ';
      if(n>=5)   return 'Milestone: 5 logs saved ‚ú®';
      return '';
    }

    // derive key from first restbar in this drawer
    const anyRest = drawer.querySelector('[data-rest]');
    const baseKey = anyRest ? anyRest.dataset.rest.split('.s')[0] : Math.random().toString(36).slice(2);

    // populate existing
    (function populate(){
      const saved = JSON.parse(localStorage.getItem(NS_PB+baseKey)||'{}');
      logArea.querySelectorAll('[data-field]').forEach(inp=>{
        const id=inp.dataset.field; if(saved[id]) inp.value=saved[id];
      });
      const bestWas=parseFloat(localStorage.getItem(NS_PB+baseKey+'.best')||'0')||0;
      pbEl.textContent = bestWas>0 ? `PB score: ${bestWas.toFixed(1)} (w√ór best set)` : '';
      const total=parseInt(localStorage.getItem('fff.workoutplan.saves')||'0',10);
      badgeEl.textContent = milestoneText(total);
    })();

    // save handler
    logArea.querySelectorAll('[data-save]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const obj={}; logArea.querySelectorAll('[data-field]').forEach(inp=>{ obj[inp.dataset.field]=inp.value.trim(); });
        localStorage.setItem(NS_PB+baseKey, JSON.stringify(obj));
        const bestNow=bestScore(obj), bestWas=parseFloat(localStorage.getItem(NS_PB+baseKey+'.best')||'0')||0;
        if(bestNow>bestWas){ localStorage.setItem(NS_PB+baseKey+'.best', bestNow); pbEl.textContent=`New PB! ${bestNow.toFixed(1)} (best w√ór)`; }
        else{ pbEl.textContent = bestWas>0 ? `PB score: ${bestWas.toFixed(1)} (w√ór best set)` : 'Saved.'; }
        const total=(parseInt(localStorage.getItem('fff.workoutplan.saves')||'0',10)+1);
        localStorage.setItem('fff.workoutplan.saves', total);
        badgeEl.textContent = (total%5===0)?'Progress logged ‚úÖ': '';
        quoteEl.textContent = pick(QUOTES);
      });
    });
  });
}

/* Export / Import / Reset */
function exportAll(){
  const dump={};
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i); if(!k) continue;
    if(k.startsWith(NS_PB)||k.startsWith(NS_CHECK)||k===ROADMAP_KEY){
      dump[k]=localStorage.getItem(k);
    }
  }
  const blob=new Blob([JSON.stringify(dump,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='freefitfuel-workout-plan-backup.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importAll(file){
  const r=new FileReader();
  r.onload=()=>{ 
    try {
      const obj=JSON.parse(String(r.result||'{}'));
      Object.keys(obj).forEach(k=>localStorage.setItem(k,obj[k]));
      alert('Import complete. Reloading plan.');
      location.reload(); // ensure roadmap picked up
    } catch { alert('Import failed ‚Äî invalid file.'); } 
  };
  r.readAsText(file);
}
function resetPBsAndWellness(){
  const del=[]; for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i); if(!k) continue;
    if(k.startsWith(NS_PB)||k.startsWith(NS_CHECK)) del.push(k);
  }
  del.forEach(k=>localStorage.removeItem(k));
  alert('Cleared PBs & wellness toggles. Roadmap left intact.'); location.reload();
}
document.getElementById('btnExport')?.addEventListener('click', exportAll);
document.getElementById('importFile')?.addEventListener('change', e=>{const f=e.target.files?.[0];if(f) importAll(f);});
document.getElementById('btnReset')?.addEventListener('click', resetPBsAndWellness);

renderPlan();
</script>
</body>
</html>
